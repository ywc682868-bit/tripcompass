<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Compass</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trip Compass">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-size: 0.875rem;
            color: #5F6368;
            padding-bottom: 140px; 
        }
        #app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-top: 100px; /* ç•™å‡ºå›ºå®š Header çš„ç©ºé–“ */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(95, 99, 104, 0.4);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }

        /* 1. å›ºå®š Header */
        header {
            position: fixed; /* æ”¹ç‚º fixed */
            top: 0;
            width: 100%;
            max-width: 500px; /* ç¹¼æ‰¿ app-container å¯¬åº¦ */
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(5px);
            z-index: 40;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #header-content-wrapper {
             padding: 0.75rem 0.75rem 0.5rem 0.75rem; 
        }

        #combined-bottom-bar {
            position: fixed;
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            width: 95%; 
            max-width: 480px; 
            background-color: white; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 50;
            display: flex; 
            flex-direction: column; 
            padding: 0.75rem 0.75rem 0.5rem 0.75rem;
            border-radius: 24px;
            border: 1px solid #f0f0f0; 
        }

        /* R1: ç½®ä¸­åœ“å½¢æ–°å¢æŒ‰éˆ•çš„æ¨£å¼ - å°ºå¯¸å’Œæ¨£å¼å·²èª¿æ•´ */
        .prominent-integrated-btn {
            width: 36px; 
            height: 36px; 
            background-color: #7E92A1;
            border-radius: 50%;
            color: white;
            font-size: 20px; 
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none; 
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 0px; 
            border: none; 
            transition: transform 0.1s;
        }
        .prominent-integrated-btn:active { transform: scale(0.95); }


        .trip-card:last-child .timeline-connector { display: none; }
        .location-link { cursor: pointer; text-decoration: none; color: inherit; }
        .location-link:hover { color: #7E92A1; }
        
        #trip-select {
            font-size: 1.125rem; 
            font-weight: 800; color: #4A4B4D; 
            background-color: transparent;
            border: none; cursor: pointer; padding-right: 1.5rem; max-width: 100%;
            text-overflow: ellipsis; overflow: hidden; white-space: nowrap; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%237E92A1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right center; background-repeat: no-repeat; background-size: 1.25em 1.25em;
            margin-bottom: -4px; 
        }
        #trip-select:focus { outline: none; }

        .compact-input { padding: 0.2rem 0.3rem; font-size: 0.7rem; height: 26px; color: #5F6368; border-color: #E0E0E0; }
        .compact-input:focus { border-color: #7E92A1; outline: none; ring: 1px solid #7E92A1; }
        .compact-label { font-size: 0.7rem; margin-bottom: 0rem; color: #7E92A1; font-weight: 700; }

        input[type="time"], input[type="date"] { text-align: center; }
        
        .list-tab-active { border-bottom: 2px solid #7E92A1; color: #7E92A1; font-weight: bold; }
        .list-tab-inactive { color: #A9A9A9; }
        
        .shopping-img-box { width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; position: relative;}
        .shopping-img-box img { width: 100%; height: 100%; object-fit: cover; }

        .swipe-item-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            touch-action: pan-y; 
        }
        /* 4. è¡Œç¨‹å¡ç‰‡ æ»‘å‹•åˆªé™¤å€å¡Š */
        .swipe-item-delete-bg {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 140px; 
            background-color: transparent; 
            color: white;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 1;
        }
        .swipe-item-content {
            position: relative;
            z-index: 10;
            background-color: white;
            transition: transform 0.2s ease-out;
            transform: translateX(0);
        }
        
        /* 5. PC éš±è—æ»‘å‹•æŒ‰éˆ•ï¼Œä¸¦å¾©ä½å¡ç‰‡ */
        @media (min-width: 501px) {
            .swipe-item-delete-bg { display: none !important; }
            .swipe-item-content { transform: translateX(0) !important; }
            /* è®“æ•´å€‹å¡ç‰‡å¯é»æ“Š */
            .trip-card .swipe-item-content { cursor: pointer; } 
        }


        /* 3. èª¿æ•´åº•éƒ¨åŒ¯ç‡å€åŸŸé«˜åº¦ */
        #currency-display-row { padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
        #rate-display-container { height: 20px; }

        /* 1. å–®è¡ŒåŒ¯ç‡æ¨£å¼ */
        #rate-display-container {
            display: flex;
            align-items: center;
            /* 1. é å·¦å°é½Š */
            justify-content: flex-start; 
            height: 20px; 
            text-align: left;
            padding-left: 0.5rem; /* å¢åŠ å·¦å…§é‚Šè· */
        }

        /* R4: æ¸…å–®å…§çš„å°å‹ FAB æ¨£å¼ */
        .list-fab-small {
            position: absolute;
            bottom: 10px; 
            right: 10px; 
            width: 36px; 
            height: 36px; 
            background-color: #7E92A1;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 300;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 50;
            transition: transform 0.1s;
        }
        .list-fab-small:active { transform: scale(0.9); }

    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.App = (function() {
            const appId = 'my-trip-app';
            const firebaseConfig = {
              apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28",
              authDomain: "mytravelplanner-36283.firebaseapp.com",
              projectId: "mytravelplanner-36283",
              storageBucket: "mytravelplanner-36283.appspot.com",
              messagingSenderId: "86504733738",
              appId: "1:86504733738:web:5167a6a795eb2066f272d"
            };

            const COUNTRY_CONFIG = {
                'USA': { name: 'ç¾åœ‹', currency: 'USD', localName: 'New York', lat: 40.71, lon: -74.00, timezone: 'America/New_York', img: 'usa' },
                'JP': { name: 'æ—¥æœ¬', currency: 'JPY', localName: 'æ±äº¬', lat: 35.68, lon: 139.76, timezone: 'Asia/Tokyo', img: 'japan' },
                'KR': { name: 'éŸ“åœ‹', currency: 'KRW', localName: 'ì„œìš¸', lat: 37.56, lon: 126.97, timezone: 'Asia/Seoul', img: 'korea' },
                'UK': { name: 'è‹±åœ‹', currency: 'GBP', localName: 'London', lat: 51.50, lon: -0.12, timezone: 'Europe/London', img: 'london' },
                'TW': { name: 'å°ç£', currency: 'TWD', localName: 'å°åŒ—', lat: 25.03, lon: 121.56, timezone: 'Asia/Taipei', img: 'taiwan' } 
            };
            
            const CATEGORY_COLORS = {
                'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 
                'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 
                'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, 
                'äº¤é€š': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 
                'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' },
                'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' },
                'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } 
            };
            
            const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];
            const CATEGORY_NAMES = { 'location': 'æ™¯é»', 'restaurant': 'é¤å»³', 'coffee': 'å’–å•¡å»³', 'äº¤é€š': 'äº¤é€š', 'shopping': 'è³¼ç‰©', 'accommodation': 'ä½å®¿', 'default': 'æœªåˆ†é¡' };

            let db, auth;
            let currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {}, userLocation = null;
            let unsubscribeSchedule = null, unsubscribeTrips = null, unsubscribeLists = null, expenseChart = null, currentTripRate = 1;
            let currentLocationNameForWeather = 'å°åŒ—'; 
            let currentListTabId = null;

            // --- Utility Functions ---
            function formatDate(date) {
                const year = String(date.getFullYear()).slice(-2); 
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dayOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()]; 
                return `${year}.${month}.${day} (${dayOfWeek})`;
            }
            function dateDiffInDays(date2, date1) {
                const timeDiff = Math.abs(date2.getTime() - date1.getTime());
                return Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            }
            function getTodayDateString() {
                const today = new Date();
                return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            }
            function getDateFromDayId(trip, dayId) {
                if (!trip || !trip.startDate) return null;
                const startDate = new Date(trip.startDate);
                const dayIndex = parseInt(dayId.replace('Day ', '')) - 1;
                const targetDate = new Date(startDate);
                targetDate.setDate(startDate.getDate() + dayIndex);
                return targetDate;
            }
            function getCardStyle(type) {
                const config = CATEGORY_COLORS[type] || CATEGORY_COLORS['default'];
                let icon = 'â“';
                if(type === 'coffee') icon = 'â˜•';
                else if(type === 'restaurant') icon = 'ğŸ½ï¸';
                else if(type === 'location') icon = 'ğŸ“';
                else if(type === 'äº¤é€š') icon = 'ğŸš—';
                else if(type === 'shopping') icon = 'ğŸ›ï¸';
                else if(type === 'accommodation') icon = 'ğŸ›ï¸';
                return { color: config.bg, icon, hex: config.hex, text: config.text };
            }
            function navigateToMap(input) {
                if (!input) return;
                if (input.includes('http') || input.includes('goo.gl') || input.includes('maps.')) { window.open(input, '_blank'); return; }
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(input)}`, '_blank');
            }
            
            // --- Currency & Weather ---
            async function fetchExchangeRate(baseCurrency) {
                const fallback = { 'USD': 32.5, 'JPY': 0.215, 'KRW': 0.023, 'GBP': 41.2, 'CNY': 4.5, 'TWD': 1 };
                if (!baseCurrency || baseCurrency === 'TWD') return 1;
                try {
                    const response = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency}`);
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    if (data && data.rates && data.rates.TWD) return data.rates.TWD;
                } catch (e) { console.log("åŒ¯ç‡æŠ“å–å¤±æ•—", e); }
                return fallback[baseCurrency] || 1;
            }
            function getUserPosition() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) { reject('Geolocation not supported'); } else { navigator.geolocation.getCurrentPosition(resolve, reject); }
                });
            }
            function openWeather() {
                if (currentLocationNameForWeather) { window.open(`https://www.google.com/search?q=${encodeURIComponent(currentLocationNameForWeather + ' å¤©æ°£')}`, '_blank'); }
            }
            async function updateHeaderInfo() {
                const trip = tripData[currentTripId];
                if (!trip) return;
                let targetConfig = null;
                try {
                    if (!userLocation) {
                        const position = await getUserPosition();
                        const lat = position.coords.latitude; const lon = position.coords.longitude;
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const geoData = await geoRes.json();
                        const city = geoData.address.city || geoData.address.town || geoData.address.district || 'Current Location';
                        userLocation = { localName: city, lat: lat, lon: lon };
                    }
                    if (userLocation) targetConfig = userLocation;
                } catch (error) { console.log("å®šä½å¤±æ•—", error); }

                if (!targetConfig) {
                    const countryCode = trip.country || 'TW';
                    targetConfig = COUNTRY_CONFIG[countryCode] || COUNTRY_CONFIG['TW'];
                }
                document.getElementById('header-location-name').textContent = targetConfig.localName;
                currentLocationNameForWeather = targetConfig.localName;

                const countryCode = trip.country || 'TW';
                const currencyConfig = COUNTRY_CONFIG[countryCode] || COUNTRY_CONFIG['TW'];
                currentTripRate = await fetchExchangeRate(currencyConfig.currency);
                
                const barSelect = document.getElementById('bar-calc-currency');
                if(barSelect) { 
                    barSelect.value = currencyConfig.currency; 
                    document.getElementById('bar-calc-amount').value = 1; 
                    calculateCurrency(); 
                }

                const members = trip.members || [];
                const memberContainer = document.getElementById('header-members-list');
                if (members.length > 0) {
                    memberContainer.innerHTML = members.map((m, i) => {
                        const colorClass = MEMBER_COLORS[i % MEMBER_COLORS.length];
                        return `<span class="${colorClass} mr-1">${m}</span>`;
                    }).join('');
                } else { memberContainer.textContent = 'å°šæœªè¨­å®š'; }

                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${targetConfig.lat}&longitude=${targetConfig.lon}&current=temperature_2m,weather_code&timezone=auto`);
                    const data = await res.json();
                    let weatherIcon = 'â˜€ï¸';
                    if (data.current.weather_code > 3) weatherIcon = 'â˜ï¸';
                    if (data.current.weather_code > 50) weatherIcon = 'ğŸŒ§ï¸';
                    document.getElementById('header-weather-icon').textContent = weatherIcon;
                    document.getElementById('header-weather-temp').textContent = `${data.current.temperature_2m}Â°C`;
                } catch (e) {}
            }

            // --- Trip Cards ---
            function createTripCard(schedule) {
                const style = getCardStyle(schedule.Type);
                const config = CATEGORY_COLORS[schedule.Type] || CATEGORY_COLORS['default'];
                const amount = schedule.Amount || 0;
                const members = schedule.members || [];
                const splitCount = members.length > 0 ? members.length : 1;
                const perPerson = splitCount > 0 ? (amount / splitCount).toFixed(0) : amount;
                const displayName = CATEGORY_NAMES[schedule.Type] || schedule.Type;
                const scheduleJsonString = JSON.stringify({
                    id: schedule.id, Date: schedule.Date, Time: schedule.Time, Location: schedule.Location,
                    Type: schedule.Type, èªªæ˜: schedule.èªªæ˜, Address: schedule.Address, Amount: amount, Rate: schedule.Rate, members: members
                });
                
                let memberHtml = '';
                if (members && members.length > 0) {
                    memberHtml = members.map((m, i) => {
                        const name = typeof m === 'string' ? m : m.name;
                        const colorClass = MEMBER_COLORS[i % MEMBER_COLORS.length]; 
                        return `<span class="${colorClass} text-[9px] font-bold mr-1">${name}</span>`;
                    }).join('');
                }

                const card = document.createElement('div');
                card.className = 'trip-card flex w-full mb-3 relative min-h-[90px]';
                
                // 4. & 5. æ»‘å‹•æ“ä½œå€åŸŸ (åŒ…å«ä¿®æ”¹å’Œåˆªé™¤æŒ‰éˆ•)
                const swipeActions = document.createElement('div');
                swipeActions.className = 'swipe-item-delete-bg';
                swipeActions.innerHTML = `
                    <button class="px-2 py-1 h-full text-xs font-bold bg-[#7E92A1] hover:bg-[#64748B] transition-colors" data-action="modify" data-schedule='${scheduleJsonString}' style="width: 70px;">ä¿®æ”¹</button>
                    <button class="px-2 py-1 h-full text-xs font-bold bg-[#CB8572] hover:bg-[#B56B5A] transition-colors" data-action="delete" data-id="${schedule.id}" style="width: 70px;">åˆªé™¤</button>
                `;
                card.appendChild(swipeActions);


                const content = document.createElement('div');
                content.className = 'swipe-item-content flex w-full rounded-xl shadow-lg bg-white overflow-visible relative items-stretch h-full z-10';
                
                content.innerHTML = `
                        <div class="${config.bg} w-14 flex-none flex flex-col items-center justify-start gap-2 text-white rounded-l-xl relative z-10 h-full py-2.5">
                             <span class="text-[10px] font-bold tracking-tight leading-none">${schedule.Time}</span>
                             <span class="text-2xl leading-none mb-1">${style.icon}</span>
                             <span class="text-[9px] font-medium opacity-90 leading-none">${displayName}</span>
                        </div>
                        <div class="flex-grow py-0.36 pl-1.5 pr-2 flex flex-row items-stretch relative rounded-r-xl bg-white z-10 h-full">
                            <div class="flex-grow flex flex-col justify-start min-w-0 pr-2 mt-3.5">
                                <h3 class="text-xs font-bold text-[#4A4B4D] leading-tight mb-0.5">
                                    <a href="#" class="location-link map-link hover:underline">${schedule.Location}</a>
                                </h3>
                                <p class="text-[#888888] text-[10px] line-clamp-4 whitespace-pre-wrap leading-tight">${schedule.èªªæ˜ || ''}</p>
                            </div>
                            <div class="flex flex-col items-center justify-center min-w-[70px] border-l border-gray-100 pl-1 pb-1 flex-shrink-0">
                                <div class="flex flex-col items-start gap-2 mt-2 w-full">
                                    <div class="flex items-center justify-start leading-none w-full"><span class="text-[#8F9E8B] font-bold text-[10px]">ğŸ’° ${amount > 0 ? amount : 0}</span></div>
                                    <div class="flex items-center justify-start leading-none w-full"><span class="text-[#888888] font-bold text-[10px]">ğŸ‘« ${amount > 0 ? perPerson : 0}</span></div>
                                    <div class="flex flex-wrap items-center justify-start max-w-[70px] leading-tight gap-0.5 mt-0.5 min-h-[12px]">${memberHtml}</div>
                                </div>
                            </div>
                        </div>
                    `;
                card.appendChild(content);

                card.querySelector('.map-link').addEventListener('click', (e) => { e.preventDefault(); navigateToMap(schedule.Address || schedule.Location); });
                
                // 5. PC æ¨¡å¼ä¸‹ï¼Œé»æ“Šå¡ç‰‡ä»»ä½•åœ°æ–¹éƒ½è§¸ç™¼ç·¨è¼¯
                content.addEventListener('click', (e) => {
                    // é˜»æ­¢é»æ“Šåœ°åœ–é€£çµæ™‚ä¹Ÿæ‰“é–‹ç·¨è¼¯è¦–çª—
                    if (e.target.classList.contains('map-link')) return; 
                    // æª¢æŸ¥æ˜¯å¦ç‚º PC æ¨¡å¼ (ç°¡æ˜“åˆ¤æ–·ï¼Œå‡è¨­ max-width 500px æ˜¯æ‰‹æ©Ÿ)
                    if (window.innerWidth > 500) { 
                        openEditScheduleModal(scheduleJsonString);
                    }
                });


                // 4. å•Ÿç”¨æ»‘å‹•æ“ä½œ
                enableSwipeToDelete(content, swipeActions, 'schedule'); 
                
                return card;
            }

            const loadSchedules = function(tripId, dayId) {
                if (unsubscribeSchedule) unsubscribeSchedule();
                document.getElementById('schedule-list-container').innerHTML = '<div class="p-4 text-center text-[#A9A9A9] text-xs">è¼‰å…¥ä¸­...</div>';
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Schedules`), where('dayId', '==', dayId));
                unsubscribeSchedule = onSnapshot(q, (snapshot) => {
                    const container = document.getElementById('schedule-list-container');
                    container.innerHTML = ''; 
                    const schedules = [];
                    const trip = tripData[currentTripId];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (trip && trip.startDate) {
                             const startDate = new Date(trip.startDate);
                             const dayIndex = parseInt(data.dayId.replace('Day ', '')) - 1;
                             const sDate = new Date(startDate);
                             sDate.setDate(startDate.getDate() + dayIndex);
                             data.Date = sDate.toISOString().split('T')[0];
                        }
                        schedules.push({ id: doc.id, ...data });
                    });
                    schedules.sort((a, b) => a.Time.localeCompare(b.Time));
                    if (schedules.length === 0) container.innerHTML = `<div class="p-4 text-center text-[#A9A9A9] text-xs">æ­¤æ—¥æš«ç„¡è¡Œç¨‹ã€‚</div>`;
                    schedules.forEach(s => container.appendChild(createTripCard(s)));
                });
            };

            const loadTripList = async function() {
                if (unsubscribeTrips) unsubscribeTrips();
                const tripsRef = collection(db, `artifacts/${appId}/public/data/Trips`);
                unsubscribeTrips = onSnapshot(tripsRef, (snapshot) => {
                    const select = document.getElementById('trip-select');
                    const previousVal = currentTripId;
                    select.innerHTML = ''; tripData = {};
                    if (snapshot.empty) {
                        document.getElementById('settings-btn').style.display = 'none';
                        document.getElementById('new-trip-btn').style.display = 'inline-flex';
                        select.style.display = 'none'; currentTripId = '';
                        document.getElementById('schedule-list-container').innerHTML = '';
                        return;
                    }
                    select.style.display = 'block';
                    document.getElementById('settings-btn').style.display = 'inline-flex';
                    document.getElementById('new-trip-btn').style.display = 'none';
                    let foundPrevious = false;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        tripData[doc.id] = { id: doc.id, ...data };
                        const option = document.createElement('option');
                        option.value = doc.id; option.textContent = data.name || 'æœªå‘½åè¨ˆç•«';
                        select.appendChild(option);
                        if (doc.id === previousVal) foundPrevious = true;
                    });
                    if (!currentTripId || (!foundPrevious && previousVal)) { currentTripId = Object.keys(tripData)[0]; }
                    select.value = currentTripId;
                    changeTrip(currentTripId);
                });
            };

            // 2. æ–°å¢å¤©æ•¸åŠŸèƒ½
            const addDay = async function() {
                if (!currentTripId) return;
                const trip = tripData[currentTripId];
                const newNumDays = (trip.numDays || 1) + 1;
                await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`), {
                    numDays: newNumDays
                }, { merge: true });
            }

            function changeTrip(tripId) {
                currentTripId = tripId;
                updateHeaderInfo();
                renderDayTabs();
                loadSchedules(currentTripId, currentDayId);
                checkAndCreateDefaultLists(tripId);
            }

            function renderDayTabs() {
                const daysContainer = document.getElementById('day-tabs-container');
                daysContainer.innerHTML = '';
                const trip = tripData[currentTripId];
                if (!trip || !trip.startDate) return;
                const numDays = trip.numDays || 1;
                let currentDateTitle = ''; 
                for (let i = 0; i < numDays; i++) {
                    const dayId = `Day ${i + 1}`;
                    const currentDay = getDateFromDayId(trip, dayId);
                    const isSelected = dayId === currentDayId;
                    const tabClass = isSelected ? 'bg-[#5F6368] text-white shadow-md' : 'bg-[#E4E6E8] text-[#5F6368] hover:bg-[#D1D5DB]';
                    const tab = document.createElement('button');
                    tab.className = `px-3 py-1.5 text-xs font-bold rounded-lg transition duration-150 ${tabClass} flex-shrink-0`;
                    tab.textContent = dayId;
                    tab.addEventListener('click', () => { currentDayId = dayId; renderDayTabs(); loadSchedules(currentTripId, currentDayId); });
                    daysContainer.appendChild(tab);
                    if (isSelected) currentDateTitle = formatDate(currentDay);
                }
                const addDayBtn = document.createElement('button');
                addDayBtn.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-[#7E92A1] text-white hover:bg-[#64748B] flex-shrink-0 ml-2';
                addDayBtn.textContent = '+';
                addDayBtn.addEventListener('click', addDay); 
                daysContainer.appendChild(addDayBtn);
                document.getElementById('schedule-list-date-header').className = "text-sm font-bold text-[#4A4B4D] mb-1";
                document.getElementById('schedule-list-date-header').textContent = currentDateTitle;
            }

            // --- Currency Logic ---
            async function calculateCurrency() {
                const currencyCode = document.getElementById('bar-calc-currency').value;
                const amount = parseFloat(document.getElementById('bar-calc-amount').value) || 0;
                // rate æ˜¯: 1 å¤–å¹£ = N TWD (å¾ API æŠ“å–çš„åŒ¯ç‡ï¼Œæˆ– fallback å€¼)
                const rate = await fetchExchangeRate(currencyCode);
                
                // 1. è¨ˆç®— 1 TWD = å¤šå°‘å¤–å¹£ (å³ 1 / rate)
                const twdToForeignRate = rate > 0 ? (1 / rate) : 0; 
                let displayRate = twdToForeignRate.toFixed(2);
                
                // æ›´æ–°å·¦æ¬„çš„åŒ¯ç‡é¡¯ç¤ºç‚ºå–®è¡Œæ ¼å¼: ä»Šæ—¥åŒ¯ç‡ï¼š1 TWD = N KRW
                const rateDisplayLabel = document.getElementById('rate-display-label');
                if (rateDisplayLabel) {
                    rateDisplayLabel.textContent = `ä»Šæ—¥åŒ¯ç‡ï¼š1 TWD = ${currencyCode} ${displayRate}`;
                }

                if (amount === 0) { 
                    document.getElementById('bar-calc-result').value = '0'; 
                    return; 
                }
                // åŒ¯ç‡æ›ç®— (å¤–å¹£ * åŒ¯ç‡ = TWD) ä¿æŒä¸è®Š
                document.getElementById('bar-calc-result').value = (amount * rate).toFixed(0); 
            }
            function updateTwdPreview(amount) {
                const val = parseFloat(amount);
                if (isNaN(val)) { document.getElementById('form-amount-twd').value = ''; return; }
                document.getElementById('form-amount-twd').value = (val * currentTripRate).toFixed(0);
            }
            function updateForeignPreview(twdAmount) {
                const val = parseFloat(twdAmount);
                if (isNaN(val)) { document.getElementById('form-amount').value = ''; return; }
                const rate = currentTripRate || 1;
                document.getElementById('form-amount').value = (val / rate).toFixed(2);
            }

            // --- Schedule CRUD ---
            function deleteSchedule(id) {
                if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                    deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`, id));
                }
            }
            
            // 4. è¼”åŠ©å‡½å¼ï¼šå•Ÿç”¨æ»‘å‹•æ“ä½œ
            function enableSwipeToDelete(contentEl, actionEl, type) {
                let startX = 0;
                let currentTranslate = 0;
                let isSwiping = false;
                const threshold = 70; 
                const maxSlide = 140; 
                const isMobile = window.innerWidth <= 500;
                if (!isMobile) return; // PC æ¨¡å¼ä¸å•Ÿç”¨æ»‘å‹•

                contentEl.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isSwiping = false;
                    // Reset others
                    document.querySelectorAll('.swipe-item-content').forEach(el => {
                        if(el !== contentEl) el.style.transform = 'translateX(0)';
                    });
                }, {passive: true});

                contentEl.addEventListener('touchmove', (e) => {
                    const currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    // åªå…è¨±å‘å·¦æ»‘
                    if (diff < 0) {
                        isSwiping = true;
                        currentTranslate = Math.max(diff, -maxSlide); 
                        contentEl.style.transform = `translateX(${currentTranslate}px)`;
                    } else if(currentTranslate < 0) {
                        // Allow to close by sliding right
                        currentTranslate = Math.min(diff - maxSlide, 0);
                        contentEl.style.transform = `translateX(${currentTranslate}px)`;
                    }
                }, {passive: true});

                contentEl.addEventListener('touchend', (e) => {
                    if (isSwiping) {
                        if (currentTranslate < -threshold) {
                            contentEl.style.transform = `translateX(-${maxSlide}px)`; // Keep open
                        } else {
                            contentEl.style.transform = `translateX(0)`; // Close
                        }
                    }
                    currentTranslate = 0;
                    isSwiping = false;
                });
                
                // è™•ç†é»æ“Šæ»‘å‹•å€åŸŸæŒ‰éˆ•çš„äº‹ä»¶
                actionEl.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = button.getAttribute('data-action');
                        if (type === 'schedule') {
                            const scheduleJson = JSON.parse(button.closest('.swipe-item-delete-bg').querySelector('[data-action="modify"]').getAttribute('data-schedule'));
                            if (action === 'modify') {
                                openEditScheduleModal(JSON.stringify(scheduleJson));
                            } else if (action === 'delete') {
                                deleteSchedule(scheduleJson.id);
                            }
                        } else if (type === 'list') {
                            const wrapper = button.closest('.swipe-item-container');
                            const listData = tripData[currentTripId].lists.find(l => l.id === currentListTabId); 
                            const index = parseInt(wrapper.getAttribute('data-index'));
                            if (action === 'delete') {
                                deleteListItem(listData, index);
                            } else if (action === 'modify') {
                                alert("è«‹ç›´æ¥é»æ“Šè¼¸å…¥æ¡†é€²è¡Œä¿®æ”¹ã€‚");
                            }
                        }
                        contentEl.style.transform = `translateX(0)`;
                    });
                });
            }


            function openEditScheduleModal(json) {
                const s = JSON.parse(json);
                editingScheduleId = s.id;
                document.getElementById('add-schedule-modal-title').textContent = s.Location; 
                document.getElementById('modal-save-btn').textContent = 'å„²å­˜';
                const deleteBtn = document.getElementById('modal-delete-btn');
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = () => deleteSchedule(s.id);
                document.getElementById('form-date').value = s.Date; document.getElementById('form-time').value = s.Time;
                document.getElementById('form-location').value = s.Location; document.getElementById('form-type').value = s.Type;
                document.getElementById('form-details').value = s.èªªæ˜; document.getElementById('form-address').value = s.Address;
                document.getElementById('form-amount').value = s.Amount || 0;
                const trip = tripData[currentTripId];
                document.getElementById('form-currency-label').textContent = trip.currency || 'TWD';
                updateTwdPreview(s.Amount || 0);
                const container = document.getElementById('form-members-container'); container.innerHTML = '';
                const members = s.members || [];
                if (members.length > 0) members.forEach(m => addMemberInput(typeof m === 'string' ? m : m.name, typeof m === 'string' ? '' : m.amount));
                else { addMemberInput('',''); addMemberInput('',''); }
                document.getElementById('add-schedule-modal').style.display = 'flex';
            }
            function showAddScheduleModal() {
                if (!currentTripId) { alert("è«‹å…ˆé¸æ“‡è¨ˆç•«"); return; }
                document.getElementById('add-schedule-form').reset(); editingScheduleId = null;
                document.getElementById('modal-delete-btn').style.display = 'none';
                const container = document.getElementById('form-members-container'); container.innerHTML = '';
                const trip = tripData[currentTripId];
                document.getElementById('form-date').min = trip.startDate;
                document.getElementById('form-date').value = getDateFromDayId(trip, currentDayId).toISOString().split('T')[0];
                document.getElementById('form-time').value = new Date().toTimeString().substring(0, 5);
                document.getElementById('form-currency-label').textContent = trip.currency || 'TWD';
                document.getElementById('add-schedule-modal-title').textContent = 'æ–°å¢è¡Œç¨‹';
                const defMembers = trip.members || [];
                if (defMembers.length > 0) defMembers.forEach(n => addMemberInput(n, ''));
                else { addMemberInput('',''); addMemberInput('',''); }
                document.getElementById('add-schedule-modal').style.display = 'flex';
            }
            function showSettingsModal() {
                const t = tripData[currentTripId];
                document.getElementById('settings-trip-name').value = t.name;
                document.getElementById('settings-trip-country').value = t.country || 'TW'; 
                document.getElementById('settings-start-date').value = t.startDate || getTodayDateString();
                document.getElementById('settings-num-days').value = t.numDays || 1;
                const c = document.getElementById('settings-members-container'); c.innerHTML = '';
                (t.members || []).forEach(n => addTripMemberInput(n));
                if (!(t.members || []).length) { addTripMemberInput(''); addTripMemberInput(''); }
                document.getElementById('settings-modal').style.display = 'flex';
            }
            function addMemberInput(name='', amt='') {
                const d = document.createElement('div'); d.className = 'flex items-center space-x-2 mt-1.5';
                d.innerHTML = `<input type="text" name="schedule-member-name" value="${name}" placeholder="åå­—" class="compact-input w-16 rounded-md border border-[#E0E0E0]"><input type="number" name="schedule-member-amount" value="${amt}" placeholder="é‡‘é¡" class="compact-input w-16 rounded-md border border-[#E0E0E0]"><button type="button" class="text-[#CB8572] font-bold p-1 rm-btn">Ã—</button>`;
                d.querySelector('.rm-btn').onclick = () => d.remove();
                document.getElementById('form-members-container').appendChild(d);
            }
            function addTripMemberInput(name='') {
                const d = document.createElement('div'); d.className = 'flex items-center space-x-2 mt-1.5';
                d.innerHTML = `<input type="text" name="trip-member-name" value="${name}" placeholder="æˆå“¡åå­—" class="flex-1 rounded-md border border-[#E0E0E0] p-2 border compact-input"><button type="button" class="text-[#CB8572] font-bold p-1 rm-btn">Ã—</button>`;
                d.querySelector('.rm-btn').onclick = () => d.remove();
                document.getElementById('settings-members-container').appendChild(d);
            }
            async function submitSchedule() {
                const form = document.getElementById('add-schedule-form');
                const dateVal = form['form-date'].value;
                if (!dateVal) return alert("è«‹é¸æ—¥æœŸ");
                const trip = tripData[currentTripId];
                const dayId = `Day ${dateDiffInDays(new Date(dateVal), new Date(trip.startDate)) + 1}`;
                const members = [];
                const names = document.querySelectorAll('input[name="schedule-member-name"]');
                const amts = document.querySelectorAll('input[name="schedule-member-amount"]');
                names.forEach((n, i) => { if(n.value.trim()) members.push({name: n.value.trim(), amount: amts[i].value ? parseFloat(amts[i].value) : null}); });
                const data = {
                    dayId, Time: form['form-time'].value, Location: form['form-location'].value,
                    Type: form['form-type'].value, èªªæ˜: form['form-details'].value, Address: form['form-address'].value,
                    Amount: parseFloat(form['form-amount'].value) || 0, Rate: currentTripRate || 1, members
                };
                const col = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`);
                if (editingScheduleId) await updateDoc(doc(col, editingScheduleId), data);
                else await addDoc(col, data);
                document.getElementById('add-schedule-modal').style.display = 'none';
                currentDayId = dayId; renderDayTabs(); loadSchedules(currentTripId, currentDayId);
            }

            // --- Lists Feature ---
            async function checkAndCreateDefaultLists(tripId) {
                const listCol = collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Lists`);
                const snapshot = await getDocs(listCol);
                if (snapshot.empty) {
                    await addDoc(listCol, { name: 'ç‰©å“', type: 'check', order: 1, items: [] });
                    await addDoc(listCol, { name: 'è³¼ç‰©', type: 'shopping', order: 2, items: [] });
                }
            }

            function loadLists() {
                if (!currentTripId) return alert("è«‹å…ˆé¸æ“‡è¨ˆç•«");
                document.getElementById('lists-modal').style.display = 'flex';
                if (unsubscribeLists) unsubscribeLists();
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), orderBy('order'));
                unsubscribeLists = onSnapshot(q, (snapshot) => {
                    const tabsContainer = document.getElementById('list-tabs');
                    const contentContainer = document.getElementById('list-content');
                    tabsContainer.innerHTML = '';
                    
                    let lists = [];
                    snapshot.forEach(doc => lists.push({ id: doc.id, ...doc.data() }));
                    // ç‚ºäº† List Swipe é‚è¼¯èƒ½å­˜å–ï¼Œå°‡ List Data æš«å­˜åˆ° tripData
                    if (tripData[currentTripId]) tripData[currentTripId].lists = lists;

                    if (lists.length === 0) {
                        contentContainer.innerHTML = '<div class="p-4 text-center text-[#A9A9A9] text-xs">è«‹æ–°å¢æ¸…å–®</div>';
                        return;
                    }
                    if (!currentListTabId || !lists.find(l => l.id === currentListTabId)) currentListTabId = lists[0].id;

                    lists.forEach(l => {
                        const tab = document.createElement('div');
                        const isActive = l.id === currentListTabId;
                        tab.className = `cursor-pointer px-3 py-1 text-sm ${isActive ? 'list-tab-active' : 'list-tab-inactive'}`;
                        tab.textContent = l.name;
                        tab.onclick = () => { currentListTabId = l.id; loadLists(); };
                        tabsContainer.appendChild(tab);
                    });

                    // Add Tab (+)
                    const addTab = document.createElement('div');
                    addTab.className = 'cursor-pointer px-3 py-1 text-sm text-[#A9A9A9] font-bold';
                    addTab.textContent = '+';
                    addTab.onclick = async () => {
                        const name = prompt("è¼¸å…¥æ–°æ¸…å–®åç¨±ï¼š");
                        if (name) {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), {
                                name, type: 'check', order: lists.length + 1, items: []
                            });
                        }
                    };
                    tabsContainer.appendChild(addTab);

                    // Render Content
                    const activeList = lists.find(l => l.id === currentListTabId);
                    contentContainer.innerHTML = '';
                    if (activeList) {
                        renderListItems(activeList, contentContainer);
                    }
                });
            }

            // 4. è¼”åŠ©å‡½å¼ï¼šå•Ÿç”¨æ»‘å‹•æ“ä½œ
            function enableSwipeToDelete(contentEl, actionEl, type) {
                let startX = 0;
                let currentTranslate = 0;
                let isSwiping = false;
                const threshold = 70; 
                const maxSlide = 140; 
                const isMobile = window.innerWidth <= 500;
                if (!isMobile) return; 

                contentEl.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isSwiping = false;
                    // Reset others
                    document.querySelectorAll('.swipe-item-content').forEach(el => {
                        if(el !== contentEl) el.style.transform = 'translateX(0)';
                    });
                }, {passive: true});

                contentEl.addEventListener('touchmove', (e) => {
                    const currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    // åªå…è¨±å‘å·¦æ»‘
                    if (diff < 0) {
                        isSwiping = true;
                        currentTranslate = Math.max(diff, -maxSlide); 
                        contentEl.style.transform = `translateX(${currentTranslate}px)`;
                    } else if(currentTranslate < 0) {
                        // Allow to close by sliding right
                        currentTranslate = Math.min(diff - maxSlide, 0);
                        contentEl.style.transform = `translateX(${currentTranslate}px)`;
                    }
                }, {passive: true});

                contentEl.addEventListener('touchend', (e) => {
                    if (isSwiping) {
                        if (currentTranslate < -threshold) {
                            contentEl.style.transform = `translateX(-${maxSlide}px)`; // Keep open
                        } else {
                            contentEl.style.transform = `translateX(0)`; // Close
                        }
                    }
                    currentTranslate = 0;
                    isSwiping = false;
                });
                
                // è™•ç†é»æ“Šæ»‘å‹•å€åŸŸæŒ‰éˆ•çš„äº‹ä»¶
                actionEl.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = button.getAttribute('data-action');
                        if (type === 'schedule') {
                            const scheduleJson = JSON.parse(button.closest('.swipe-item-delete-bg').querySelector('[data-action="modify"]').getAttribute('data-schedule'));
                            if (action === 'modify') {
                                openEditScheduleModal(JSON.stringify(scheduleJson));
                            } else if (action === 'delete') {
                                deleteSchedule(scheduleJson.id);
                            }
                        } else if (type === 'list') {
                            const wrapper = button.closest('.swipe-item-container');
                            const listData = tripData[currentTripId].lists.find(l => l.id === currentListTabId); 
                            const index = parseInt(wrapper.getAttribute('data-index'));
                            if (action === 'delete') {
                                deleteListItem(listData, index);
                            } else if (action === 'modify') {
                                alert("è«‹ç›´æ¥é»æ“Šè¼¸å…¥æ¡†é€²è¡Œä¿®æ”¹ã€‚");
                            }
                        }
                        contentEl.style.transform = `translateX(0)`;
                    });
                });
            }


            function openEditScheduleModal(json) {
                const s = JSON.parse(json);
                editingScheduleId = s.id;
                document.getElementById('add-schedule-modal-title').textContent = s.Location; 
                document.getElementById('modal-save-btn').textContent = 'å„²å­˜';
                const deleteBtn = document.getElementById('modal-delete-btn');
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = () => deleteSchedule(s.id);
                document.getElementById('form-date').value = s.Date; document.getElementById('form-time').value = s.Time;
                document.getElementById('form-location').value = s.Location; document.getElementById('form-type').value = s.Type;
                document.getElementById('form-details').value = s.èªªæ˜; document.getElementById('form-address').value = s.Address;
                document.getElementById('form-amount').value = s.Amount || 0;
                const trip = tripData[currentTripId];
                document.getElementById('form-currency-label').textContent = trip.currency || 'TWD';
                updateTwdPreview(s.Amount || 0);
                const container = document.getElementById('form-members-container'); container.innerHTML = '';
                const members = s.members || [];
                if (members.length > 0) members.forEach(m => addMemberInput(typeof m === 'string' ? m : m.name, typeof m === 'string' ? '' : m.amount));
                else { addMemberInput('',''); addMemberInput('',''); }
                document.getElementById('add-schedule-modal').style.display = 'flex';
            }
            function showAddScheduleModal() {
                if (!currentTripId) { alert("è«‹å…ˆé¸æ“‡è¨ˆç•«"); return; }
                document.getElementById('add-schedule-form').reset(); editingScheduleId = null;
                document.getElementById('modal-delete-btn').style.display = 'none';
                const container = document.getElementById('form-members-container'); container.innerHTML = '';
                const trip = tripData[currentTripId];
                document.getElementById('form-date').min = trip.startDate;
                document.getElementById('form-date').value = getDateFromDayId(trip, currentDayId).toISOString().split('T')[0];
                document.getElementById('form-time').value = new Date().toTimeString().substring(0, 5);
                document.getElementById('form-currency-label').textContent = trip.currency || 'TWD';
                document.getElementById('add-schedule-modal-title').textContent = 'æ–°å¢è¡Œç¨‹';
                const defMembers = trip.members || [];
                if (defMembers.length > 0) defMembers.forEach(n => addMemberInput(n, ''));
                else { addMemberInput('',''); addMemberInput('',''); }
                document.getElementById('add-schedule-modal').style.display = 'flex';
            }
            function showSettingsModal() {
                const t = tripData[currentTripId];
                document.getElementById('settings-trip-name').value = t.name;
                document.getElementById('settings-trip-country').value = t.country || 'TW'; 
                document.getElementById('settings-start-date').value = t.startDate || getTodayDateString();
                document.getElementById('settings-num-days').value = t.numDays || 1;
                const c = document.getElementById('settings-members-container'); c.innerHTML = '';
                (t.members || []).forEach(n => addTripMemberInput(n));
                if (!(t.members || []).length) { addTripMemberInput(''); addTripMemberInput(''); }
                document.getElementById('settings-modal').style.display = 'flex';
            }
            function addMemberInput(name='', amt='') {
                const d = document.createElement('div'); d.className = 'flex items-center space-x-2 mt-1.5';
                d.innerHTML = `<input type="text" name="schedule-member-name" value="${name}" placeholder="åå­—" class="compact-input w-16 rounded-md border border-[#E0E0E0]"><input type="number" name="schedule-member-amount" value="${amt}" placeholder="é‡‘é¡" class="compact-input w-16 rounded-md border border-[#E0E0E0]"><button type="button" class="text-[#CB8572] font-bold p-1 rm-btn">Ã—</button>`;
                d.querySelector('.rm-btn').onclick = () => d.remove();
                document.getElementById('form-members-container').appendChild(d);
            }
            function addTripMemberInput(name='') {
                const d = document.createElement('div'); d.className = 'flex items-center space-x-2 mt-1.5';
                d.innerHTML = `<input type="text" name="trip-member-name" value="${name}" placeholder="æˆå“¡åå­—" class="flex-1 rounded-md border border-[#E0E0E0] p-2 border compact-input"><button type="button" class="text-[#CB8572] font-bold p-1 rm-btn">Ã—</button>`;
                d.querySelector('.rm-btn').onclick = () => d.remove();
                document.getElementById('settings-members-container').appendChild(d);
            }
            async function submitSchedule() {
                const form = document.getElementById('add-schedule-form');
                const dateVal = form['form-date'].value;
                if (!dateVal) return alert("è«‹é¸æ—¥æœŸ");
                const trip = tripData[currentTripId];
                const dayId = `Day ${dateDiffInDays(new Date(dateVal), new Date(trip.startDate)) + 1}`;
                const members = [];
                const names = document.querySelectorAll('input[name="schedule-member-name"]');
                const amts = document.querySelectorAll('input[name="schedule-member-amount"]');
                names.forEach((n, i) => { if(n.value.trim()) members.push({name: n.value.trim(), amount: amts[i].value ? parseFloat(amts[i].value) : null}); });
                const data = {
                    dayId, Time: form['form-time'].value, Location: form['form-location'].value,
                    Type: form['form-type'].value, èªªæ˜: form['form-details'].value, Address: form['form-address'].value,
                    Amount: parseFloat(form['form-amount'].value) || 0, Rate: currentTripRate || 1, members
                };
                const col = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`);
                if (editingScheduleId) await updateDoc(doc(col, editingScheduleId), data);
                else await addDoc(col, data);
                document.getElementById('add-schedule-modal').style.display = 'none';
                currentDayId = dayId; renderDayTabs(); loadSchedules(currentTripId, currentDayId);
            }

            // --- Lists Feature ---
            async function checkAndCreateDefaultLists(tripId) {
                const listCol = collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Lists`);
                const snapshot = await getDocs(listCol);
                if (snapshot.empty) {
                    await addDoc(listCol, { name: 'ç‰©å“', type: 'check', order: 1, items: [] });
                    await addDoc(listCol, { name: 'è³¼ç‰©', type: 'shopping', order: 2, items: [] });
                }
            }

            function loadLists() {
                if (!currentTripId) return alert("è«‹å…ˆé¸æ“‡è¨ˆç•«");
                document.getElementById('lists-modal').style.display = 'flex';
                if (unsubscribeLists) unsubscribeLists();
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), orderBy('order'));
                unsubscribeLists = onSnapshot(q, (snapshot) => {
                    const tabsContainer = document.getElementById('list-tabs');
                    const contentContainer = document.getElementById('list-content');
                    tabsContainer.innerHTML = '';
                    
                    let lists = [];
                    snapshot.forEach(doc => lists.push({ id: doc.id, ...doc.data() }));
                    // ç‚ºäº† List Swipe é‚è¼¯èƒ½å­˜å–ï¼Œå°‡ List Data æš«å­˜åˆ° tripData
                    if (tripData[currentTripId]) tripData[currentTripId].lists = lists;

                    if (lists.length === 0) {
                        contentContainer.innerHTML = '<div class="p-4 text-center text-[#A9A9A9] text-xs">è«‹æ–°å¢æ¸…å–®</div>';
                        return;
                    }
                    if (!currentListTabId || !lists.find(l => l.id === currentListTabId)) currentListTabId = lists[0].id;

                    lists.forEach(l => {
                        const tab = document.createElement('div');
                        const isActive = l.id === currentListTabId;
                        tab.className = `cursor-pointer px-3 py-1 text-sm ${isActive ? 'list-tab-active' : 'list-tab-inactive'}`;
                        tab.textContent = l.name;
                        tab.onclick = () => { currentListTabId = l.id; loadLists(); };
                        tabsContainer.appendChild(tab);
                    });

                    // Add Tab (+)
                    const addTab = document.createElement('div');
                    addTab.className = 'cursor-pointer px-3 py-1 text-sm text-[#A9A9A9] font-bold';
                    addTab.textContent = '+';
                    addTab.onclick = async () => {
                        const name = prompt("è¼¸å…¥æ–°æ¸…å–®åç¨±ï¼š");
                        if (name) {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), {
                                name, type: 'check', order: lists.length + 1, items: []
                            });
                        }
                    };
                    tabsContainer.appendChild(addTab);

                    // Render Content
                    const activeList = lists.find(l => l.id === currentListTabId);
                    contentContainer.innerHTML = '';
                    if (activeList) {
                        renderListItems(activeList, contentContainer);
                    }
                });
            }

            // 4. è¼”åŠ©å‡½å¼ï¼šå•Ÿç”¨æ»‘å‹•æ“ä½œ
            function enableSwipeToDelete(contentEl, actionEl, type) {
                let startX = 0;
                let currentTranslate = 0;
                let isSwiping = false;
                const threshold = 70; 
                const maxSlide = 140; 
                const isMobile = window.innerWidth <= 500;
                if (!isMobile) return; 

                contentEl.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isSwiping = false;
                    // Reset others
                    document.querySelectorAll('.swipe-item-content').forEach(el => {
                        if(el !== contentEl) el.style.transform = 'translateX(0)';
                    });
                }, {passive: true});

                contentEl.addEventListener('touchmove', (e) => {
                    const currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    // åªå…è¨±å‘å·¦æ»‘
                    if (diff < 0) {
                        isSwiping = true;
                        currentTranslate = Math.max(diff, -maxSlide); 
                        contentEl.style.transform = `translateX(${currentTranslate}px)`;
                    } else if(currentTranslate < 0) {
                        // Allow to close by sliding right
                        currentTranslate = Math.min(diff - maxSlide, 0);
                        contentEl.style.transform = `translateX(${currentTranslate}px)`;
                    }
                }, {passive: true});

                contentEl.addEventListener('touchend', (e) => {
                    if (isSwiping) {
                        if (currentTranslate < -threshold) {
                            contentEl.style.transform = `translateX(-${maxSlide}px)`; // Keep open
                        } else {
                            contentEl.style.transform = `translateX(0)`; // Close
                        }
                    }
                    currentTranslate = 0;
                    isSwiping = false;
                });
                
                // è™•ç†é»æ“Šæ»‘å‹•å€åŸŸæŒ‰éˆ•çš„äº‹ä»¶
                actionEl.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = button.getAttribute('data-action');
                        if (type === 'schedule') {
                            const scheduleJson = JSON.parse(button.closest('.swipe-item-delete-bg').querySelector('[data-action="modify"]').getAttribute('data-schedule'));
                            if (action === 'modify') {
                                openEditScheduleModal(JSON.stringify(scheduleJson));
                            } else if (action === 'delete') {
                                deleteSchedule(scheduleJson.id);
                            }
                        } else if (type === 'list') {
                            const wrapper = button.closest('.swipe-item-container');
                            const listData = tripData[currentTripId].lists.find(l => l.id === currentListTabId); 
                            const index = parseInt(wrapper.getAttribute('data-index'));
                            if (action === 'delete') {
                                deleteListItem(listData, index);
                            } else if (action === 'modify') {
                                alert("è«‹ç›´æ¥é»æ“Šè¼¸å…¥æ¡†é€²è¡Œä¿®æ”¹ã€‚");
                            }
                        }
                        contentEl.style.transform = `translateX(0)`;
                    });
                });
            }


            function renderListItems(listData, container) {
                const items = listData.items || [];
                
                // --- Add Item Logic for FAB ---
                const handleAddItem = async () => {
                    let newItem;
                    if (listData.type === 'check') {
                        newItem = { id: Date.now(), text: '', checkedLeft: false, checkedRight: false };
                    } else {
                        // Shopping List item
                        newItem = { id: Date.now(), text: '', desc: '', location: '', imageUrl: '' };
                    }
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`), {
                        items: [...items, newItem]
                    });
                };
                
                // Items List Container
                const listContainer = document.createElement('div');
                listContainer.className = 'space-y-2 overflow-y-auto flex-grow pb-12 list-content-inner'; 
                listContainer.setAttribute('data-list-id', listData.id);
                
                if (listData.type === 'check') {
                    // Checklist Header: å¸¶ | åç¨± | æ”¶
                    const header = document.createElement('div');
                    header.className = 'flex items-center text-xs font-bold text-[#7E92A1] px-2 py-1 mb-2 border-b border-gray-100 sticky top-0 bg-white z-20';
                    header.innerHTML = `
                        <div class="w-8 text-center">å¸¶</div>
                        <div class="flex-grow text-center">åç¨±</div>
                        <div class="w-8 text-center">æ”¶</div>
                    `;
                    container.appendChild(header);
                    
                } 
                
                // R4: å°åœ“ FAB 
                const smallFab = document.createElement('div');
                smallFab.className = 'list-fab-small'; 
                smallFab.textContent = 'ï¼‹';
                smallFab.onclick = handleAddItem;
                container.style.position = 'relative'; 
                container.appendChild(smallFab);


                items.forEach((item, index) => {
                    // Swipe Wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'swipe-item-container';
                    wrapper.setAttribute('data-index', index); 
                    
                    // 5. æ¸…å–®æ»‘å‹•æ“ä½œå€å¡Š (åŒ…å«ä¿®æ”¹å’Œåˆªé™¤æŒ‰éˆ•)
                    const deleteBg = document.createElement('div');
                    deleteBg.className = 'swipe-item-delete-bg';
                    deleteBg.innerHTML = `
                        <button class="px-2 py-1 h-full text-xs font-bold bg-[#7E92A1] hover:bg-[#64748B] transition-colors" data-action="modify" style="width: 70px;">ä¿®æ”¹</button>
                        <button class="px-2 py-1 h-full text-xs font-bold bg-[#CB8572] hover:bg-[#B56B5A] transition-colors" data-action="delete" style="width: 70px;">åˆªé™¤</button>
                    `;
                    wrapper.appendChild(deleteBg);

                    const content = document.createElement('div');
                    content.className = 'swipe-item-content';
                    wrapper.appendChild(content);

                    // 5. å•Ÿç”¨æ¸…å–®æ»‘å‹•æ“ä½œ
                    enableSwipeToDelete(content, deleteBg, 'list'); 
                    
                    // é»æ“Šæ¸…å–®é …ç›®åœ¨ PC æ¨¡å¼ä¸‹æ²’æœ‰ä»»ä½•ç‰¹æ®Šæ“ä½œï¼Œæ‰‹æ©Ÿæ¨¡å¼ä¸‹æ˜¯æ»‘å‹•
                    if (window.innerWidth > 500) {
                         content.style.cursor = 'text'; // è®“æ»‘é¼ çŸ¥é“å¯ä»¥é»æ“Šç·¨è¼¯
                    }


                    if (listData.type === 'check') {
                        // Checklist Item: å¸¶ | åç¨± | æ”¶
                        content.className += ' flex items-center gap-2 p-2 border border-gray-100 bg-white';
                        content.innerHTML = `
                            <div class="w-8 flex justify-center"><input type="checkbox" class="w-4 h-4 cursor-pointer" ${item.checkedLeft ? 'checked' : ''}></div>
                            <input type="text" value="${item.text}" placeholder="ç‰©å“åç¨±" class="flex-grow compact-input border-none bg-transparent focus:bg-gray-50 text-center">
                            <div class="w-8 flex justify-center"><input type="checkbox" class="w-4 h-4 cursor-pointer" ${item.checkedRight ? 'checked' : ''}></div>
                        `;
                        const inputs = content.querySelectorAll('input');
                        inputs[0].onchange = () => updateListItem(listData, index, { checkedLeft: inputs[0].checked });
                        inputs[1].onchange = () => updateListItem(listData, index, { text: inputs[1].value });
                        inputs[2].onchange = () => updateListItem(listData, index, { checkedRight: inputs[2].checked });
                    } else {
                        // Shopping Item: Image | Name/Desc | Location
                        content.className += ' grid grid-cols-[50px_1fr_80px] gap-2 items-start p-2 border border-gray-100 bg-white';
                        content.innerHTML = `
                            <div class="shopping-img-box" title="é»æ“Šä¸Šå‚³/æª¢è¦–">
                                ${item.imageUrl ? `<img src="${item.imageUrl}">` : '<span class="text-xs text-gray-400">åœ–</span>'}
                            </div>
                            <div class="flex flex-col gap-1">
                                <input type="text" value="${item.text}" placeholder="å•†å“åç¨±" class="compact-input border-b border-transparent focus:border-gray-300 font-bold w-full bg-transparent p-0">
                                <textarea placeholder="èªªæ˜" rows="2" class="compact-input border-none bg-transparent focus:bg-gray-50 w-full text-[10px] resize-none p-0">${item.desc || ''}</textarea>
                            </div>
                            <div class="flex flex-col gap-1 h-full justify-center">
                                <input type="text" value="${item.location || ''}" placeholder="åœ°é»" class="compact-input border border-gray-100 rounded bg-gray-50 w-full text-center">
                            </div>
                            <input type="file" accept="image/*" class="hidden file-input">
                        `;
                        
                        const imgBox = content.querySelector('.shopping-img-box');
                        const fileInput = content.querySelector('.file-input');
                        
                        imgBox.onclick = () => {
                            if(item.imageUrl) {
                                document.getElementById('zoom-img').src = item.imageUrl;
                                document.getElementById('image-zoom-modal').style.display = 'flex';
                            } else { fileInput.click(); }
                        };
                        
                        if (item.imageUrl) {
                             const editOverlay = document.createElement('div');
                             editOverlay.className = 'absolute bottom-0 right-0 bg-white/80 text-[8px] px-1 cursor-pointer';
                             editOverlay.textContent = 'æ›´æ›';
                             editOverlay.onclick = (e) => { e.stopPropagation(); fileInput.click(); };
                             imgBox.appendChild(editOverlay);
                        }

                        fileInput.onchange = async (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = new Image();
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    const MAX_WIDTH = 300;
                                    const scaleSize = MAX_WIDTH / img.width;
                                    canvas.width = MAX_WIDTH;
                                    canvas.height = img.height * scaleSize;
                                    const ctx = canvas.getContext("2d");
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
                                    updateListItem(listData, index, { imageUrl: dataUrl });
                                };
                                img.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        };

                        const inputs = content.querySelectorAll('input[type="text"], textarea');
                        inputs[0].onchange = () => updateListItem(listData, index, { text: inputs[0].value });
                        inputs[1].onchange = () => updateListItem(listData, index, { desc: inputs[1].value });
                        inputs[2].onchange = () => updateListItem(listData, index, { location: inputs[2].value });
                    }
                    
                    listContainer.appendChild(wrapper);
                });
                container.appendChild(listContainer);
            }

            async function updateListItem(listData, index, changes) {
                const newItems = [...listData.items];
                newItems[index] = { ...newItems[index], ...changes };
                await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`), { items: newItems });
            }

            async function deleteListItem(listData, index) {
                if(!confirm("åˆªé™¤æ­¤é …ç›®ï¼Ÿ")) return;
                const newItems = listData.items.filter((_, i) => i !== index);
                await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`), { items: newItems });
            }

            // --- Expenses ---
            async function loadExpenseSummary() {
                if (!currentTripId) return alert("è«‹å…ˆé¸æ“‡è¨ˆç•«");
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
                let grandTotalTWD = 0; 
                const memberExpenses = {}; 
                const typeTotalsTWD = {}; 
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const totalTWD = (parseFloat(data.Amount) || 0) * (parseFloat(data.Rate) || 1);
                    if (totalTWD > 0) {
                        grandTotalTWD += totalTWD;
                        typeTotalsTWD[data.Type] = (typeTotalsTWD[data.Type] || 0) + totalTWD;
                        const members = data.members || [];
                        let specifiedSum = 0, unspecifiedCount = 0, unspecifiedMembers = [];
                        members.forEach(m => {
                            const name = typeof m === 'string' ? m : m.name;
                            const amt = typeof m === 'string' ? null : m.amount;
                            if (amt !== null && !isNaN(amt)) {
                                specifiedSum += amt;
                                addMemberExpense(memberExpenses, name, data.Type, amt * (parseFloat(data.Rate) || 1));
                            } else {
                                unspecifiedCount++;
                                unspecifiedMembers.push(name);
                            }
                        });
                        if (unspecifiedCount > 0) {
                            const remainingBase = (parseFloat(data.Amount) || 0) - specifiedSum;
                            const splitTWD = remainingBase * (parseFloat(data.Rate) || 1) / unspecifiedCount;
                            unspecifiedMembers.forEach(name => {
                                addMemberExpense(memberExpenses, name, data.Type, splitTWD);
                            });
                        }
                    }
                });
                function addMemberExpense(stats, name, type, amountTWD) {
                    if (!stats[name]) stats[name] = { total: 0, categories: {} };
                    stats[name].total += amountTWD;
                    stats[name].categories[type] = (stats[name].categories[type] || 0) + amountTWD;
                }
                document.getElementById('expense-total-amount').textContent = grandTotalTWD.toFixed(0);
                
                // 3. åœ“é¤…åœ–é¡¯ç¤ºé‚è¼¯å„ªåŒ–
                const chartContainer = document.getElementById('expense-chart-container');
                chartContainer.innerHTML = '<canvas id="expense-chart"></canvas>'; // é‡æ–°å‰µå»º Canvas
                const ctx = document.getElementById('expense-chart').getContext('2d');
                
                if (expenseChart) expenseChart.destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨

                expenseChart = new Chart(ctx, { 
                    type: 'pie', 
                    data: { 
                        labels: Object.keys(typeTotalsTWD).map(t => CATEGORY_NAMES[t] || t),
                        datasets: [{ data: Object.values(typeTotalsTWD), backgroundColor: Object.keys(typeTotalsTWD).map(t => (CATEGORY_COLORS[t]||CATEGORY_COLORS.default).hex), borderWidth: 0 }] 
                    },
                    options: { 
                         responsive: true,
                         maintainAspectRatio: false, // ç¢ºä¿åœ¨ h-32 å…§é¡¯ç¤º
                         plugins: { legend: { display: false } } 
                    } 
                });
                
                const list = document.getElementById('expense-member-list'); list.innerHTML = '';
                const header = document.createElement('div');
                header.className = 'grid grid-cols-3 border-b border-[#E0E0E0] pb-1 mb-2 font-bold text-[#5F6368] text-[10px]'; 
                header.innerHTML = `<span>æˆå“¡</span><span class="text-center">é¡åˆ¥</span><span class="text-right">é‡‘é¡</span>`;
                list.appendChild(header);
                Object.keys(memberExpenses).sort().forEach(name => {
                    const memberData = memberExpenses[name];
                    const categories = memberData.categories;
                    let isFirst = true;
                    Object.keys(categories).forEach(cat => {
                        const row = document.createElement('div');
                        row.className = 'grid grid-cols-3 py-0.5 text-[10px] border-b border-[#F0F0F0] items-center';
                        const nameCell = isFirst ? `<span class="font-bold text-[#5F6368]">${name}</span>` : `<span></span>`;
                        const catName = CATEGORY_NAMES[cat] || cat;
                        const catColorClass = (CATEGORY_COLORS[cat] || CATEGORY_COLORS['default']).text;
                        row.innerHTML = `${nameCell}<span class="text-center font-bold ${catColorClass}">${catName}</span><span class="text-right text-[#888888]">$${categories[cat].toFixed(0)}</span>`;
                        list.appendChild(row);
                        isFirst = false;
                    });
                    const totalRow = document.createElement('div');
                    totalRow.className = 'grid grid-cols-3 py-1 mb-2 bg-[#F9F9F9] border-b border-[#E0E0E0] text-[10px] font-bold';
                    totalRow.innerHTML = `<span></span><span class="text-center text-[#5F6368]">å€‹äººç¸½è¨ˆ</span><span class="text-right text-[#7E92A1]">$${memberData.total.toFixed(0)}</span>`;
                    list.appendChild(totalRow);
                });
                document.getElementById('split-expense-modal').style.display = 'flex';
            }

            // --- Initialization ---
            function initApp() {
                document.addEventListener('DOMContentLoaded', async () => {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app); auth = getAuth(app);
                    await signInAnonymously(auth);
                    loadTripList();
                    
                    document.getElementById('trip-select').addEventListener('change', (e) => { changeTrip(e.target.value); });
                    document.getElementById('settings-btn').onclick = showSettingsModal;
                    document.getElementById('new-trip-btn').onclick = () => document.getElementById('new-trip-modal').style.display = 'flex';
                    // Center Add Button
                    document.getElementById('center-add-btn').onclick = showAddScheduleModal;
                    
                    document.getElementById('split-expense-btn').onclick = loadExpenseSummary;
                    document.getElementById('btn-lists').onclick = loadLists; 
                    
                    document.getElementById('bar-calc-currency').onchange = calculateCurrency;
                    document.getElementById('bar-calc-amount').oninput = calculateCurrency;
                    document.getElementById('form-amount').oninput = (e) => updateTwdPreview(e.target.value);
                    document.getElementById('form-amount-twd').oninput = (e) => updateForeignPreview(e.target.value);
                    document.getElementById('weather-info-container').onclick = openWeather; 

                    document.getElementById('modal-close-btn').onclick = () => document.getElementById('add-schedule-modal').style.display = 'none'; 
                    document.getElementById('modal-save-btn').onclick = submitSchedule;
                    document.getElementById('settings-modal-close-btn').onclick = () => document.getElementById('settings-modal').style.display = 'none';
                    document.getElementById('settings-modal-save-btn').onclick = async () => {
                        const form = document.getElementById('settings-form');
                        const country = document.getElementById('settings-trip-country').value; 
                        await setDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`), {
                            name: form['settings-trip-name'].value, country: country, currency: COUNTRY_CONFIG[country].currency, startDate: form['settings-start-date'].value, numDays: parseInt(form['settings-num-days'].value), members: Array.from(document.querySelectorAll('input[name="trip-member-name"]')).map(i=>i.value.trim()).filter(v=>v)
                        }, {merge: true});
                        document.getElementById('settings-modal').style.display = 'none';
                    };
                    document.getElementById('new-trip-modal-close-btn').onclick = () => document.getElementById('new-trip-modal').style.display = 'none';
                    document.getElementById('new-trip-modal-save-btn').onclick = async () => {
                        const form = document.getElementById('new-trip-form');
                        const country = document.getElementById('new-trip-country').value;
                        const id = form['new-trip-name'].value.replace(/[^a-z0-9]/gi,'_') + '_' + Date.now();
                        await setDoc(doc(db, `artifacts/${appId}/public/data/Trips/${id}`), {
                            name: form['new-trip-name'].value, startDate: form['new-trip-start-date'].value, numDays: 1, country, currency: COUNTRY_CONFIG[country].currency
                        }, {merge: true});
                        currentTripId = id; 
                        changeTrip(currentTripId);
                        document.getElementById('new-trip-modal').style.display = 'none';
                    };
                    document.getElementById('split-expense-close-btn').onclick = () => document.getElementById('split-expense-modal').style.display = 'none';
                    document.getElementById('lists-modal-close-btn').onclick = () => document.getElementById('lists-modal').style.display = 'none';
                    document.getElementById('image-zoom-modal').onclick = () => document.getElementById('image-zoom-modal').style.display = 'none';

                    document.getElementById('add-member-btn').onclick = () => addMemberInput('','');
                    document.getElementById('settings-add-member-btn').onclick = () => addTripMemberInput('');
                    document.getElementById('delete-trip-btn').onclick = async () => {
                             if(confirm("åˆªé™¤æ­¤è¨ˆç•«ï¼Ÿ")) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`)); document.getElementById('settings-modal').style.display = 'none'; }
                    };
                    document.getElementById('new-trip-from-settings-btn').onclick = () => { document.getElementById('settings-modal').style.display = 'none'; document.getElementById('new-trip-modal').style.display = 'flex'; };
                });
            }
            return { initApp, deleteListItem };
        })();
        window.App.initApp();
    </script>
</head>
<body>
    <div id="app-container" class="pb-20">
        <header>
            <div id="header-content-wrapper" class="p-3 border-b border-gray-100">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex flex-col justify-center flex-grow min-w-0 mr-2">
                        <div class="flex flex-col items-start">
                             <div class="flex items-center w-full">
                                  <button id="settings-btn" class="p-1 mr-0.5 text-[#888888] hover:text-[#5F6368]" title="è¡Œç¨‹è¨­å®š">ğŸ“…</button>
                                  <select id="trip-select" class="w-full truncate"></select>
                             </div>
                             <div class="flex items-center space-x-1 text-[#888888] ml-1 mt-0.5">
                                <span class="font-bold text-xs">ğŸ‘«</span>
                                <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
                             </div>
                        </div>
                    </div>

                    <div id="weather-info-container" class="flex flex-col items-center justify-center mr-2 text-[#888888]">
                         <div id="header-weather-icon" class="text-3xl leading-none mb-0"></div>
                         <span id="header-weather-temp" class="text-base font-bold"></span>
                         <span id="header-location-name" class="text-xs font-bold mt-0.5"></span>
                    </div>

                    <div class="flex items-center flex-shrink-0">
                        <button id="new-trip-btn" class="px-2 py-1 bg-[#7E92A1] text-white text-xs font-semibold rounded hover:bg-[#64748B] transition-colors hidden">+ æ–°å¢</button>
                    </div>
                </div>
                <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar"></div>
            </div>
        </header>
        
        <div class="px-3 pt-2 pb-0">
            <h2 id="schedule-list-date-header" class="text-sm font-bold text-[#4A4B4D] mb-1"></h2>
        </div>
        <div id="schedule-list-container" class="px-3 pt-0 pb-4">
            <div class="p-4 text-center text-[#A9A9A9] text-xs">è¡Œç¨‹åŠ è¼‰ä¸­...</div>
        </div>
    </div>
    
    <div id="combined-bottom-bar">
        
        <div id="currency-display-row" class="flex justify-between w-full border-b border-gray-100 pb-3 mb-2">

            <div id="rate-display-container" class="w-1/2 flex items-center justify-start border-r border-gray-100 pl-1">
                <span id="rate-display-label" class="text-xs font-bold text-[#7E92A1] text-left">ä»Šæ—¥åŒ¯ç‡ï¼š1 TWD = TWD 1.00</span> 
            </div>

            <div class="w-1/2 flex items-center justify-start gap-0.5 pl-2">
                <select id="bar-calc-currency" class="bg-gray-50 border border-[#E0E0E0] rounded p-0.5 text-[10px] font-bold text-[#5F6368] h-6 w-10 text-center appearance-none cursor-pointer">
                    <option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="CNY">CNY</option><option value="GBP">GBP</option>
                </select>
                <input type="number" id="bar-calc-amount" placeholder="0" class="w-10 h-6 text-[10px] p-0.5 border border-[#E0E0E0] rounded text-center font-medium text-[#5F6368]">
                
                <span class="text-[#A9A9A9] font-bold text-[9px]">=</span>
                <span class="text-[#7E92A1] font-bold text-[9px]">TWD</span>
                <input type="text" id="bar-calc-result" readonly value="0" class="w-12 h-6 text-[10px] p-0 border-none bg-transparent text-[#7E92A1] font-extrabold text-left focus:outline-none truncate">
            </div>
        </div>
        
        <div class="flex justify-around items-center w-full pt-1">
             <button id="btn-lists" class="flex-1 flex flex-row items-center justify-center gap-1 text-[#888888] hover:text-[#7E92A1] py-1">
                 <span class="text-base leading-none">ğŸ“</span>
                 <span class="text-[12px] font-bold leading-none">æ¸…å–®</span>
             </button>
             
             <button id="center-add-btn" class="prominent-integrated-btn">ï¼‹</button>

             <button id="split-expense-btn" class="flex-1 flex flex-row items-center justify-center gap-1 text-[#888888] hover:text-[#8F9E8B] py-1">
                 <span class="text-base leading-none">ğŸ’°</span>
                 <span class="text-[12px] font-bold leading-none">èŠ±è²»</span>
             </button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto">
            <h3 class="text-base font-bold mb-2 flex justify-between items-center text-[#4A4B4D]">
                <span id="add-schedule-modal-title">æ–°å¢è¡Œç¨‹</span>
                <button id="modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button>
            </h3>
            <form id="add-schedule-form" class="space-y-2">
                <div class="grid grid-cols-2 gap-1">
                    <div><label class="block compact-label">æ—¥æœŸ</label><input type="date" id="form-date" class="compact-input block w-[93%] rounded border shadow-sm text-center h-6 leading-6 p-2"></div>
                    <div><label class="block compact-label">æ™‚é–“</label><input type="time" id="form-time" class="compact-input block w-[93%] rounded border shadow-sm text-center h-6 leading-6 p-2"></div>
                </div>
                <div class="grid grid-cols-2 gap-1">
                    <div><label class="block compact-label">é¡å‹</label>
                        <select id="form-type" class="compact-input block w-full rounded border shadow-sm">
                            <option value="location">ğŸ“ æ™¯é»</option><option value="restaurant">ğŸ½ï¸ é¤å»³</option>
                            <option value="coffee">â˜• å’–å•¡å»³</option><option value="accommodation">ğŸ›ï¸ ä½å®¿</option>
                            <option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="shopping">ğŸ›ï¸ è³¼ç‰©</option>
                        </select>
                    </div>
                    <div><label class="block compact-label">åœ°é»</label><input type="text" id="form-location" class="compact-input block w-full rounded border shadow-sm"></div>
                </div>
                <div><label class="block compact-label">åœ°å€</label><input type="text" id="form-address" class="compact-input block w-full rounded border shadow-sm"></div>
                <div><label class="block compact-label">èªªæ˜</label><textarea id="form-details" rows="4" class="compact-input block w-full rounded border shadow-sm !h-auto"></textarea></div>
                
                <div class="flex gap-2 items-start">
                    <div class="flex-grow">
                        <div class="flex justify-start items-center mb-1 gap-2">
                            <label class="block compact-label">æˆå“¡</label>
                            <button type="button" id="add-member-btn" class="ml-[115px] text-xl font-bold text-[#7E92A1] hover:text-[#64748B] transition-colors leading-none">+</button>
                        </div>
                        <div id="form-members-container" class="space-y-1"></div>
                    </div>

                    <div class="w-24 flex-shrink-0 flex flex-col gap-1 mt-6">
                         <div class="flex items-center gap-1">
                              <label id="form-currency-label" class="text-[10px] text-[#7E92A1] font-bold w-6 text-right">USD</label>
                              <input type="number" id="form-amount" min="0" placeholder="0" class="w-full p-1 border border-[#E0E0E0] rounded text-right text-[11px] h-7 text-[#5F6368]">
                         </div>
                         <div class="flex items-center gap-1">
                              <span class="text-[10px] text-[#A9A9A9] font-bold w-6 text-right">TWD</span>
                              <input type="number" id="form-amount-twd" placeholder="0" class="w-full p-1 border border-[#E0E0E0] bg-[#F0F0F0] rounded text-right text-[#7E92A1] font-bold text-[11px] h-7">
                         </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center pt-3 mt-2 border-t border-[#E0E0E0]">
                    <button type="button" id="modal-delete-btn" class="px-2 py-0.5 h-6 text-white bg-[#CB8572] rounded text-[9px] font-bold flex-shrink-0 hover:bg-[#B56B5A] hidden">åˆªé™¤</button>
                    <div class="flex-grow flex justify-end">
                        <button type="button" id="modal-save-btn" class="px-2 py-0.5 h-6 text-white bg-[#7E92A1] rounded text-[9px] font-bold flex-shrink-0 hover:bg-[#64748B]">å„²å­˜</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="lists-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm h-[80vh] flex flex-col">
            <h3 class="text-base font-bold mb-2 flex justify-between items-center flex-shrink-0 text-[#4A4B4D]">æ¸…å–®<button id="lists-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button></h3>
            <div id="list-tabs" class="flex gap-1 border-b border-gray-100 mb-2 overflow-x-auto no-scrollbar flex-shrink-0"></div>
            <div id="list-content" class="flex-grow overflow-y-auto flex flex-col"></div>
        </div>
    </div>

    <div id="image-zoom-modal" class="modal-overlay hidden z-[150] bg-black/80">
        <img id="zoom-img" class="max-w-[95%] max-h-[90%] rounded shadow-lg object-contain">
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm">
            <h3 class="text-base font-bold mb-3 flex justify-between items-center text-[#4A4B4D]">è¡Œç¨‹è¨­å®š<button id="settings-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl">Ã—</button></h3>
            <form id="settings-form" class="space-y-3">
                <div><label class="block text-xs font-medium text-[#7E92A1]">è¨ˆç•«åç¨±</label><input type="text" id="settings-trip-name" class="compact-input mt-0.5 block w-full rounded border"></div>
                <div><label class="block text-xs font-medium text-[#7E92A1]">åœ‹å®¶</label><select id="settings-trip-country" class="compact-input mt-0.5 block w-full rounded border"><option value="USA">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option><option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option><option value="KR">ğŸ‡°ğŸ‡· éŸ“åœ‹</option><option value="UK">ğŸ‡¬ğŸ‡§ è‹±åœ‹</option><option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option></select></div>
                <div><label class="block text-xs font-medium text-[#7E92A1]">é–‹å§‹æ—¥æœŸ</label><input type="date" id="settings-start-date" class="compact-input mt-0.5 block w-full rounded border text-center"></div>
                <div><label class="block text-xs font-medium text-[#7E92A1]">ç¸½å¤©æ•¸</label><input type="number" id="settings-num-days" min="1" class="compact-input mt-0.5 block w-full rounded border"></div>
                <div><label class="block text-xs font-medium text-[#7E92A1]">æˆå“¡</label><div id="settings-members-container" class="space-y-1"></div><button type="button" id="settings-add-member-btn" class="mt-1 text-[10px] text-[#7E92A1] font-medium">+ æ–°å¢æˆå“¡</button></div>
                <div class="pt-3 flex justify-between items-center">
                    <button type="button" id="new-trip-from-settings-btn" class="px-3 py-1.5 text-xs text-[#7E92A1] bg-[#EBF2FA] rounded hover:bg-[#DCE6F2]">æ–°è¨ˆç•«</button>
                    <div class="flex space-x-2"><button type="button" id="delete-trip-btn" class="px-3 py-1.5 text-white bg-[#CB8572] rounded text-xs hover:bg-[#B56B5A]">åˆªé™¤</button><button type="button" id="settings-modal-save-btn" class="px-3 py-1.5 text-white bg-[#7E92A1] rounded text-xs hover:bg-[#64748B]">å„²å­˜</button></div>
                </div>
            </form>
        </div>
    </div>

    <div id="new-trip-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm">
            <h3 class="text-base font-bold mb-3 flex justify-between items-center text-[#4A4B4D]">æ–°å¢æ—…è¡Œè¨ˆç•«<button id="new-trip-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl">Ã—</button></h3>
            <form id="new-trip-form" class="space-y-3">
                <div><label class="block text-xs font-medium text-[#7E92A1]">è¨ˆç•«åç¨±</label><input type="text" id="new-trip-name" class="compact-input mt-0.5 block w-full rounded border"></div>
                <div><label class="block text-xs font-medium text-[#7E92A1]">åœ‹å®¶</label><select id="new-trip-country" class="compact-input mt-0.5 block w-full rounded border"><option value="USA">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option><option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option><option value="KR">ğŸ‡°ğŸ‡· éŸ“åœ‹</option><option value="UK">ğŸ‡¬ğŸ‡§ è‹±åœ‹</option><option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option></select></div>
                <div><label class="block text-xs font-medium text-[#7E92A1]">é–‹å§‹æ—¥æœŸ</label><input type="date" id="new-trip-start-date" class="compact-input mt-0.5 block w-full rounded border text-center"></div>
                <div class="pt-3 flex justify-end"><button type="button" id="new-trip-modal-save-btn" class="px-3 py-1.5 text-white bg-[#7E92A1] rounded text-xs hover:bg-[#64748B]">æ–°å¢</button></div>
            </form>
        </div>
    </div>
    
    <div id="split-expense-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]">
            <h3 class="text-sm font-bold mb-2 flex justify-between items-center flex-shrink-0 text-[#4A4B4D]">èŠ±è²»<button id="split-expense-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button></h3>
            <div class="flex-shrink-0 mb-2 bg-[#F9F9F9] p-2 rounded border border-[#E0E0E0]">
                <div class="flex justify-between items-end mb-1 border-b border-[#E0E0E0] pb-0.5">
                    <span class="text-[#5F6368] font-medium text-xs">ç¸½èŠ±è²»</span>
                    <span class="text-sm font-extrabold text-[#4A4B4D]">TWD$ <span id="expense-total-amount">0</span></span>
                </div>
                <div id="expense-chart-container" class="h-32 w-full relative flex justify-center items-center">
                    <canvas id="expense-chart"></canvas>
                </div>
            </div>
            <div class="overflow-y-auto flex-grow mb-1 pr-1">
                <div id="expense-member-list" class="space-y-0.5"></div>
            </div>
        </div>
    </div>
</body>
</html>