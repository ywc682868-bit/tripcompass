<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-touch-icon" href="icon.png">
    <title>Trip Compass</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- ÂÖ®ÂüüË®≠ÂÆö --- */
    html {
        scroll-snap-type: y mandatory;
        scroll-padding-top: 180px;
        scroll-behavior: smooth;
    }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* --- ÂÆπÂô®Ëàá‰ΩàÂ±Ä --- */
    #app-container {
        max-width: 500px;
        margin: 0 auto;
        min-height: 100vh;
        background-color: white;
        padding-top: 0px; 
        padding-bottom: 140px;
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    #schedule-list-container {
        padding-top: 180px; 
        padding-bottom: 85vh; 
        margin-top: 0; 
        position: relative; 
        z-index: 1; 
    }
    #schedule-list-container::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 600px; 
        background-color: white;
        z-index: -2; 
    }    
    
    /* --- Ë°åÁ®ãÂç°Áâá (Trip Card) --- */
    .trip-card { 
        width: 100%; 
        margin-bottom: 2rem; 
        position: relative; 
        height: 100px; 
        display: flex; 
        z-index: 0;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        scroll-margin-top: 180px;
    }

    #schedule-list-container .trip-card:first-child {
        margin-top: 10px; 
    }

    .trip-card::before {
        content: '';
        position: absolute;
        left: 28px; 
        top: -6px; 
        bottom: -6px; 
        width: 2px;
        background-color: #9C8B74; 
        z-index: -1; 
        transform: translateX(-50%);
    }
    
    .trip-card:first-child::before { top: -60px; bottom: -6px; height: auto; }
    .trip-card:last-child::before { bottom: auto; height: 100%; }

    .trip-card-visual-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 0.75rem; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); 
        background-color: white; 
        z-index: 10; 
    }

    /* --- Header Âõ∫ÂÆöÂçÄ --- */
    header { 
        position: fixed;
        top: 0; 
        left: 0;
        right: 0;
        width: 100%; 
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        background-color: #ffffff;
        z-index: 50; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    #header-content-wrapper {
        padding-top: calc(15px + env(safe-area-inset-top)); 
        padding-bottom: 4px; 
        padding-left: 12px; 
        padding-right: 12px;
    }
    #trip-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%237E92A1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right center; background-repeat: no-repeat; background-size: 1.25em 1.25em; -webkit-appearance: none; appearance: none; background-color: transparent; font-weight: 800; color: #4A4B4D; border: none; padding-right: 1.5rem; cursor: pointer; }
    #trip-select:focus { outline: none; }

    /* --- Footer (Â∫ïÈÉ®Â∑•ÂÖ∑Âàó) --- */
    #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem 0.2rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
    .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 18px; font-weight: 300; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: transform 0.1s; }
    .prominent-integrated-btn:active { transform: scale(0.95); }
    #rate-display-label { font-size: 0.85rem; font-weight: bold; color: #7E92A1; line-height: 20px; }
    #bar-calc-result { font-size: 0.7rem; font-weight: bold; color: #7E92A1; }

    /* --- ÊªëÂãïËàáÊåâÈàïÂ±§ --- */
    .swipe-item-container { position: relative; overflow: hidden; border-radius: 0.375rem; margin-bottom: 0.5rem; touch-action: pan-y; }
    .swipe-item-delete-bg { 
        position: absolute; top: 0; bottom: 0; right: 0; width: 140px; 
        display: flex; align-items: center; justify-content: flex-end; 
        z-index: 0; 
        border-radius: 0.75rem;
        overflow: hidden;
    }
    .swipe-item-content { 
        position: relative; z-index: 10; background-color: white; 
        transition: transform 0.2s ease-out; transform: translateX(0); 
        width: 100%; display: flex; align-items: stretch; 
        border-radius: 0.75rem;
        overflow: hidden;
    }
    
    .card-right-col { 
        display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 8px; 
        width: 95px; min-width: 95px; flex: 0 0 95px;
        padding-left: 6px; padding-top: 12px; position: relative; 
    }
    .card-right-col::before { content: ''; position: absolute; left: 0; top: 8%; bottom: 8%; width: 1px; background-color: #C0C0C0; }
    .card-static-actions { display: none !important; width: 100%; justify-content: flex-start !important; gap: 2px; }

    @media (min-width: 501px) {
        .swipe-item-delete-bg { display: none !important; }
        .card-static-actions { display: flex !important; }
        .desktop-del-btn { display: block !important; }
    }
    @media (max-width: 500px) {
        .desktop-del-btn { display: none !important; }
    }

    /* --- Modals & Lists --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(95, 99, 104, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; line-height: 28px; color: #5F6368; border-color: #E0E0E0; border-width: 1px; box-sizing: border-box; }
    .compact-label { font-size: 0.7rem; color: #7E92A1; font-weight: 700; margin-bottom: 0; }
    .shopping-img-box { width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; position: relative; }
</style>
</head>

<body>
    <div id="app-container">
        <header>
            <div id="header-content-wrapper">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col flex-grow min-w-0 mr-2">
                        <div class="flex items-center w-full mb-0.5">
                              <button id="settings-btn" class="p-1 mr-0.5 text-[#888888]" title="Ë®àÁï´Ë®≠ÂÆö">üìÖ</button>
                              <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
                              <button id="new-trip-btn" class="px-2 py-1 bg-[#7E92A1] text-white text-xs font-semibold rounded hidden">+ Êñ∞Â¢û</button>
                        </div>
                        <div class="flex items-center space-x-1 text-[#888888] ml-1 mb-1.5">
                              <span class="font-bold text-xs">üë´</span>
                              <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
                        </div>
                        <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
                        <div id="header-day-date-container">
                            <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
                        </div>
                    </div>
                    <div id="weather-info-container" class="flex flex-col items-end justify-start text-[#888888] flex-shrink-0 gap-2 pt-1">
                          <div id="header-weather-icon" class="text-4xl leading-none"></div>
                          <span id="header-weather-temp" class="text-sm font-bold"></span>
                          <span id="header-location-name" class="text-xs font-bold mt-0.5">ÂÆö‰Ωç‰∏≠...</span>
                          <span id="header-clothing-advice" class="text-xs font-bold text-[#CB8572] mt-0.5 whitespace-nowrap"></span>
                    </div>
                </div>
            </div>
        </header>
        <div id="schedule-list-container" class="px-3 pt-0 pb-4">
            <div class="p-4 text-center text-[#A9A9A9] text-xs">Ë°åÁ®ãÂä†Ëºâ‰∏≠...</div>
        </div>
    </div>

    <div id="combined-bottom-bar">
        <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5">
            <div id="rate-display-container" class="flex items-center justify-center" style="width: 50%; border-right: 1px solid #f3f4f6;">
                <span id="rate-display-label">ÂåØÁéá ‚âà ...</span> 
            </div>
            <div class="flex items-center justify-start gap-0.5 pl-3" style="width: 50%;">
                <select id="bar-calc-currency" class="bg-gray-50 border border-[#E0E0E0] rounded p-0.5 text-[10px] font-bold text-[#5F6368] h-6 w-10 text-center appearance-none cursor-pointer">
                    <option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="CNY">CNY</option><option value="GBP">GBP</option>
                </select>
                <input type="number" id="bar-calc-amount" class="w-20 h-6 text-[10px] p-0.5 border border-[#E0E0E0] rounded text-center">
                <span class="text-[1.1rem] font-bold text-[#A9A9A9]">=</span>
                <span class="text-[0.7rem] font-bold text-[#7E92A1] leading-[26px]">TWD</span>
                <input type="text" id="bar-calc-result" readonly class="w-12 h-6 p-0 border-none bg-transparent text-[#7E92A1] font-extrabold truncate pl-1">
            </div>
        </div>
        <div class="flex justify-between items-center w-full px-2 py-1.5">
             <button id="btn-lists" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888]"><span class="text-xl">üìù</span><span class="text-[12px] font-bold">Ê∏ÖÂñÆ</span></button>
             <div class="flex-none px-4"><button id="center-add-btn" class="prominent-integrated-btn shadow-md">Ôºã</button></div>
             <button id="split-expense-btn" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888]"><span class="text-xl">üí∞</span><span class="text-[12px] font-bold">Ëä±Ë≤ª</span></button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto relative"></div></div>
    <div id="lists-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm max-h-[80vh] flex flex-col relative"><h3 class="text-base font-bold mb-2 flex justify-between items-center text-[#4A4B4D]">Ê∏ÖÂñÆ<button id="lists-modal-close-btn" class="text-[#A9A9A9] text-xl">√ó</button></h3><div id="list-tabs" class="flex gap-1 border-b border-gray-100 mb-2 overflow-x-auto no-scrollbar"></div><div id="list-content" class="flex-grow overflow-y-auto relative"></div></div></div>
    <div id="split-expense-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]"></div></div>
    <div id="image-zoom-modal" class="modal-overlay hidden z-[150] bg-black/80"><img id="zoom-img" class="max-w-[95%] max-h-[90%] rounded shadow-lg object-contain"></div>
    <div id="settings-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>
    <div id="new-trip-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.App = (function() {
            const appId = 'my-trip-app';
            const firebaseConfig = {
                apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28",
                authDomain: "mytravelplanner-36283.firebaseapp.com",
                projectId: "mytravelplanner-36283",
                storageBucket: "mytravelplanner-36283.firebasestorage.app",
                messagingSenderId: "86504733738",
                appId: "1:86504733738:web:5167a6a795eb206dfed753"
            };
            
            const COUNTRY_CONFIG = { 
                'USA': { name: 'ÁæéÂúã', currency: 'USD', localName: 'New York', lat: 40.71, lon: -74.00 }, 
                'JP': { name: 'Êó•Êú¨', currency: 'JPY', localName: 'Êù±‰∫¨', lat: 35.68, lon: 139.76 }, 
                'KR': { name: 'ÈüìÂúã', currency: 'KRW', localName: 'ÏÑúÏö∏', lat: 37.56, lon: 126.97 }, 
                'UK': { name: 'Ëã±Âúã', currency: 'GBP', localName: 'London', lat: 51.50, lon: -0.12 }, 
                'TW': { name: 'Âè∞ÁÅ£', currency: 'TWD', localName: 'Âè∞Âåó', lat: 25.03, lon: 121.56 } 
            };
            
            const CATEGORY_COLORS = { 'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, '‰∫§ÈÄö': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' }, 'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
            const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];
            const CATEGORY_NAMES = { 'location': 'ÊôØÈªû', 'restaurant': 'È§êÂª≥', 'coffee': 'ÂíñÂï°Âª≥', '‰∫§ÈÄö': '‰∫§ÈÄö', 'shopping': 'Ë≥ºÁâ©', 'accommodation': '‰ΩèÂÆø', 'default': 'Êú™ÂàÜÈ°û' };

            let db, auth, currentUser;
            let currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {};
            let unsubscribeSchedule = null, unsubscribeTrips = null, unsubscribeLists = null, expenseChart = null, currentTripRate = 1;
            let currentListTabId = null;

            // --- Âü∫Á§éÂ∑•ÂÖ∑ ---
            function formatDateForHeader(date) { const year = String(date.getFullYear()).slice(-2); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); const dayOfWeekMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; return `${year}.${month}.${day} ${dayOfWeekMap[date.getDay()]}`; }
            function dateDiffInDays(date2, date1) { return Math.ceil(Math.abs(date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24)); }
            function getDateFromDayId(trip, dayId) { if (!trip || !trip.startDate) return null; const d = new Date(trip.startDate); d.setDate(d.getDate() + (parseInt(dayId.replace('Day ', '')) - 1)); return d; }
            function getCardStyle(type) { const c = CATEGORY_COLORS[type] || CATEGORY_COLORS['default']; const icons = {'coffee':'‚òï','restaurant':'üçΩÔ∏è','location':'üìç','‰∫§ÈÄö':'üöó','shopping':'üõçÔ∏è','accommodation':'üõèÔ∏è'}; return { color: c.bg, icon: icons[type] || '‚ùì', hex: c.hex, text: c.text }; }
            function formatCurrency(value) { if (typeof value !== 'number') value = parseFloat(value); if (isNaN(value) || value === 0) return '0'; return value.toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1'); }
            async function fetchExchangeRate(baseCurrency) { const fallback = { 'USD': 32.5, 'JPY': 0.215, 'KRW': 0.023, 'GBP': 41.2, 'CNY': 4.5, 'TWD': 1 }; if (!baseCurrency || baseCurrency === 'TWD') return 1; try { const r = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency}`); const d = await r.json(); return d.rates.TWD || fallback[baseCurrency]; } catch (e) { return fallback[baseCurrency] || 1; } }

            // --- ‰øÆÊîπÂæåÁöÑÂÆö‰ΩçÂ§©Ê∞£Ê†∏ÂøÉÈÇèËºØ ---
            async function updateHeaderInfo() {
                const trip = tripData[currentTripId]; if (!trip) return;
                const config = COUNTRY_CONFIG[trip.country || 'TW'] || COUNTRY_CONFIG['TW'];
                
                // 1. È†êË®≠ÂÄºÔºàÂÇôÁî®Ôºâ
                let lat = config.lat, lon = config.lon, displayName = config.localName;

                // 2. ÂòóË©¶Ë™øÁî®ÁÄèË¶ΩÂô® GPS ÂÆö‰Ωç
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000 });
                        });
                        lat = position.coords.latitude;
                        lon = position.coords.longitude;

                        // 3. ‰ΩøÁî® Nominatim ÂèçÊü•Âú∞Âêç
                        try {
                            const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-TW`);
                            const geoData = await geoRes.json();
                            if (geoData && geoData.address) {
                                displayName = geoData.address.city || geoData.address.town || geoData.address.district || geoData.address.village || geoData.address.state || config.localName;
                            }
                        } catch (geoErr) { console.log("Âú∞ÂêçÁç≤ÂèñÂ§±Êïó", geoErr); }
                    } catch (e) { console.log("ÂÆö‰ΩçÂ§±ÊïóÔºå‰ΩøÁî®È†êË®≠ÂÄº"); }
                }

                document.getElementById('header-location-name').textContent = displayName;
                currentTripRate = await fetchExchangeRate(config.currency);
                const barSelect = document.getElementById('bar-calc-currency'); 
                if(barSelect) { barSelect.value = config.currency; calculateCurrency(); }
                document.getElementById('header-members-list').innerHTML = (trip.members || []).map((m, i) => `<span class="${MEMBER_COLORS[i % MEMBER_COLORS.length]} mr-1">${m}</span>`).join('') || 'Â∞öÊú™Ë®≠ÂÆö';
                
                // 4. ÊäìÂèñË©≤ÂÆö‰ΩçÂú∞ÈªûÁöÑÂ§©Ê∞£
                try { 
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`); 
                    const data = await res.json(); 
                    const code = data.current.weather_code;
                    let icon = code > 50 ? 'üåßÔ∏è' : (code > 3 ? '‚òÅÔ∏è' : '‚òÄÔ∏è'); 
                    document.getElementById('header-weather-icon').textContent = icon; 
                    const temp = data.current.temperature_2m;
                    document.getElementById('header-weather-temp').textContent = `${temp}¬∞C`; 
                    let clothing = temp >= 25 ? 'üéΩ Áü≠Ë¢ñ' : (temp >= 20 ? 'üëï ËñÑÂ§ñÂ•ó' : (temp >= 15 ? 'üß• Â§ñÂ•ó' : 'üß£ ÁæΩÁµ®'));
                    document.getElementById('header-clothing-advice').textContent = clothing;
                } catch (e) { }
            }

            function changeTrip(tripId) { 
                currentTripId = tripId; const trip = tripData[tripId];
                if (trip && trip.startDate) {
                    const diffDays = Math.floor((new Date().setHours(0,0,0,0) - new Date(trip.startDate).setHours(0,0,0,0)) / 86400000) + 1;
                    currentDayId = (diffDays >= 1 && diffDays <= trip.numDays) ? `Day ${diffDays}` : 'Day 1';
                } else currentDayId = 'Day 1';
                currentListTabId = null; updateHeaderInfo(); renderDayTabs(); loadSchedules(currentTripId, currentDayId); 
            }

            function createTripCard(schedule) {
                const style = getCardStyle(schedule.Type); const rate = schedule.Rate || 1; const members = schedule.members || [];
                const specificPayers = members.filter(m => typeof m !== 'string' && m.isPayer && m.amount > 0);
                let amountTWD = specificPayers.length > 0 ? specificPayers.reduce((sum, m) => sum + (m.amount * rate), 0) : (schedule.Amount || 0) * rate;
                const participants = members.filter(m => !(typeof m !== 'string' && m.amount > 0 && !m.isPayer));
                const perPersonTWD = participants.length > 0 ? amountTWD / participants.length : 0;
                
                const card = document.createElement('div'); card.className = 'trip-card flex w-full mb-3 relative';
                const wrapper = document.createElement('div'); wrapper.className = 'trip-card-visual-wrapper';
                const swipeBg = document.createElement('div'); swipeBg.className = 'swipe-item-delete-bg';
                swipeBg.innerHTML = `<button class="px-3 h-full bg-[#7E92A1] text-white font-bold" onclick="window.App.edit('${schedule.id}')">‰øÆÊîπ</button><button class="px-3 h-full bg-[#CB8572] text-white font-bold" onclick="window.App.del('${schedule.id}')">Âà™Èô§</button>`;
                
                const content = document.createElement('div'); content.className = 'swipe-item-content bg-white relative items-stretch h-full z-10';
                content.innerHTML = `
                    <div class="${CATEGORY_COLORS[schedule.Type]?.bg || 'bg-gray-400'} w-14 flex flex-col items-center justify-start gap-2 text-white py-3">
                        <span class="text-[10px] font-bold">${schedule.Time}</span><span class="text-2xl">${style.icon}</span><span class="text-[9px]">${CATEGORY_NAMES[schedule.Type]}</span>
                    </div>
                    <div class="flex-grow py-2 pl-2 pr-1 flex flex-col min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xs font-bold truncate">${schedule.Location}</h3>
                            <div class="flex gap-1">${members.map((m, i) => `<span class="${MEMBER_COLORS[i % 5]} text-[10px] font-bold">${typeof m === 'string' ? m : m.name}</span>`).join('')}</div>
                        </div>
                        <p class="text-[#888888] text-[10px] line-clamp-3 mt-0.5">${schedule.Ë™™Êòé || ''}</p>
                    </div>
                    <div class="card-right-col h-full flex flex-col pt-3">
                        <span class="text-[#8F9E8B] font-bold text-[10px]">üí∞ $${amountTWD.toFixed(0)}</span>
                        <span class="text-[#888888] font-bold text-[10px]">üë´ $${perPersonTWD.toFixed(0)}</span>
                        ${schedule.MustGo ? '<span class="text-[9px] text-[#CB8572] border border-[#CB8572] px-1 mt-auto mb-2">ÂøÖÂéª</span>' : ''}
                    </div>`;
                wrapper.append(swipeBg, content); card.appendChild(wrapper);
                enableSwipeToDelete(content, swipeBg);
                return card;
            }

            function loadSchedules(tripId, dayId) {
                if (unsubscribeSchedule) unsubscribeSchedule();
                unsubscribeSchedule = onSnapshot(query(collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Schedules`), where('dayId', '==', dayId), orderBy('Time')), (snap) => {
                    const cont = document.getElementById('schedule-list-container'); cont.innerHTML = '';
                    if (snap.empty) cont.innerHTML = '<div class="p-4 text-center text-xs">Êú¨Êó•ÁÑ°Ë°åÁ®ã</div>';
                    else snap.forEach(d => cont.appendChild(createTripCard({ id: d.id, ...d.data() })));
                    const trip = tripData[currentTripId]; if (trip) updateHeaderDateWithDDay(getDateFromDayId(trip, dayId));
                });
            }

            // --- Êñ∞ÁâàÊ∏ÖÂñÆËàáËä±Ë≤ªÈ†ÅÈù¢ÈÇèËºØ ---
            function loadLists() {
                const modal = document.getElementById('lists-modal'); modal.style.display = 'flex';
                onSnapshot(query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), orderBy('order')), (snap) => {
                    const tabs = document.getElementById('list-tabs'); const cont = document.getElementById('list-content');
                    tabs.innerHTML = ''; cont.innerHTML = '';
                    const lists = []; snap.forEach(d => lists.push({id: d.id, ...d.data()}));
                    if(!lists.length) return;
                    if(!currentListTabId) currentListTabId = lists[0].id;
                    lists.forEach(l => {
                        const t = document.createElement('div'); const active = l.id === currentListTabId;
                        t.className = `cursor-pointer px-3 py-2 text-sm ${active ? 'border-b-2 border-[#7E92A1] text-[#7E92A1] font-bold' : 'text-gray-400'}`;
                        t.textContent = l.name; t.onclick = () => { currentListTabId = l.id; loadLists(); };
                        tabs.appendChild(t);
                    });
                    renderListItems(lists.find(l=>l.id===currentListTabId), cont);
                });
            }

            function renderListItems(list, container) {
                const fab = document.createElement('div'); fab.className = 'list-fab-dynamic'; fab.innerHTML = 'Ôºã';
                fab.style.cssText = `position:absolute; bottom:20px; right:20px; width:44px; height:44px; background:#7E92A1; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; z-index:50;`;
                fab.onclick = async () => {
                    const item = list.type === 'check' ? { id: Date.now(), text: '', checkedLeft: false, checkedRight: false } : { id: Date.now(), text: '', imageUrl: '' };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${list.id}`), { items: [...(list.items||[]), item] });
                };
                container.parentElement.appendChild(fab);
                const inner = document.createElement('div'); inner.className = 'pb-16 mt-2 space-y-2';
                (list.items || []).forEach((item, idx) => {
                    const c = document.createElement('div'); c.className = 'bg-white p-2 border rounded-lg flex items-center gap-2';
                    if(list.type === 'check') {
                        c.innerHTML = `<input type="checkbox" ${item.checkedLeft?'checked':''} class="L"><input type="checkbox" ${item.checkedRight?'checked':''} class="R"><input type="text" value="${item.text||''}" class="flex-grow border-none text-xs">`;
                        c.querySelector('.L').onchange = (e) => updateListItem(list, idx, {checkedLeft: e.target.checked});
                        c.querySelector('.R').onchange = (e) => updateListItem(list, idx, {checkedRight: e.target.checked});
                        c.querySelector('input[type="text"]').onchange = (e) => updateListItem(list, idx, {text: e.target.value});
                    } else {
                        c.innerHTML = `<div class="shopping-img-box w-12 h-12">${item.imageUrl?`<img src="${item.imageUrl}" class="w-full h-full object-cover">`:'üì∑'}</div><input type="text" value="${item.text||''}" class="flex-grow font-bold text-xs border-none" placeholder="ÂìÅÂêç">`;
                    }
                    inner.appendChild(c);
                });
                container.appendChild(inner);
            }

            async function updateListItem(l, i, chg) { const ni=[...l.items]; ni[i]={...ni[i], ...chg}; await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${l.id}`), {items:ni}); }

            async function loadExpenseSummary() {
                const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
                let total=0, types={}, mems={}, balances={};
                snap.forEach(d => {
                    const da = d.data(); const rate = da.Rate || 1; const members = da.members || [];
                    const effectiveTotal = (da.Amount || 0) * rate; if(effectiveTotal <= 0) return;
                    total += effectiveTotal; types[da.Type] = (types[da.Type] || 0) + effectiveTotal;
                    const debtPer = effectiveTotal / (members.length || 1);
                    members.forEach(p => {
                        const n = typeof p === 'string' ? p : p.name;
                        balances[n] = (balances[n] || 0) - debtPer; if(p.isPayer) balances[n] += effectiveTotal;
                        if(!mems[n]) mems[n] = { total: 0 }; mems[n].total += debtPer;
                    });
                });
                const modal = document.getElementById('split-expense-modal'); modal.style.display = 'flex';
                modal.innerHTML = `<h3 class="font-bold mb-3">Á∏ΩÊîØÂá∫ TWD$ ${total.toFixed(0)}</h3><div id="exp-list" class="text-xs space-y-1"></div>`;
                const list = modal.querySelector('#exp-list');
                Object.keys(mems).forEach(n => { list.innerHTML += `<div class="flex justify-between border-b py-1"><span>${n}</span><span>$${mems[n].total.toFixed(0)}</span></div>`; });
                // ÁµêÁÆóÂª∫Ë≠∞ (Á∞°ÊòìÁâà)
                list.innerHTML += `<div class="mt-4 font-bold text-[#7E92A1]">ËΩâÂ∏≥Âª∫Ë≠∞</div>`;
                let debtors = [], creditors = [];
                for(let n in balances) { if(balances[n] < -1) debtors.push({n, a:Math.abs(balances[n])}); else if(balances[n] > 1) creditors.push({n, a:balances[n]}); }
                while(debtors.length && creditors.length) {
                    let amt = Math.min(debtors[0].a, creditors[0].a);
                    list.innerHTML += `<div class="p-1 bg-gray-50 rounded">${debtors[0].n} ‚Üí ${creditors[0].n}: $${amt.toFixed(0)}</div>`;
                    debtors[0].a -= amt; creditors[0].a -= amt;
                    if(debtors[0].a < 1) debtors.shift(); if(creditors[0].a < 1) creditors.shift();
                }
            }

            function updateHeaderDateWithDDay(d) {
                if(!d) return; const dateStr = formatDateForHeader(d); const today = new Date().setHours(0,0,0,0);
                const trip = tripData[currentTripId]; if(!trip) return;
                const tripStart = new Date(trip.startDate).setHours(0,0,0,0);
                const diffDays = Math.floor((today - tripStart) / 86400000);
                const dString = diffDays === 0 ? 'D-0' : (diffDays > 0 ? `D+${diffDays + 1}` : `D${diffDays}`);
                document.getElementById('header-day-date-display').innerHTML = `${dateStr} <span class="ml-2 text-[#7E92A1] text-xs font-bold tracking-wide">üõ´ ${dString}</span>`;
            }

            function renderDayTabs() {
                const cont = document.getElementById('day-tabs-container'); cont.innerHTML = '';
                const trip = tripData[currentTripId]; if(!trip) return;
                for(let i=0; i < trip.numDays; i++) {
                    const dId = `Day ${i+1}`; const btn = document.createElement('button');
                    btn.className = `px-3 py-1.5 text-xs font-bold rounded-lg ${dId === currentDayId ? 'bg-[#5F6368] text-white' : 'bg-[#E4E6E8]'}`;
                    btn.textContent = dId; btn.onclick = () => { currentDayId = dId; renderDayTabs(); loadSchedules(currentTripId, currentDayId); };
                    cont.appendChild(btn);
                }
            }

            async function calculateCurrency() {
                const code = document.getElementById('bar-calc-currency').value; const amt = parseFloat(document.getElementById('bar-calc-amount').value) || 0;
                const rate = await fetchExchangeRate(code);
                document.getElementById('rate-display-label').textContent = `ÂåØÁéá ‚âà ${code} ${(1/rate).toFixed(2)}`;
                document.getElementById('bar-calc-result').value = amt ? (amt * rate).toFixed(0) : '';
            }

            function enableSwipeToDelete(c, b) {
                let startX=0; c.ontouchstart = (e) => startX = e.touches[0].clientX;
                c.ontouchmove = (e) => { let d = e.touches[0].clientX - startX; if(d < -30) c.style.transform = `translateX(-140px)`; else if(d > 30) c.style.transform = `translateX(0)`; };
            }

            function initApp() {
                document.addEventListener('DOMContentLoaded', async () => {
                    const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                    await signInAnonymously(auth); currentUser = auth.currentUser;
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/Trips`), (snap) => {
                        const sel = document.getElementById('trip-select'); sel.innerHTML = '';
                        snap.forEach(d => { tripData[d.id] = { id: d.id, ...d.data() }; const op = document.createElement('option'); op.value=d.id; op.textContent=d.data().name; sel.appendChild(op); });
                        if(!currentTripId && snap.docs[0]) { currentTripId = snap.docs[0].id; changeTrip(currentTripId); }
                    });
                    document.getElementById('btn-lists').onclick = loadLists;
                    document.getElementById('split-expense-btn').onclick = loadExpenseSummary;
                    document.getElementById('bar-calc-amount').oninput = calculateCurrency;
                    document.getElementById('bar-calc-currency').onchange = calculateCurrency;
                    document.getElementById('lists-modal-close-btn').onclick = () => document.getElementById('lists-modal').style.display = 'none';
                });
            }
            return { initApp };
        })();
        window.App.initApp();
    </script>
</body>
</html>
