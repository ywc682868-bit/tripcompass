<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-touch-icon" href="icon.png">
    <title>Trip Compass</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- ÂÖ®ÂüüË®≠ÂÆö --- */
    html {
        scroll-snap-type: y mandatory;
        scroll-padding-top: 180px;
        scroll-behavior: smooth;
    }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* --- ÂÆπÂô®Ëàá‰ΩàÂ±Ä --- */
    #app-container {
        max-width: 500px;
        margin: 0 auto;
        min-height: 100vh;
        background-color: white;
        padding-top: 0px; 
        padding-bottom: 140px;
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    #schedule-list-container {
        padding-top: 180px; 
        padding-bottom: 85vh; 
        margin-top: 0; 
        position: relative; 
        z-index: 1; 
    }
    #schedule-list-container::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 600px; 
        background-color: white;
        z-index: -2; 
    }    
    
    /* --- Ë°åÁ®ãÂç°Áâá (Trip Card) --- */
    .trip-card { 
        width: 100%; 
        margin-bottom: 2rem; 
        position: relative; 
        height: 100px; 
        display: flex; 
        z-index: 0;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        scroll-margin-top: 180px;
    }
    #schedule-list-container .trip-card:first-child { margin-top: 10px; }
    .trip-card::before {
        content: '';
        position: absolute;
        left: 28px; 
        top: -6px;          
        bottom: -6px;          
        width: 2px;
        background-color: #9C8B74; 
        z-index: -1; 
        transform: translateX(-50%);
    }
    .trip-card:first-child::before { top: -60px; bottom: -6px; height: auto; }
    .trip-card:last-child::before { bottom: auto; height: 100%; }

    .trip-card-visual-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 0.75rem; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); 
        background-color: white; 
        z-index: 10; 
    }

    /* --- Header --- */
    header { 
        position: fixed; top: 0; left: 0; right: 0;
        width: 100%; max-width: 500px; margin: 0 auto;
        background-color: #ffffff; z-index: 50; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    #header-content-wrapper { padding: calc(15px + env(safe-area-inset-top)) 12px 4px 12px; }
    #trip-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%237E92A1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right center; background-repeat: no-repeat; background-size: 1.25em 1.25em; -webkit-appearance: none; appearance: none; background-color: transparent; font-weight: 800; color: #4A4B4D; border: none; padding-right: 1.5rem; cursor: pointer; }
    
    /* --- Footer --- */
    #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem 0.2rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
    .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 18px; font-weight: 300; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: transform 0.1s; }

    /* ÊªëÂãïËàáÊåâÈàï */
    .swipe-item-container { position: relative; overflow: hidden; border-radius: 0.375rem; margin-bottom: 0.5rem; touch-action: pan-y; }
    .swipe-item-delete-bg { position: absolute; top: 0; bottom: 0; right: 0; width: 140px; display: flex; align-items: center; justify-content: flex-end; z-index: 0; border-radius: 0.75rem; overflow: hidden; }
    .swipe-item-content { position: relative; z-index: 10; background-color: white; transition: transform 0.2s ease-out; width: 100%; display: flex; align-items: stretch; border-radius: 0.75rem; overflow: hidden; }
    
    .desktop-del-btn { display: none !important; }
    .card-static-actions { display: none !important; }

    @media (min-width: 501px) {
        .desktop-del-btn { 
            display: flex !important; align-items: center; justify-content: center; 
            color: #D1D5DB; font-weight: bold; cursor: pointer; font-size: 20px; transition: color 0.2s; 
        }
        .desktop-del-btn:hover { color: #CB8572; }
        .card-static-actions { display: flex !important; width: 100%; justify-content: flex-start; gap: 4px; padding: 0; margin: 0; }
        .swipe-item-delete-bg { display: none !important; }
    }

    .card-right-col { display: flex; flex-direction: column; width: 95px; padding-left: 6px; padding-top: 12px; position: relative; }
    .card-right-col::before { content: ''; position: absolute; left: 0; top: 8%; bottom: 8%; width: 1px; background-color: #C0C0C0; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(95, 99, 104, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; line-height: 28px; color: #5F6368; border-color: #E0E0E0; border-width: 1px; box-sizing: border-box; }
    
    .list-tab-active { border-bottom: 2px solid #7E92A1; color: #7E92A1; font-weight: bold; }
    .list-tab-inactive { color: #A9A9A9; }
    .shopping-img-box { width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; position: relative; }
    .shopping-img-box img { width: 100%; height: 100%; object-fit: cover; }
</style>
</head>

<body>
    <div id="app-container">
        <header>
            <div id="header-content-wrapper">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col flex-grow min-w-0 mr-2">
                        <div class="flex items-center w-full mb-0.5">
                              <button id="settings-btn" class="p-1 mr-0.5 text-[#888888]">üìÖ</button>
                              <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
                              <button id="new-trip-btn" class="px-2 py-1 bg-[#7E92A1] text-white text-xs font-semibold rounded hidden">+ Êñ∞Â¢û</button>
                        </div>
                        <div class="flex items-center space-x-1 text-[#888888] ml-1 mb-1.5">
                              <span class="font-bold text-xs">üë´</span>
                              <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
                        </div>
                        <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
                        <div id="header-day-date-container">
                            <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
                        </div>
                    </div>
                    <div id="weather-info-container" class="flex flex-col items-end justify-start text-[#888888] flex-shrink-0 gap-1 pt-1">
                          <div id="header-weather-icon" class="text-4xl leading-none"></div>
                          <span id="header-weather-temp" class="text-sm font-bold"></span>
                          <span id="header-location-name" class="text-xs font-bold"></span>
                          <span id="header-clothing-advice" class="text-[10px] font-bold text-[#CB8572] whitespace-nowrap"></span>
                    </div>
                </div>
            </div>
        </header>
        <div id="schedule-list-container" class="px-3 pt-0 pb-4"></div>
    </div>

    <div id="combined-bottom-bar">
        <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5">
            <div id="rate-display-container" class="flex items-center justify-center border-r border-gray-100 w-1/2">
                <span id="rate-display-label">ÂåØÁéá ‚âà ...</span> 
            </div>
            <div class="flex items-center justify-start gap-0.5 pl-3 w-1/2">
                <select id="bar-calc-currency" class="bg-gray-50 border border-[#E0E0E0] rounded text-[10px] h-6 w-10 text-center">
                    <option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="CNY">CNY</option><option value="GBP">GBP</option>
                </select>
                <input type="number" id="bar-calc-amount" class="w-20 h-6 text-[10px] border border-[#E0E0E0] rounded text-center">
                <span class="font-bold text-[#A9A9A9]">=</span>
                <span class="text-[0.7rem] font-bold text-[#7E92A1]">TW</span>
                <input type="text" id="bar-calc-result" readonly class="w-12 h-6 border-none bg-transparent text-[#7E92A1] font-extrabold pl-1">
            </div>
        </div>
        <div class="flex justify-between items-center w-full px-2 py-1.5">
             <button id="btn-lists" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888]">
                 <span class="text-xl">üìù</span><span class="text-[12px] font-bold">Ê∏ÖÂñÆ</span>
             </button>
             <div class="flex-none px-4"><button id="center-add-btn" class="prominent-integrated-btn shadow-md">Ôºã</button></div>
             <button id="split-expense-btn" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888]">
                 <span class="text-xl">üí∞</span><span class="text-[12px] font-bold">Ëä±Ë≤ª</span>
             </button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto relative"></div></div>
    <div id="lists-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm max-h-[80vh] flex flex-col relative"><h3 class="text-base font-bold mb-2 flex justify-between items-center text-[#4A4B4D]">Ê∏ÖÂñÆ<button id="lists-modal-close-btn" class="text-[#A9A9A9] text-xl">√ó</button></h3><div id="list-tabs" class="flex gap-1 border-b border-gray-100 mb-2 overflow-x-auto no-scrollbar"></div><div id="list-content" class="flex-grow overflow-y-auto flex flex-col relative"></div></div></div>
    <div id="image-zoom-modal" class="modal-overlay hidden z-[150] bg-black/80"><img id="zoom-img" class="max-w-[95%] max-h-[90%] rounded object-contain"></div>
    <div id="settings-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>
    <div id="split-expense-modal" class="modal-overlay hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.App = (function() {
            const appId = 'my-trip-app';
            const firebaseConfig = { apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28", authDomain: "mytravelplanner-36283.firebaseapp.com", projectId: "mytravelplanner-36283", storageBucket: "mytravelplanner-36283.firebasestorage.app", messagingSenderId: "86504733738", appId: "1:86504733738:web:5167a6a795eb206dfed753" };
            const COUNTRY_CONFIG = { 'USA': { name: 'ÁæéÂúã', currency: 'USD', localName: 'New York', lat: 40.71, lon: -74.00 }, 'JP': { name: 'Êó•Êú¨', currency: 'JPY', localName: 'Êù±‰∫¨', lat: 35.68, lon: 139.76 }, 'KR': { name: 'ÈüìÂúã', currency: 'KRW', localName: 'ÏÑúÏö∏', lat: 37.56, lon: 126.97 }, 'UK': { name: 'Ëã±Âúã', currency: 'GBP', localName: 'London', lat: 51.50, lon: -0.12 }, 'TW': { name: 'Âè∞ÁÅ£', currency: 'TWD', localName: 'Âè∞Âåó', lat: 25.03, lon: 121.56 } };
            const CATEGORY_COLORS = { 'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, '‰∫§ÈÄö': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' }, 'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' }, 'fee': { bg: 'bg-[#D4A5A5]', hex: '#D4A5A5', text: 'text-[#D4A5A5]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
            const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];
            const CATEGORY_NAMES = { 'location': 'ÊôØÈªû', 'restaurant': 'È§êÂª≥', 'coffee': 'ÂíñÂï°Âª≥', '‰∫§ÈÄö': '‰∫§ÈÄö', 'shopping': 'Ë≥ºÁâ©', 'accommodation': '‰ΩèÂÆø', 'fee': 'ÊâãÁ∫åË≤ª', 'default': 'Êú™ÂàÜÈ°û' };

            let db, auth, currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {}, unsubscribeSchedule = null, unsubscribeTrips = null, unsubscribeLists = null, expenseChart = null, currentTripRate = 1, currentListTabId = null;

            function formatDateForHeader(date) { const year = String(date.getFullYear()).slice(-2); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); const dayOfWeekMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; return `${year}.${month}.${day} ${dayOfWeekMap[date.getDay()]}`; }
            function dateDiffInDays(date2, date1) { return Math.ceil(Math.abs(date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24)); }
            function getDateFromDayId(trip, dayId) { if (!trip || !trip.startDate) return null; const d = new Date(trip.startDate); d.setDate(d.getDate() + (parseInt(dayId.replace('Day ', '')) - 1)); return d; }
            function getCardStyle(type) { const c = CATEGORY_COLORS[type] || CATEGORY_COLORS['default']; const icons = {'coffee':'‚òï','restaurant':'üçΩÔ∏è','location':'üìç','‰∫§ÈÄö':'üöó','shopping':'üõçÔ∏è','accommodation':'üõèÔ∏è','fee':'üßß'}; return { color: c.bg, icon: icons[type] || '‚ùì', hex: c.hex, text: c.text }; }
            function navigateToMap(input) { if (!input) return; const url = (input.includes('http') || input.includes('maps.')) ? input : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(input)}`; window.open(url, '_blank'); }
            async function fetchExchangeRate(baseCurrency) { const fallback = { 'USD': 32.5, 'JPY': 0.215, 'KRW': 0.023, 'GBP': 41.2, 'CNY': 4.5, 'TWD': 1 }; if (!baseCurrency || baseCurrency === 'TWD') return 1; try { const r = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency}`); const d = await r.json(); if (d && d.rates && d.rates.TWD) return d.rates.TWD; } catch (e) {} return fallback[baseCurrency] || 1; }

            function updateHeaderDateWithDDay(d) {
                if (!d) return;
                const today = new Date(); today.setHours(0, 0, 0, 0);
                let tripCountdownHtml = '';
                const trip = tripData[currentTripId];
                if (trip && trip.startDate) {
                    const tripStart = new Date(trip.startDate); tripStart.setHours(0, 0, 0, 0);
                    const diffDaysTrip = Math.floor((today.getTime() - tripStart.getTime()) / (1000 * 60 * 60 * 24));
                    let dString = diffDaysTrip === 0 ? 'D-0' : (diffDaysTrip > 0 ? `D+${diffDaysTrip + 1}` : `D${diffDaysTrip}`);
                    tripCountdownHtml = `<span class="ml-2 text-[#7E92A1] text-xs font-bold">üõ´ ${dString}</span>`;
                }
                const anniversary = new Date('2025-08-01T00:00:00');
                const diffDaysLove = Math.floor((today.getTime() - anniversary.getTime()) / (1000 * 60 * 60 * 24)) + 1;
                let loveHtml = `<span class="ml-2 text-[#D4A5A5] text-xs font-extrabold">‚ù§Ô∏è ${diffDaysLove}Â§©</span>`;
                document.getElementById('header-day-date-display').innerHTML = `${formatDateForHeader(d)}${tripCountdownHtml}${loveHtml}`;
            }

            async function updateHeaderInfo() {
                const trip = tripData[currentTripId]; if (!trip) return;
                const config = COUNTRY_CONFIG[trip.country || 'TW'] || COUNTRY_CONFIG['TW'];
                document.getElementById('header-location-name').textContent = config.localName;
                currentTripRate = await fetchExchangeRate(config.currency);
                const barSelect = document.getElementById('bar-calc-currency'); if(barSelect) { barSelect.value = config.currency; calculateCurrency(); }
                document.getElementById('header-members-list').innerHTML = (trip.members || []).map((m, i) => `<span class="${MEMBER_COLORS[i % MEMBER_COLORS.length]} mr-1">${m}</span>`).join('') || 'Â∞öÊú™Ë®≠ÂÆö';
                try { 
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&current=temperature_2m,weather_code&timezone=auto`); 
                    const data = await res.json(); 
                    const temp = data.current.temperature_2m;
                    const code = data.current.weather_code;
                    document.getElementById('header-weather-icon').textContent = code > 50 ? 'üåßÔ∏è' : (code > 3 ? '‚òÅÔ∏è' : '‚òÄÔ∏è'); 
                    document.getElementById('header-weather-temp').textContent = `${temp}¬∞C`; 
                    // Á©øË°£Âª∫Ë≠∞ÈÇèËºØ
                    let clothing = temp >= 25 ? 'üéΩ Áü≠Ë¢ñ' : (temp >= 20 ? 'üëï ËñÑÂ§ñÂ•ó' : (temp >= 15 ? 'üß• Â§ñÂ•ó' : (temp >= 10 ? 'üß• Â§ßË°£' : 'üß£ ÁæΩÁµ®')));
                    if ([51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99].includes(code)) clothing += ' ‚òîÂ∏∂Èõ®ÂÖ∑';
                    document.getElementById('header-clothing-advice').textContent = clothing;
                } catch (e) { }
            }

            function changeTrip(tripId) { 
                currentTripId = tripId; 
                const trip = tripData[tripId];
                if (trip && trip.startDate) {
                    const today = new Date(); today.setHours(0, 0, 0, 0);
                    const diffDays = Math.floor((today.getTime() - new Date(trip.startDate).getTime()) / (1000 * 60 * 60 * 24));
                    const calculatedDay = diffDays + 1;
                    currentDayId = (calculatedDay >= 1 && calculatedDay <= (trip.numDays || 1)) ? `Day ${calculatedDay}` : 'Day 1';
                } else currentDayId = 'Day 1';
                updateHeaderInfo(); renderDayTabs(); loadSchedules(currentTripId, currentDayId); checkAndCreateDefaultLists(tripId); 
            }

            function createTripCard(schedule) {
                const style = getCardStyle(schedule.Type), config = CATEGORY_COLORS[schedule.Type] || CATEGORY_COLORS['default'];
                const members = schedule.members || [];
                let amountTWD = 0, advancedPayerTotalTWD = 0, hasMemberAmounts = false, hasAdvancedPayer = false;
                members.forEach(m => {
                    const val = (m.method === 'card') ? (m.amount || 0) + (m.fee || 0) : (m.amount || 0) * (schedule.Rate || 1);
                    amountTWD += val;
                    if (m.isPayer) { hasAdvancedPayer = true; advancedPayerTotalTWD += val; }
                    if (m.amount > 0) hasMemberAmounts = true;
                });
                if (!hasMemberAmounts && schedule.Amount > 0) amountTWD = (schedule.Amount * (schedule.Rate || 1));
                const perPersonTWD = hasAdvancedPayer ? (advancedPayerTotalTWD / (members.length || 1)) : (hasMemberAmounts ? 0 : amountTWD / (members.length || 1));
                
                const card = document.createElement('div'); card.className = 'trip-card flex w-full mb-3 relative'; card.style.height = '100px'; 
                const visualWrapper = document.createElement('div'); visualWrapper.className = 'trip-card-visual-wrapper';
                const content = document.createElement('div'); content.className = 'swipe-item-content flex w-full bg-white relative items-stretch h-full z-10';
                content.innerHTML = `<div class="${config.bg} w-14 flex-none flex flex-col items-center justify-start gap-2 text-white py-3">
                        <span class="text-[10px] font-bold">${schedule.Time}</span><span class="text-2xl">${style.icon}</span><span class="text-[9px] opacity-90">${CATEGORY_NAMES[schedule.Type] || schedule.Type}</span>
                    </div>
                    <div class="flex-grow py-2 pl-2 pr-1 flex flex-col justify-start min-w-0">
                        <div class="flex justify-between items-start w-full">
                            <h3 class="text-xs font-bold text-[#4A4B4D] truncate mr-1"><a href="#" class="map-link hover:underline">${schedule.Location}</a></h3>
                            <div class="flex gap-1.5 ml-2">${members.map((m, i) => `<span class="${MEMBER_COLORS[i % MEMBER_COLORS.length]} text-[10px] font-bold">${typeof m === 'string' ? m : m.name}</span>`).join('')}</div>
                        </div>
                        <p class="text-[#888888] text-[10px] line-clamp-4 mt-0.5">${schedule.Ë™™Êòé || ''}</p>
                    </div>
                    <div class="card-right-col h-full flex flex-col">
                        <div class="card-static-actions"></div>
                        <div class="flex flex-col gap-1 mt-1">
                            <span class="text-[#8F9E8B] font-bold text-[10px]">üí∞ TW$${amountTWD.toFixed(0)}</span>
                            <span class="text-[#888888] font-bold text-[10px]">üë´ TW$${perPersonTWD.toFixed(0)}</span>
                        </div>
                    </div>`;
                
                // ÈõªËÖ¶ÁâàÊåâÈàïÁîüÊàê
                const staticActions = content.querySelector('.card-static-actions');
                const modBtn = document.createElement('button');
                modBtn.className = "bg-[#7E92A1] text-white rounded px-1.5 py-0.5 text-[9px] font-bold shadow-sm";
                modBtn.textContent = "‰øÆÊîπ";
                modBtn.onclick = (e) => { e.stopPropagation(); openEditScheduleModal(schedule); };
                const delBtn = document.createElement('button');
                delBtn.className = "bg-[#CB8572] text-white rounded px-1.5 py-0.5 text-[9px] font-bold shadow-sm";
                delBtn.textContent = "Âà™Èô§";
                delBtn.onclick = (e) => { e.stopPropagation(); deleteSchedule(schedule.id); };
                staticActions.appendChild(modBtn); staticActions.appendChild(delBtn);

                visualWrapper.appendChild(content); card.appendChild(visualWrapper);
                content.querySelector('.map-link').onclick = (e) => { e.preventDefault(); navigateToMap(schedule.Address || schedule.Location); };
                enableSwipeToDelete(content, null, 'schedule');
                return card;
            }

            const loadSchedules = function(tripId, dayId) {
                if (unsubscribeSchedule) unsubscribeSchedule();
                const container = document.getElementById('schedule-list-container'); container.innerHTML = '<div class="p-4 text-center text-xs">ËºâÂÖ•‰∏≠...</div>';
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Schedules`), where('dayId', '==', dayId), orderBy('Time'));
                unsubscribeSchedule = onSnapshot(q, (snapshot) => {
                    container.innerHTML = '';
                    const trip = tripData[currentTripId]; if (trip) updateHeaderDateWithDDay(getDateFromDayId(trip, dayId));
                    if (snapshot.empty) container.innerHTML = `<div class="p-4 text-center text-[#A9A9A9] text-xs">Ê≠§Êó•Êö´ÁÑ°Ë°åÁ®ã„ÄÇ</div>`;
                    else snapshot.forEach(doc => container.appendChild(createTripCard({ id: doc.id, ...doc.data() })));
                });
            };

            const loadTripList = async function() {
                if (unsubscribeTrips) unsubscribeTrips();
                unsubscribeTrips = onSnapshot(collection(db, `artifacts/${appId}/public/data/Trips`), (snapshot) => {
                    const select = document.getElementById('trip-select'); select.innerHTML = ''; tripData = {}; let firstId = null;
                    snapshot.forEach(doc => { const data = doc.data(); tripData[doc.id] = { id: doc.id, ...data }; const op = document.createElement('option'); op.value = doc.id; op.textContent = data.name || 'Êú™ÂëΩÂêç'; select.appendChild(op); if(!firstId) firstId = doc.id; });
                    if (snapshot.empty) { currentTripId = ''; return; }
                    currentTripId = firstId; select.value = currentTripId; changeTrip(currentTripId);
                });
            };

            function renderDayTabs() {
                const container = document.getElementById('day-tabs-container'); container.innerHTML = '';
                const trip = tripData[currentTripId]; if (!trip) return;
                for (let i = 0; i < (trip.numDays || 1); i++) {
                    const dId = `Day ${i + 1}`, btn = document.createElement('button'), isActive = dId === currentDayId;
                    btn.className = `px-3 py-1.5 text-xs font-bold rounded-lg transition flex-shrink-0 ${isActive ? 'bg-[#5F6368] text-white shadow-md' : 'bg-[#E4E6E8] text-[#5F6368]'}`;
                    btn.textContent = dId; btn.onclick = () => { currentDayId = dId; renderDayTabs(); loadSchedules(currentTripId, currentDayId); };
                    container.appendChild(btn);
                }
                const addBtn = document.createElement('button'); addBtn.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-[#7E92A1] text-white ml-2'; addBtn.textContent = '+';
                addBtn.onclick = async () => { await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`), { numDays: (tripData[currentTripId].numDays || 1) + 1 }); };
                container.appendChild(addBtn);
            }

            async function calculateCurrency() {
                const code = document.getElementById('bar-calc-currency').value, amt = parseFloat(document.getElementById('bar-calc-amount').value) || 0;
                const rate = await fetchExchangeRate(code);
                document.getElementById('rate-display-label').textContent = `ÂåØÁéá ‚âà ${code} ${rate > 0 ? (1/rate).toFixed(2) : '0.00'}`;
                document.getElementById('bar-calc-result').value = (amt === 0) ? '' : (amt * rate).toFixed(0);
            }

            function safeBind(id, event, handler) { const el = document.getElementById(id); if (el) el[event] = handler; }

            function enableSwipeToDelete(contentEl, actionEl, type) {
                if (window.innerWidth > 500) return; 
                let startX = 0, currentTranslate = 0, isSwiping = false;
                contentEl.addEventListener('touchstart', e => { startX = e.touches[0].clientX; isSwiping = false; }, {passive: true});
                contentEl.addEventListener('touchmove', e => { 
                    const diffX = e.touches[0].clientX - startX;
                    if (Math.abs(diffX) < 10) return;
                    if (diffX < 0) { isSwiping = true; currentTranslate = Math.max(diffX, -140); contentEl.style.transform = `translateX(${currentTranslate}px)`; } 
                    else if(currentTranslate < 0) { currentTranslate = Math.min(diffX - 140, 0); contentEl.style.transform = `translateX(${currentTranslate}px)`; } 
                }, {passive: true});
                contentEl.addEventListener('touchend', () => { contentEl.style.transform = (isSwiping && currentTranslate < -70) ? `translateX(-140px)` : `translateX(0)`; });
            }

            // --- Ê∏ÖÂñÆÈÇèËºØ ---
            async function checkAndCreateDefaultLists(tripId) { 
                try {
                    const col = collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Lists`); 
                    const snap = await getDocs(col); 
                    if (snap.empty) { 
                        const uid = auth.currentUser ? auth.currentUser.uid : null;
                        await addDoc(col, {name: 'Áâ©ÂìÅ', type: 'check', order: 1, items:[], uid: uid}); 
                        await addDoc(col, {name: 'Ë≥ºÁâ©', type: 'shopping', order: 2, items:[], uid: uid}); 
                    } 
                } catch(e) {}
            }

            function openListSettings(listData) {
                const oldModal = document.getElementById('list-settings-modal'); if(oldModal) oldModal.remove();
                const overlay = document.createElement('div'); overlay.id = 'list-settings-modal'; overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[110]'; 
                overlay.innerHTML = `<div class="bg-white rounded-xl shadow-2xl p-4 w-10/12 max-w-[280px] relative">
                    <h3 class="text-sm font-bold text-[#7E92A1] mb-3 text-center">Á∑®ËºØÊ∏ÖÂñÆ</h3>
                    <div class="mb-4"><label class="block text-[10px] text-gray-400 mb-1">Ê∏ÖÂñÆÂêçÁ®±</label><input type="text" id="setting-list-name" value="${listData.name}" class="w-full border-b border-[#7E92A1] text-center font-bold text-[#4A4B4D] py-1 text-lg"></div>
                    <div class="flex items-center justify-between mt-4 pt-2 border-t border-gray-100">
                        <button id="setting-del-btn" class="p-2 text-[#CB8572]">üóëÔ∏è</button>
                        <button id="setting-save-btn" class="px-4 py-1.5 bg-[#7E92A1] text-white text-xs font-bold rounded-lg shadow-sm">ÂÑ≤Â≠ò</button>
                    </div>
                    <button id="setting-close-btn" class="absolute top-2 right-3 text-gray-300 text-xl">√ó</button>
                </div>`;
                document.body.appendChild(overlay);
                document.getElementById('setting-close-btn').onclick = () => overlay.remove();
                document.getElementById('setting-save-btn').onclick = async () => {
                    const newName = document.getElementById('setting-list-name').value;
                    if (newName && newName.trim()) { await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`), { name: newName.trim() }); overlay.remove(); }
                };
                document.getElementById('setting-del-btn').onclick = async () => {
                    if(confirm(`Á¢∫ÂÆöÂà™Èô§„Äå${listData.name}„ÄçÔºü`)) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`)); currentListTabId = null; overlay.remove(); }
                };
            }

            function loadLists() {
                if(!currentTripId) return alert('Ë´ãÂÖàÂª∫Á´ãË®àÁï´'); 
                document.getElementById('lists-modal').classList.remove('hidden'); 
                if(unsubscribeLists) unsubscribeLists();
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), orderBy('order'));
                unsubscribeLists = onSnapshot(q, (snap) => {
                    const tabs = document.getElementById('list-tabs'), cont = document.getElementById('list-content'); 
                    tabs.innerHTML = ''; cont.innerHTML = ''; 
                    const lists = []; snap.forEach(d => lists.push({id: d.id, ...d.data()})); 
                    if(!lists.length) { checkAndCreateDefaultLists(currentTripId); return; }
                    if (!currentListTabId) currentListTabId = lists[0].id;
                    lists.forEach(l => { 
                        const t = document.createElement('div'), isActive = l.id === currentListTabId;
                        t.className = `cursor-pointer px-3 py-2 text-sm flex-shrink-0 transition-colors whitespace-nowrap select-none ${isActive ? 'border-b-2 border-[#7E92A1] text-[#7E92A1] font-bold' : 'text-[#A9A9A9] hover:text-[#5F6368]'}`;
                        t.textContent = l.name; t.onclick = () => { if (isActive) openListSettings(l); else { currentListTabId = l.id; loadLists(); } }; tabs.appendChild(t); 
                    });
                    const targetList = lists.find(l => l.id === currentListTabId); if (targetList) renderListItems(targetList, cont);
                });
            }

            function renderListItems(listData, container) {
                if (!listData) return;
                const modalBody = container.parentElement; 
                const oldFab = modalBody.querySelector('.list-fab-dynamic'); if(oldFab) oldFab.remove();
                const fab = document.createElement('div'); fab.className = 'list-fab-dynamic'; fab.textContent = 'Ôºã';
                fab.style.cssText = `position: absolute; bottom: 20px; right: 20px; width: 44px; height: 44px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.25); cursor: pointer; z-index: 50; transition: transform 0.1s;`;
                fab.onclick = async () => { 
                    const newItem = listData.type === 'check' ? { id: Date.now(), text: '', checkedLeft: false, checkedRight: false, isImportant: false } : { id: Date.now(), text: '', desc: '', location: '', imageUrl: '', isImportant: false }; 
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`), { items: [...listData.items, newItem] }); 
                };
                modalBody.appendChild(fab);

                const inner = document.createElement('div'); 
                inner.className = (listData.type === 'check') ? 'grid grid-cols-2 gap-2 pb-16 px-1 mt-2' : 'space-y-2 pb-16 px-1 mt-2'; 
                const sortedItems = [...listData.items].map((item, index) => ({...item, _origIdx: index})).sort((a, b) => (!!b.isImportant === !!a.isImportant) ? 0 : (b.isImportant ? 1 : -1));

                sortedItems.forEach((item) => {
                    const realIdx = item._origIdx;
                    const wrap = document.createElement('div'); wrap.className = 'swipe-item-container'; 
                    const bg = document.createElement('div'); bg.className = 'swipe-item-delete-bg'; bg.innerHTML = `<button class="px-2 py-1 h-full text-xs font-bold bg-[#CB8572] text-white">Âà™Èô§</button>`;
                    const c = document.createElement('div'); c.className = 'swipe-item-content bg-white relative';
                    const starHtml = `<button class="star-btn flex-shrink-0 w-5 h-full flex items-center justify-center text-[15px] ${item.isImportant ? 'text-yellow-400' : 'text-gray-200'}">${item.isImportant ? '‚òÖ' : '‚òÜ'}</button>`;

                    if (listData.type === 'check') {
                        c.style.cssText = "display:flex; align-items:center; gap:2px; padding:6px 2px; border:1px solid #f0f0f0; border-radius:8px;";
                        c.innerHTML = `${starHtml}<div class="flex gap-1 ml-1"><input type="checkbox" class="check-left w-3.5 h-3.5" ${item.checkedLeft?'checked':''}> <input type="checkbox" class="check-right w-3.5 h-3.5" ${item.checkedRight?'checked':''}></div><input type="text" class="check-text flex-grow border-none text-[13px] font-medium p-0 focus:ring-0 bg-transparent" value="${item.text||''}" placeholder="Áâ©ÂìÅ">`;
                        c.querySelector('.star-btn').onclick = () => updateListItem(listData, realIdx, {isImportant: !item.isImportant});
                        c.querySelector('.check-left').onchange = (e) => updateListItem(listData, realIdx, {checkedLeft: e.target.checked});
                        c.querySelector('.check-right').onchange = (e) => updateListItem(listData, realIdx, {checkedRight: e.target.checked});
                        c.querySelector('.check-text').onchange = (e) => updateListItem(listData, realIdx, {text: e.target.value});
                    } else {
                        c.className += ' p-1.5 border border-gray-100 rounded-lg shadow-sm'; c.style.display = 'grid'; c.style.gridTemplateColumns = '24px 50px 1fr 80px 30px'; c.style.gap = '4px'; c.style.alignItems = 'center'; 
                        const imgBoxHtml = `<div class="shopping-img-box">${item.imageUrl ? `<img src="${item.imageUrl}">` : `<span class="text-gray-300">üì∑</span>`}</div>`;
                        c.innerHTML = `${starHtml}${imgBoxHtml}<div class="flex flex-col justify-center"><input type="text" class="item-name font-bold text-[13px] border-none p-0 focus:ring-0 bg-transparent" value="${item.text||''}" placeholder="ÂìÅÂêç"><textarea class="item-desc text-[11px] text-gray-400 border-none p-0 focus:ring-0 resize-none h-6 bg-transparent" placeholder="ÂÇôË®ª">${item.desc||''}</textarea></div><textarea class="item-loc text-[10px] border border-gray-50 bg-gray-50 rounded p-1 h-12 focus:ring-0" placeholder="Âú∞Èªû">${item.location||''}</textarea><div class="desktop-del-btn">√ó</div>`;
                        
                        c.querySelector('.star-btn').onclick = () => updateListItem(listData, realIdx, {isImportant: !item.isImportant});
                        c.querySelector('.item-name').onchange = (e) => updateListItem(listData, realIdx, {text: e.target.value});
                        c.querySelector('.item-desc').onchange = (e) => updateListItem(listData, realIdx, {desc: e.target.value});
                        c.querySelector('.item-loc').onchange = (e) => updateListItem(listData, realIdx, {location: e.target.value});
                        c.querySelector('.desktop-del-btn').onclick = () => deleteListItem(listData, realIdx);
                        
                        const fileInp = document.createElement('input'); fileInp.type='file'; fileInp.accept='image/*'; fileInp.style.display='none';
                        c.querySelector('.shopping-img-box').onclick = () => { if(item.imageUrl) { document.getElementById('zoom-img').src=item.imageUrl; document.getElementById('image-zoom-modal').style.display='flex'; } else fileInp.click(); };
                        fileInp.onchange = (e) => {
                            if(!e.target.files[0]) return;
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                const img = new Image();
                                img.onload = () => {
                                    const canvas = document.createElement('canvas'); const scale = 400 / img.width; canvas.width = 400; canvas.height = img.height * scale;
                                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                                    updateListItem(listData, realIdx, {imageUrl: canvas.toDataURL("image/jpeg", 0.7)});
                                };
                                img.src = ev.target.result;
                            };
                            reader.readAsDataURL(e.target.files[0]);
                        };
                        c.appendChild(fileInp);
                    }
                    wrap.appendChild(bg); wrap.appendChild(c); inner.appendChild(wrap);
                    enableSwipeToDelete(c, bg, 'list');
                    bg.querySelector('button').onclick = () => deleteListItem(listData, realIdx);
                });
                container.appendChild(inner);
            }

            async function updateListItem(l, i, chg) { const ni = [...l.items]; ni[i] = {...ni[i], ...chg}; await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${l.id}`), {items:ni}); }
            async function deleteListItem(l, i) { if(!confirm('Âà™Èô§Ê≠§Áâ©ÂìÅ?')) return; const ni=l.items.filter((_,x)=>x!==i); await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${l.id}`), {items:ni}); }

            async function loadExpenseSummary() {
                if(!currentTripId) return alert('Ë´ãÂÖàÂª∫Á´ãË®àÁï´'); 
                document.getElementById('split-expense-modal').classList.remove('hidden'); 
                const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
                let total=0, types={}, mems={};
                snap.forEach(d => {
                    const da = d.data(); const rate = da.Rate || 1, members = da.members || [];
                    if (members.length === 0) return;
                    let effectiveTotal = 0;
                    members.forEach(m => {
                        const val = (m.method === 'card') ? (m.amount || 0) + (m.fee || 0) : (m.amount || 0) * rate;
                        if (m.isPayer) effectiveTotal += val;
                    });
                    if (effectiveTotal === 0 && da.Amount > 0) effectiveTotal = da.Amount * rate;
                    if (effectiveTotal <= 0) return;
                    total += effectiveTotal; types[da.Type] = (types[da.Type] || 0) + effectiveTotal;
                    const debtPerPerson = effectiveTotal / members.length;
                    members.forEach(m => {
                        const name = typeof m === 'string' ? m : m.name;
                        if(!mems[name]) mems[name] = { total: 0 };
                        mems[name].total += debtPerPerson;
                    });
                });
                const modal = document.getElementById('split-expense-modal');
                modal.innerHTML = `<div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]">
                    <h3 class="text-sm font-bold mb-2 flex justify-between items-center text-[#4A4B4D]">Ëä±Ë≤ª<button id="split-expense-close-btn" class="text-[#A9A9A9] text-xl">√ó</button></h3>
                    <div class="flex-shrink-0 mb-2 bg-[#F9F9F9] p-2 rounded border border-[#E0E0E0]">
                        <div class="flex justify-between items-end mb-1 border-b border-[#E0E0E0] pb-0.5"><span class="text-[#5F6368] font-medium text-xs">Á∏ΩËä±Ë≤ª</span><span class="text-sm font-extrabold text-[#4A4B4D]">TW$ ${total.toFixed(0)}</span></div>
                        <div class="h-32 w-full relative flex justify-center items-center"><canvas id="expense-chart"></canvas></div>
                    </div>
                    <div class="overflow-y-auto flex-grow mb-1 pr-1" id="expense-member-list"></div>
                </div>`;
                const ctx = modal.querySelector('#expense-chart').getContext('2d');
                new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(types), datasets: [{ data: Object.values(types), backgroundColor: Object.keys(types).map(k => (CATEGORY_COLORS[k]||CATEGORY_COLORS.default).hex), borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                const list = modal.querySelector('#expense-member-list');
                Object.keys(mems).forEach(n => { list.innerHTML += `<div class="flex justify-between py-1 text-xs border-b border-gray-50"><span>${n}</span><span>$${mems[n].total.toFixed(0)}</span></div>`; });
                modal.querySelector('#split-expense-close-btn').onclick = () => modal.classList.add('hidden');
            }

            async function deleteSchedule(id) { if(!confirm('Á¢∫ÂÆöÂà™Èô§?')) return; await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`, id)); }

            function openEditScheduleModal(s) {
                editingScheduleId = s.id;
                const modal = document.getElementById('add-schedule-modal');
                modal.classList.remove('hidden');
                modal.querySelector('h3 span').textContent = s.Location || 'Á∑®ËºØË°åÁ®ã';
                document.getElementById('form-date').value = s.Date || '';
                document.getElementById('form-time').value = s.Time || '';
                document.getElementById('form-type').value = s.Type || 'location';
                document.getElementById('form-location').value = s.Location || '';
                document.getElementById('form-address').value = s.Address || '';
                document.getElementById('form-details').value = s.Ë™™Êòé || '';
                document.getElementById('form-must-go').checked = s.MustGo || false;
                document.getElementById('form-set-alarm').checked = s.SetAlarm || false;
                
                const c = document.getElementById('form-members-container'); c.innerHTML = '';
                (s.members || []).forEach(m => addMemberInput(typeof m === 'string' ? m : m.name, m.amount, m.isPayer, m.method, m.fee));
                updateModalTotalTWD();
                document.getElementById('modal-delete-btn').classList.remove('hidden');
            }

            function initApp() {
                document.addEventListener('DOMContentLoaded', async () => {
                    const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); 
                    await signInAnonymously(auth);
                    
                    const addScheduleModalContent = document.querySelector('#add-schedule-modal > div');
                    addScheduleModalContent.innerHTML = `<h3 class="text-base font-bold mb-2 pr-8 truncate" id="add-schedule-modal-title"><span>Êñ∞Â¢ûË°åÁ®ã</span></h3><button id="modal-close-btn" class="absolute top-3 right-3 text-[#A9A9A9] text-2xl">√ó</button>
                        <form id="add-schedule-form" class="space-y-2">
                            <div class="grid grid-cols-3 gap-1.5"> 
                                <div><label class="block compact-label text-center">Êó•Êúü</label><input type="date" id="form-date" class="compact-input w-full rounded border text-[10px]"></div> 
                                <div><label class="block compact-label text-center">ÊôÇÈñì</label><input type="time" id="form-time" class="compact-input w-full rounded border text-[10px]"></div>
                                <div><label class="block compact-label text-center">È°ûÂûã</label><select id="form-type" class="compact-input w-full rounded border text-[10px]"><option value="location">üìç ÊôØÈªû</option><option value="restaurant">üçΩÔ∏è È§êÂª≥</option><option value="coffee">‚òï ÂíñÂï°</option><option value="accommodation">üõèÔ∏è ‰ΩèÂÆø</option><option value="‰∫§ÈÄö">üöó ‰∫§ÈÄö</option><option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option></select></div>
                            </div>
                            <div class="flex gap-2">
                                <div class="flex-grow"><label class="block compact-label">Âú∞Èªû</label><input type="text" id="form-location" class="compact-input w-full rounded border" placeholder="Âú∞ÈªûÂêçÁ®±"></div>
                                <div class="flex gap-1 items-center"><div class="flex flex-col items-center"><span class="text-[9px]">ÂøÖÂéª</span><input type="checkbox" id="form-must-go" class="w-3 h-3"></div><div class="flex flex-col items-center"><span class="text-[9px]">È¨ßÈêò</span><input type="checkbox" id="form-set-alarm" class="w-3 h-3"></div></div>
                            </div>
                            <div><label class="block compact-label">Âú∞ÂùÄ</label><input type="text" id="form-address" class="compact-input w-full rounded border" placeholder="Âú∞ÂùÄÊàñÈÄ£Áµê"></div>
                            <div><textarea id="form-details" rows="3" class="compact-input w-full rounded border !h-auto" placeholder="ÂÇôË®ª..."></textarea></div>
                            <div class="bg-gray-50 p-2 rounded border"><div class="flex items-center mb-1 gap-2"><label class="compact-label">ÊàêÂì°</label><button type="button" id="add-member-btn" class="text-[#7E92A1] text-xs font-bold px-1">Ôºã</button></div><div id="form-members-container" class="space-y-1"></div><div class="grid grid-cols-[1fr_20px_1fr] gap-2 items-center mt-2 border-t pt-2"><div class="flex items-center gap-1"><label id="form-currency-label" class="text-[10px] font-bold text-[#7E92A1] w-8">KRW</label><input type="number" id="form-amount" readonly class="w-full p-1 border rounded text-right text-[11px] bg-gray-100"></div><div class="text-center text-xs font-bold">=</div><div class="flex items-center gap-1"><span class="text-[10px] font-bold text-[#A9A9A9] w-8">TW</span><input type="number" id="form-amount-twd" readonly class="w-full p-1 border bg-gray-100 rounded text-right text-[11px] font-bold text-[#7E92A1]"></div></div></div>
                            <div class="flex justify-between items-center pt-2"><button type="button" id="modal-delete-btn" class="px-3 py-1 text-white bg-[#CB8572] rounded text-xs font-bold hidden">Âà™Èô§</button><button type="button" id="modal-save-btn" class="px-3 py-1 text-white bg-[#7E92A1] rounded text-xs font-bold ml-auto shadow-sm">ÂÑ≤Â≠ò</button></div>
                        </form>`;

                    loadTripList();
                    safeBind('trip-select', 'onchange', (e) => changeTrip(e.target.value));
                    safeBind('center-add-btn', 'onclick', () => { 
                        if(!currentTripId) return alert('Ë´ãÂÖàÂª∫Á´ãË®àÁï´'); 
                        document.getElementById('add-schedule-modal').classList.remove('hidden'); 
                        document.getElementById('add-schedule-form').reset(); editingScheduleId=null;
                        document.getElementById('add-schedule-modal-title').querySelector('span').textContent = 'Êñ∞Â¢ûË°åÁ®ã';
                        document.getElementById('modal-delete-btn').classList.add('hidden');
                        const t=tripData[currentTripId], d = getDateFromDayId(t, currentDayId);
                        if(d) document.getElementById('form-date').value=d.toISOString().split('T')[0]; 
                        document.getElementById('form-members-container').innerHTML=''; (t.members||[]).forEach(n=>addMemberInput(n)); 
                    });
                    safeBind('modal-close-btn', 'onclick', () => document.getElementById('add-schedule-modal').classList.add('hidden'));
                    safeBind('modal-save-btn', 'onclick', submitSchedule);
                    safeBind('btn-lists', 'onclick', loadLists);
                    safeBind('lists-modal-close-btn', 'onclick', () => document.getElementById('lists-modal').classList.add('hidden'));
                    safeBind('split-expense-btn', 'onclick', loadExpenseSummary);
                    safeBind('image-zoom-modal', 'onclick', () => document.getElementById('image-zoom-modal').classList.add('hidden'));
                    safeBind('add-member-btn', 'onclick', () => addMemberInput());
                });
            }
            return { initApp };
        })();
        window.App.initApp();
    </script>
</body>
</html>
