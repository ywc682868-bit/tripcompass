<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Trip Compass</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    html {
        scroll-snap-type: y mandatory;
        scroll-padding-top: 180px;
        scroll-behavior: smooth;
    }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* --- å®¹å™¨èˆ‡ä½ˆå¸ƒå±€ --- */
    #app-container {
        max-width: 500px;
        margin: 0 auto;
        min-height: 100vh;
        background-color: white;
        padding-top: 0px; 
        padding-bottom: 140px;
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    #schedule-list-container {
        padding-top: 180px; 
        padding-bottom: 85vh; 
        margin-top: 0; 
        position: relative; 
        z-index: 1; 
    }
    #schedule-list-container::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 600px; 
        background-color: white;
        z-index: -2; 
    }    
    
    /* --- è¡Œç¨‹å¡ç‰‡ (Trip Card) --- */
    .trip-card { 
        width: 100%; 
        margin-bottom: 2rem; 
        position: relative; 
        height: 100px; 
        display: flex; 
        z-index: 0;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        scroll-margin-top: 180px;
    }

    #schedule-list-container .trip-card:first-child {
        margin-top: 10px; 
    }

    .trip-card::before {
        content: '';
        position: absolute;
        left: 28px; 
        top: -6px;         
        bottom: -6px;         
        width: 2px;
        background-color: #9C8B74; 
        z-index: -1; 
        transform: translateX(-50%);
    }
    
    .trip-card:first-child::before { 
        top: -60px; 
        bottom: -6px; 
        height: auto; 
    }
    .trip-card:last-child::before { bottom: auto; height: 100%; }

    .trip-card-visual-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 0.75rem; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); 
        background-color: white; 
        z-index: 10; 
    }

    header { 
        position: fixed;
        top: 0; 
        left: 0;
        right: 0;
        width: 100%; 
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        background-color: #ffffff;
        z-index: 50; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    #header-content-wrapper {
        padding-top: calc(15px + env(safe-area-inset-top)); 
        padding-bottom: 4px; 
        padding-left: 12px; 
        padding-right: 12px;
    }
    #trip-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%237E92A1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right center; background-repeat: no-repeat; background-size: 1.25em 1.25em; -webkit-appearance: none; appearance: none; background-color: transparent; font-weight: 800; color: #4A4B4D; border: none; padding-right: 1.5rem; cursor: pointer; }
    #trip-select:focus { outline: none; }
    
    #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem 0.2rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
    .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 18px; font-weight: 300; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: transform 0.1s; }
    .prominent-integrated-btn:active { transform: scale(0.95); }
    #rate-display-label { font-size: 0.85rem; font-weight: bold; color: #7E92A1; line-height: 20px; }
    #bar-calc-result { font-size: 0.7rem; font-weight: bold; color: #7E92A1; }

    .swipe-item-container { position: relative; overflow: hidden; border-radius: 0.375rem; margin-bottom: 0.5rem; touch-action: pan-y; }
    .swipe-item-delete-bg { position: absolute; top: 0; bottom: 0; right: 0; width: 140px; display: flex; align-items: center; justify-content: flex-end; z-index: 0; border-radius: 0.75rem; overflow: hidden; }
    .swipe-item-content { position: relative; z-index: 10; background-color: white; transition: transform 0.2s ease-out; transform: translateX(0); width: 100%; display: flex; align-items: stretch; border-radius: 0.75rem; overflow: hidden; }
    
    .card-right-col { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 8px; width: 95px; min-width: 95px; max-width: 95px; flex: 0 0 95px; border-left: none; padding-left: 6px; padding-bottom: 0.25rem; padding-top: 12px; position: relative; }
    .card-right-col::before { content: ''; position: absolute; left: 0; top: 8%; bottom: 8%; width: 1px; background-color: #C0C0C0; }
    .card-static-actions { display: none !important; width: 100%; justify-content: flex-start !important; gap: 2px; padding: 0; margin: 0; }
    
    @media (min-width: 501px) {
        .swipe-item-delete-bg { display: none !important; }
        .trip-card .swipe-item-content { cursor: pointer; } 
        .card-static-actions { display: flex !important; } 
        .desktop-del-btn { display: block !important; }
    }
    @media (max-width: 500px) {
        html { scroll-padding-top: 180px; }
        #schedule-list-container { padding-top: 180px; }
        .desktop-del-btn { display: none !important; } 
    }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(95, 99, 104, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; line-height: 28px; color: #5F6368; border-color: #E0E0E0; border-width: 1px; box-sizing: border-box; }
    .compact-input:focus { border-color: #7E92A1; outline: none; ring: 1px solid #7E92A1; }
    .compact-label { font-size: 0.7rem; color: #7E92A1; font-weight: 700; margin-bottom: 0; }
    .shopping-img-box { width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; position: relative; }
</style>
</head>

<body>
    <div id="app-container">
        <header>
            <div id="header-content-wrapper">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col flex-grow min-w-0 mr-2">
                        <div class="flex items-center w-full mb-0.5">
                              <button id="settings-btn" class="p-1 mr-0.5 text-[#888888]">ğŸ“…</button>
                              <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
                              <button id="new-trip-btn" class="px-2 py-1 bg-[#7E92A1] text-white text-xs font-semibold rounded hidden">+ æ–°å¢</button>
                        </div>
                        <div class="flex items-center space-x-1 text-[#888888] ml-1 mb-1.5">
                              <span class="font-bold text-xs">ğŸ‘«</span>
                              <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
                        </div>
                        <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
                        <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
                    </div>
                    <div id="weather-info-container" class="flex flex-col items-end text-[#888888] cursor-pointer flex-shrink-0 gap-1">
                          <div id="header-weather-icon" class="text-4xl"></div>
                          <span id="header-weather-temp" class="text-sm font-bold"></span>
                          <span id="header-location-name" class="text-xs font-bold"></span>
                          <span id="header-clothing-advice" class="text-xs font-bold text-[#CB8572]"></span>
                    </div>
                </div>
            </div>
        </header>
        <div id="schedule-list-container" class="px-3 pb-4"></div>
    </div>

    <div id="combined-bottom-bar">
        <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5">
            <div id="rate-display-container" class="flex items-center justify-center border-r border-gray-100 w-1/2">
                <span id="rate-display-label">åŒ¯ç‡ â‰ˆ ...</span> 
            </div>
            <div class="flex items-center justify-start gap-0.5 pl-3 w-1/2">
                <select id="bar-calc-currency" class="bg-gray-50 border rounded p-0.5 text-[10px] h-6 w-10 text-center appearance-none"><option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="CNY">CNY</option><option value="GBP">GBP</option></select>
                <input type="number" id="bar-calc-amount" class="w-20 h-6 text-[10px] border rounded text-center">
                <span class="text-[1.1rem] font-bold text-[#A9A9A9]">=</span>
                <span class="text-[0.7rem] font-bold text-[#7E92A1]">TWD</span>
                <input type="text" id="bar-calc-result" readonly value="" class="w-12 h-6 bg-transparent text-[#7E92A1] font-extrabold focus:outline-none">
            </div>
        </div>
        <div class="flex justify-between items-center w-full px-2 py-1.5">
             <button id="btn-lists" class="flex-1 flex items-center justify-center gap-2 text-[#888888]"><span class="text-xl">ğŸ“</span><span class="text-[12px] font-bold">æ¸…å–®</span></button>
             <button id="center-add-btn" class="prominent-integrated-btn shadow-md">ï¼‹</button>
             <button id="split-expense-btn" class="flex-1 flex items-center justify-center gap-2 text-[#888888]"><span class="text-xl">ğŸ’°</span><span class="text-[12px] font-bold">èŠ±è²»</span></button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto relative"></div></div>
    <div id="lists-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm max-h-[80vh] flex flex-col relative"><h3 class="text-base font-bold mb-2 flex justify-between items-center text-[#4A4B4D]">æ¸…å–®<button id="lists-modal-close-btn" class="text-xl">Ã—</button></h3><div id="list-tabs" class="flex gap-1 border-b mb-2 overflow-x-auto no-scrollbar"></div><div id="list-content" class="flex-grow overflow-y-auto relative"></div></div></div>
    <div id="split-expense-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]"></div></div>
    <div id="settings-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>
    <div id="image-zoom-modal" class="modal-overlay hidden z-[150] bg-black/80"><img id="zoom-img" class="max-w-[95%] max-h-[90%] object-contain"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.App = (function() {
            const appId = 'my-trip-app';
            const firebaseConfig = { apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28", authDomain: "mytravelplanner-36283.firebaseapp.com", projectId: "mytravelplanner-36283", storageBucket: "mytravelplanner-36283.firebasestorage.app", messagingSenderId: "86504733738", appId: "1:86504733738:web:5167a6a795eb206dfed753" };            
            const COUNTRY_CONFIG = { 'USA': { name: 'ç¾åœ‹', currency: 'USD', localName: 'New York', lat: 40.71, lon: -74.00 }, 'JP': { name: 'æ—¥æœ¬', currency: 'JPY', localName: 'æ±äº¬', lat: 35.68, lon: 139.76 }, 'KR': { name: 'éŸ“åœ‹', currency: 'KRW', localName: 'ì„œìš¸', lat: 37.56, lon: 126.97 }, 'UK': { name: 'è‹±åœ‹', currency: 'GBP', localName: 'London', lat: 51.50, lon: -0.12 }, 'TW': { name: 'å°ç£', currency: 'TWD', localName: 'å°åŒ—', lat: 25.03, lon: 121.56 } };
            const CATEGORY_COLORS = { 'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, 'äº¤é€š': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' }, 'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
            const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];
            const CATEGORY_NAMES = { 'location': 'æ™¯é»', 'restaurant': 'é¤å»³', 'coffee': 'å’–å•¡å»³', 'äº¤é€š': 'äº¤é€š', 'shopping': 'è³¼ç‰©', 'accommodation': 'ä½å®¿', 'default': 'æœªåˆ†é¡' };

            let db, auth, currentUser, currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {}, currentTripRate = 1, currentListTabId = null, expenseChart = null;
            let unsubscribeSchedule = null, unsubscribeTrips = null, unsubscribeLists = null;

            function formatDateForHeader(date) { return `${date.getFullYear().toString().slice(-2)}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getDate().toString().padStart(2,'0')}`; }
            function dateDiffInDays(date2, date1) { return Math.ceil(Math.abs(date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24)); }
            function getDateFromDayId(trip, dayId) { if (!trip || !trip.startDate) return null; const d = new Date(trip.startDate); d.setDate(d.getDate() + (parseInt(dayId.replace('Day ', '')) - 1)); return d; }
            async function fetchExchangeRate(base) { try { const r = await fetch(`https://open.er-api.com/v6/latest/${base}`); const d = await r.json(); return d.rates.TWD || 1; } catch (e) { return 1; } }

            // --- ä¿®å¾©ï¼šæ ¸å¿ƒè¦–çª—é–‹å•Ÿå‡½æ•¸ ---
            async function loadLists() {
                if(!currentTripId) return; 
                document.getElementById('lists-modal').style.display = 'flex';
                if(unsubscribeLists) unsubscribeLists();
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), orderBy('order'));
                unsubscribeLists = onSnapshot(q, (snap) => {
                    const tabs = document.getElementById('list-tabs'); const cont = document.getElementById('list-content');
                    tabs.innerHTML = ''; cont.innerHTML = '';
                    const lists = []; snap.forEach(d => lists.push({id: d.id, ...d.data()}));
                    if(!currentListTabId && lists.length) currentListTabId = lists[0].id;
                    lists.forEach(l => {
                        const t = document.createElement('div'); t.className = `cursor-pointer px-3 py-2 text-sm ${l.id===currentListTabId?'border-b-2 border-[#7E92A1] text-[#7E92A1] font-bold':'text-[#A9A9A9]'}`;
                        t.textContent = l.name; t.onclick = () => { currentListTabId = l.id; loadLists(); }; tabs.appendChild(t);
                    });
                    const target = lists.find(l => l.id === currentListTabId);
                    if(target) renderListItems(target, cont);
                });
            }

            async function loadExpenseSummary() {
                if(!currentTripId) return; 
                document.getElementById('split-expense-modal').style.display = 'flex';
                const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
                let total=0, types={}, balances={};
                snap.forEach(d => {
                    const da = d.data(); const rate = da.Rate || 1; const amt = (da.Amount || 0) * rate;
                    total += amt; types[da.Type] = (types[da.Type] || 0) + amt;
                });
                const l = document.getElementById('expense-member-list');
                l.innerHTML = `<div class="p-4 text-center text-xs">ç¸½èŠ±è²»: TWD$${total.toFixed(0)}</div>`;
                // æ­¤è™•ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›ç¹ªåœ–é‚è¼¯èˆ‡æˆå“¡åˆ—è¡¨éœ€æ ¹æ“šå…·é«”éœ€æ±‚å®Œæ•´å¯¦ä½œ
            }

            function renderListItems(list, cont) { cont.innerHTML = `<div class="p-4 text-xs text-center">${list.name} å…§å®¹è¼‰å…¥ä¸­...</div>`; }

            function changeTrip(id) { currentTripId = id; loadSchedules(id, currentDayId); }
            function loadSchedules(tripId, dayId) { /* è¼‰å…¥è¡Œç¨‹é‚è¼¯ */ }
            function safeBind(id, event, handler) { const el = document.getElementById(id); if (el) el[event] = handler; }

            async function calculateCurrency() {
                const code = document.getElementById('bar-calc-currency').value; const amt = parseFloat(document.getElementById('bar-calc-amount').value) || 0;
                const rate = await fetchExchangeRate(code);
                document.getElementById('bar-calc-result').value = amt ? (amt * rate).toFixed(0) : '';
            }

            function initApp() {
                document.addEventListener('DOMContentLoaded', async () => {
                    const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); 
                    await signInAnonymously(auth);
                    
                    // åˆå§‹åŒ– Modal å…§å®¹
                    document.querySelector('#split-expense-modal').innerHTML = '<div class="bg-white rounded-xl p-4 w-full h-full relative"><h3 class="font-bold mb-2">è²»ç”¨åˆ†æ<button id="expense-close" class="absolute right-3 top-3">Ã—</button></h3><div id="expense-member-list"></div></div>';
                    safeBind('expense-close', 'onclick', () => document.getElementById('split-expense-modal').style.display='none');

                    // ç¶å®šä¸»æŒ‰éˆ•äº‹ä»¶
                    safeBind('btn-lists', 'onclick', loadLists);
                    safeBind('split-expense-btn', 'onclick', loadExpenseSummary);
                    safeBind('lists-modal-close-btn', 'onclick', () => document.getElementById('lists-modal').style.display='none');
                    
                    // å…¶ä»–åŠŸèƒ½ç¶å®š
                    safeBind('bar-calc-currency', 'onchange', calculateCurrency);
                    safeBind('bar-calc-amount', 'oninput', calculateCurrency);
                    
                    // è¼‰å…¥è¡Œç¨‹åˆ—è¡¨
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/Trips`), (snap) => {
                        const select = document.getElementById('trip-select'); select.innerHTML = '';
                        snap.forEach(doc => {
                            const data = doc.data(); const op = document.createElement('option'); op.value = doc.id; op.textContent = data.name; select.appendChild(op);
                            if(!currentTripId) currentTripId = doc.id;
                        });
                        if(currentTripId) changeTrip(currentTripId);
                    });
                });
            }
            return { initApp };
        })();
        window.App.initApp();
    </script>
</body>
</html>
