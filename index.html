<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
Â  Â  <meta name="mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  Â  <title>Trip Compass</title>
Â  Â  <link rel="icon" type="image/png" href="icon.png">
Â  Â  <link rel="apple-touch-icon" href="icon.png">
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  Â  <style>
Â  Â  /* --- å…¨åŸŸè¨­å®š --- */
Â  Â  html {
Â  Â  Â  Â  scroll-snap-type: y mandatory;
Â  Â  Â  Â  scroll-padding-top: 180px;
Â  Â  Â  Â  scroll-behavior: smooth;
Â  Â  }
Â  Â  body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
Â  Â  .no-scrollbar::-webkit-scrollbar { display: none; }
Â  Â  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
Â  Â Â 
Â  Â  /* --- å®¹å™¨èˆ‡ä½ˆå±€ --- */
Â  Â  #app-container {
Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  padding-top: 0px;Â 
Â  Â  Â  Â  padding-bottom: 140px;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  box-shadow: 0 0 10px rgba(0,0,0,0.05);
Â  Â  }
Â  Â  #schedule-list-container {
Â  Â  Â  Â  padding-top: 180px;Â 
Â  Â  Â  Â  padding-bottom: 85vh;Â 
Â  Â  Â  Â  margin-top: 0;Â 
Â  Â  Â  Â  position: relative;Â 
Â  Â  Â  Â  z-index: 1;Â 
Â  Â  }
Â  Â  #schedule-list-container::before {
Â  Â  Â  Â  content: '';
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 0; left: 0; right: 0;
Â  Â  Â  Â  height: 600px;Â 
Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  z-index: -2;Â 
Â  Â  } Â  Â 
Â  Â Â 
Â  Â  /* --- è¡Œç¨‹å¡ç‰‡ (Trip Card) --- */
Â  Â  .trip-card {Â 
Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  margin-bottom: 2rem;Â 
Â  Â  Â  Â  position: relative;Â 
Â  Â  Â  Â  height: 100px;Â 
Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  z-index: 0;
Â  Â  Â  Â  scroll-snap-align: start;
Â  Â  Â  Â  scroll-snap-stop: always;
Â  Â  Â  Â  scroll-margin-top: 180px;
Â  Â  }

Â  Â  #schedule-list-container .trip-card:first-child {
Â  Â  Â  Â  margin-top: 10px;Â 
Â  Â  }

Â  Â  .trip-card::before {
Â  Â  Â  Â  content: '';
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  left: 28px;Â 
Â  Â  Â  Â  top: -6px; Â  Â  Â  Â 
Â  Â  Â  Â  bottom: -6px; Â  Â  Â  Â 
Â  Â  Â  Â  width: 2px;
Â  Â  Â  Â  background-color: #9C8B74;Â 
Â  Â  Â  Â  z-index: -1;Â 
Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  }
Â  Â Â 
Â  Â  .trip-card:first-child::before {Â 
Â  Â  Â  Â  top: -60px;Â 
Â  Â  Â  Â  bottom: -6px;Â 
Â  Â  Â  Â  height: auto;Â 
Â  Â  }
Â  Â  .trip-card:last-child::before { bottom: auto; height: 100%; }

Â  Â  /* å¡ç‰‡è¦–è¦ºå®¹å™¨ */
Â  Â  .trip-card-visual-wrapper {
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  border-radius: 0.75rem;Â 
Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);Â 
Â  Â  Â  Â  background-color: white;Â 
Â  Â  Â  Â  z-index: 10;Â 
Â  Â  }

Â  Â  /* --- Header å›ºå®šå€ --- */
Â  Â  header {Â 
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 0;Â 
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  margin-right: auto;
Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  z-index: 50;Â 
Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
Â  Â  }
Â  Â  #header-content-wrapper {
Â  Â  Â  Â  padding-top: calc(15px + env(safe-area-inset-top));Â 
Â  Â  Â  Â  padding-bottom: 4px;Â 
Â  Â  Â  Â  padding-left: 12px;Â 
Â  Â  Â  Â  padding-right: 12px;
Â  Â  }
Â  Â  #trip-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%237E92A1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right center; background-repeat: no-repeat; background-size: 1.25em 1.25em; -webkit-appearance: none; appearance: none; background-color: transparent; font-weight: 800; color: #4A4B4D; border: none; padding-right: 1.5rem; cursor: pointer; }
Â  Â  #trip-select:focus { outline: none; }
Â  Â  #header-day-date-container { padding-bottom: 0px; margin-top: 2px; margin-bottom: 1px; line-height: 1.2; }

Â  Â  /* --- Footer (åº•éƒ¨å·¥å…·åˆ—) --- */
Â  Â  #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem 0.2rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
Â  Â  .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 18px; font-weight: 300; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: transform 0.1s; }
Â  Â  .prominent-integrated-btn:active { transform: scale(0.95); }
Â  Â  #rate-display-label { font-size: 0.85rem; font-weight: bold; color: #7E92A1; line-height: 20px; }
Â  Â  #bar-calc-result { font-size: 0.7rem; font-weight: bold; color: #7E92A1; }

Â  Â  .swipe-item-container { position: relative; overflow: hidden; border-radius: 0.375rem; margin-bottom: 0.5rem; touch-action: pan-y; }
Â  Â Â 
Â  Â  /* æ»‘å‹•æŒ‰éˆ•å±¤ï¼šåŠ ä¸Š overflow hidden ç¢ºä¿åœ“è§’ */
Â  Â  .swipe-item-delete-bg {Â 
Â  Â  Â  Â  position: absolute; top: 0; bottom: 0; right: 0; width: 140px;Â 
Â  Â  Â  Â  display: flex; align-items: center; justify-content: flex-end;Â 
Â  Â  Â  Â  z-index: 0;Â 
Â  Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â Â 
Â  Â  /* å…§å®¹å±¤ï¼šåŠ ä¸Š overflow hidden ç¢ºä¿åœ“è§’ */
Â  Â  .swipe-item-content {Â 
Â  Â  Â  Â  position: relative; z-index: 10; background-color: white;Â 
Â  Â  Â  Â  transition: transform 0.2s ease-out; transform: translateX(0);Â 
Â  Â  Â  Â  width: 100%; display: flex; align-items: stretch;Â 
Â  Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â Â 
Â  Â  .card-right-col {Â 
Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  justify-content: flex-start;Â 
Â  Â  Â  Â  align-items: flex-start;Â 
Â  Â  Â  Â  gap: 8px;Â 
Â  Â  Â  Â  width: 95px; min-width: 95px; max-width: 95px; flex: 0 0 95px;
Â  Â  Â  Â  border-left: none; padding-left: 6px; padding-bottom: 0.25rem; padding-top: 12px; position: relative;Â 
Â  Â  }
Â  Â  .card-right-col::before {
Â  Â  Â  Â  content: ''; position: absolute; left: 0; top: 8%; bottom: 8%; width: 1px; background-color: #C0C0C0;
Â  Â  }

Â  Â  .info-block-content { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-end; gap: 4px; width: 100%; }
Â  Â Â 
Â  Â  .card-static-actions {Â 
Â  Â  Â  Â  display: none !important;Â 
Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  justify-content: flex-start !important;Â 
Â  Â  Â  Â  gap: 2px;Â 
Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  margin: 0;Â 
Â  Â  }
Â  Â Â 
Â  Â  /* --- RWD Adjustments --- */
Â  Â  @media (min-width: 501px) {
Â  Â  Â  Â  .swipe-item-delete-bg { display: none !important; }
Â  Â  Â  Â  .trip-card .swipe-item-content { cursor: pointer; }Â 
Â  Â  Â  Â  .card-static-actions { display: flex !important; }Â 
Â  Â  Â  Â  .trip-card .content-text-block { margin-top: 5px; }
Â  Â  Â  Â  .desktop-del-btn { display: block !important; }
Â  Â  }
Â  Â  @media (max-width: 500px) {
Â  Â  Â  Â  html { scroll-padding-top: 180px; }
Â  Â  Â  Â  #schedule-list-container { padding-top: 180px; }
Â  Â  Â  Â  .trip-card:first-child::before { top: -35px; }
Â  Â  Â  Â  .trip-card .content-text-block { margin-top: 8px; }
Â  Â  Â  Â  .desktop-del-btn { display: none !important; }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  #currency-display-row { flex-wrap: nowrap !important; gap: 5px !important; }
Â  Â  Â  Â  #rate-display-container { width: auto !important; flex: 0 0 auto !important; border-right: none !important; }
Â  Â  Â  Â  #rate-display-label { font-size: 14px !important; white-space: nowrap !important; }
Â  Â  Â  Â  #currency-display-row > div:last-child { width: auto !important; flex: 1 1 auto !important; justify-content: flex-end !important; }
Â  Â  Â  Â  #bar-calc-amount { width: 50px !important; }
Â  Â  Â  Â  #bar-calc-currency { width: 45px !important; }
Â  Â  Â  Â  #btn-lists span:nth-child(2), #split-expense-btn span:nth-child(2) { font-size: 14px !important; }
Â  Â  }

Â  Â  /* --- Modals & Lists --- */
Â  Â  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(95, 99, 104, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
Â  Â  .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; line-height: 28px; color: #5F6368; border-color: #E0E0E0; border-width: 1px; box-sizing: border-box; }
Â  Â  .compact-input:focus { border-color: #7E92A1; outline: none; ring: 1px solid #7E92A1; }
Â  Â  .compact-label { font-size: 0.7rem; color: #7E92A1; font-weight: 700; margin-bottom: 0; }
Â  Â  input[type="time"], input[type="date"] { text-align: center; }
Â  Â  .list-tab-active { border-bottom: 2px solid #7E92A1; color: #7E92A1; font-weight: bold; }
Â  Â  .list-tab-inactive { color: #A9A9A9; }
Â  Â  .shopping-img-box { width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; position: relative; }
Â  Â  .shopping-img-box img { width: 100%; height: 100%; object-fit: cover; }
</style>
</head>

<body>
Â  Â  <div id="app-container">
Â  Â  Â  Â  <header>
Â  Â  Â  Â  Â  Â  <div id="header-content-wrapper" class="px-3 pb-1" style="padding-top: calc(15px + env(safe-area-inset-top));">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col flex-grow min-w-0 mr-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center w-full mb-0.5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="settings-btn" class="p-1 mr-0.5 text-[#888888] hover:text-[#5F6368]" title="è¨ˆç•«è¨­å®š">ğŸ“…</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center flex-shrink-0 ml-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="new-trip-btn" class="px-2 py-1 bg-[#7E92A1] text-white text-xs font-semibold rounded hover:bg-[#64748B] transition-colors hidden">+ æ–°å¢</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-1 text-[#888888] ml-1 mb-1.5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-xs">ğŸ‘«</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="header-day-date-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="weather-info-container" class="flex flex-col items-end justify-start text-[#888888] cursor-pointer flex-shrink-0 gap-2 pt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="header-weather-icon" class="text-4xl leading-none mb-0"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="header-weather-temp" class="text-sm font-bold"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="header-location-name" class="text-xs font-bold mt-0.5"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="header-clothing-advice" class="text-xs font-bold text-[#CB8572] mt-0.5 whitespace-nowrap"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>
Â  Â  Â  Â  <div id="schedule-list-container" class="px-3 pt-0 pb-4">
Â  Â  Â  Â  Â  Â  <div class="p-4 text-center text-[#A9A9A9] text-xs">è¡Œç¨‹åŠ è¼‰ä¸­...</div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="combined-bottom-bar">
Â  Â  Â  Â  <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5" style="flex-wrap: nowrap !important;">
Â  Â  Â  Â  Â  Â  <div id="rate-display-container" class="flex items-center justify-center border-r border-gray-100" style="width: 50% !important; flex: 0 0 50% !important; border-right: 1px solid #f3f4f6 !important;">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="rate-display-label">åŒ¯ç‡ â‰ˆ ...</span>Â 
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-start gap-0.5 pl-3" style="width: 50% !important; flex: 0 0 50% !important;">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="bar-calc-currency" class="bg-gray-50 border border-[#E0E0E0] rounded p-0.5 text-[10px] font-bold text-[#5F6368] h-6 w-10 text-center appearance-none cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="CNY">CNY</option><option value="GBP">GBP</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="bar-calc-amount" class="w-20 h-6 text-[10px] p-0.5 border border-[#E0E0E0] rounded text-center font-medium text-[#5F6368]">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[1.1rem] font-bold text-[#A9A9A9]">=</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[0.7rem] font-bold text-[#7E92A1] leading-[26px]">TWD</span>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="bar-calc-result" readonly value="0" class="w-12 h-6 p-0 border-none bg-transparent text-[#7E92A1] font-extrabold text-left focus:outline-none truncate pl-1">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="flex justify-between items-center w-full px-2 py-1.5">
Â  Â  Â  Â  Â  Â  Â <button id="btn-lists" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888] hover:text-[#7E92A1]">
Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-xl leading-none">ğŸ“</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-[12px] font-bold leading-none">æ¸…å–®</span>
Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â <div class="flex-none px-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="center-add-btn" class="prominent-integrated-btn shadow-md">ï¼‹</button>
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â <button id="split-expense-btn" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888] hover:text-[#8F9E8B]">
Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-xl leading-none">ğŸ’°</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-[12px] font-bold leading-none">èŠ±è²»</span>
Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="add-schedule-modal" class="modal-overlay hidden">
Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto relative"></div>
Â  Â  </div>
Â  Â  <div id="lists-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm max-h-[80vh] flex flex-col relative"><h3 class="text-base font-bold mb-2 flex justify-between items-center flex-shrink-0 text-[#4A4B4D]">æ¸…å–®<button id="lists-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button></h3><div id="list-tabs" class="flex gap-1 border-b border-gray-100 mb-2 overflow-x-auto no-scrollbar flex-shrink-0"></div><div id="list-content" class="flex-grow overflow-y-auto flex flex-col relative"></div></div></div>
Â  Â  <div id="image-zoom-modal" class="modal-overlay hidden z-[150] bg-black/80"><img id="zoom-img" class="max-w-[95%] max-h-[90%] rounded shadow-lg object-contain"></div>
Â  Â  <div id="settings-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>
Â  Â  <div id="new-trip-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"><h3 class="text-base font-bold mb-3 flex justify-between items-center text-[#4A4B4D]">æ–°å¢æ—…è¡Œè¨ˆç•«<button id="new-trip-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl">Ã—</button></h3><div id="new-trip-modal-content"></div></div></div>
Â  Â  <div id="split-expense-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]"><h3 class="text-sm font-bold mb-2 flex justify-between items-center flex-shrink-0 text-[#4A4B4D]">èŠ±è²»<button id="split-expense-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button></h3><div class="flex-shrink-0 mb-2 bg-[#F9F9F9] p-2 rounded border border-[#E0E0E0]"><div class="flex justify-between items-end mb-1 border-b border-[#E0E0E0] pb-0.5"><span class="text-[#5F6368] font-medium text-xs">ç¸½èŠ±è²»</span><span class="text-sm font-extrabold text-[#4A4B4D]">TWD$ <span id="expense-total-amount">0</span></span></div><div id="expense-chart-container" class="h-32 w-full relative flex justify-center items-center"><canvas id="expense-chart"></canvas></div></div><div class="overflow-y-auto flex-grow mb-1 pr-1"><div id="expense-member-list" class="space-y-0.5"></div></div></div></div>

Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

Â  Â  Â  Â  window.App = (function() {
Â  Â  Â  Â  Â  Â  const appId = 'my-trip-app';
Â  Â  Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28",
Â  Â  Â  Â  Â  Â  Â  Â  authDomain: "mytravelplanner-36283.firebaseapp.com",
Â  Â  Â  Â  Â  Â  Â  Â  projectId: "mytravelplanner-36283",
Â  Â  Â  Â  Â  Â  Â  Â  storageBucket: "mytravelplanner-36283.firebasestorage.app",
Â  Â  Â  Â  Â  Â  Â  Â  messagingSenderId: "86504733738",
Â  Â  Â  Â  Â  Â  Â  Â  appId: "1:86504733738:web:5167a6a795eb206dfed753"
Â  Â  Â  Â  Â  Â  }; Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const COUNTRY_CONFIG = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  'USA': { name: 'ç¾åœ‹', currency: 'USD', localName: 'New York', lat: 40.71, lon: -74.00, img: 'usa' },Â 
Â  Â  Â  Â  Â  Â  Â  Â  'JP': { name: 'æ—¥æœ¬', currency: 'JPY', localName: 'æ±äº¬', lat: 35.68, lon: 139.76, img: 'japan' },Â 
Â  Â  Â  Â  Â  Â  Â  Â  'KR': { name: 'éŸ“åœ‹', currency: 'KRW', localName: 'ì„œìš¸', lat: 37.56, lon: 126.97, img: 'korea' },Â 
Â  Â  Â  Â  Â  Â  Â  Â  'UK': { name: 'è‹±åœ‹', currency: 'GBP', localName: 'London', lat: 51.50, lon: -0.12, img: 'london' },Â 
Â  Â  Â  Â  Â  Â  Â  Â  'TW': { name: 'å°ç£', currency: 'TWD', localName: 'å°åŒ—', lat: 25.03, lon: 121.56, img: 'taiwan' }Â 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const CATEGORY_COLORS = { 'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, 'äº¤é€š': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' }, 'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
Â  Â  Â  Â  Â  Â  const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];
Â  Â  Â  Â  Â  Â  const CATEGORY_NAMES = { 'location': 'æ™¯é»', 'restaurant': 'é¤å»³', 'coffee': 'å’–å•¡å»³', 'äº¤é€š': 'äº¤é€š', 'shopping': 'è³¼ç‰©', 'accommodation': 'ä½å®¿', 'default': 'æœªåˆ†é¡' };

Â  Â  Â  Â  Â  Â  let db, auth, currentUser;
Â  Â  Â  Â  Â  Â  let currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {};
Â  Â  Â  Â  Â  Â  let unsubscribeSchedule = null, unsubscribeTrips = null, unsubscribeLists = null, expenseChart = null, currentTripRate = 1;
Â  Â  Â  Â  Â  Â  let currentListTabId = null;Â 
Â  Â  Â  Â  Â  Â  let pendingTripSwitchId = null;Â 

Â  Â  Â  Â  Â  Â  // --- åŸºç¤å·¥å…· ---
Â  Â  Â  Â  Â  Â  function formatDateForHeader(date) { const year = String(date.getFullYear()).slice(-2); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); const dayOfWeekMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; return `${year}.${month}.${day} ${dayOfWeekMap[date.getDay()]}`; }
Â  Â  Â  Â  Â  Â  function dateDiffInDays(date2, date1) { return Math.ceil(Math.abs(date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24)); }
Â  Â  Â  Â  Â  Â  function getDateFromDayId(trip, dayId) { if (!trip || !trip.startDate) return null; const d = new Date(trip.startDate); d.setDate(d.getDate() + (parseInt(dayId.replace('Day ', '')) - 1)); return d; }
Â  Â  Â  Â  Â  Â  function getCardStyle(type) { const c = CATEGORY_COLORS[type] || CATEGORY_COLORS['default']; const icons = {'coffee':'â˜•','restaurant':'ğŸ½ï¸','location':'ğŸ“','äº¤é€š':'ğŸš—','shopping':'ğŸ›ï¸','accommodation':'ğŸ›ï¸'}; return { color: c.bg, icon: icons[type] || 'â“', hex: c.hex, text: c.text }; }
Â  Â  Â  Â  Â  Â  function navigateToMap(input) { if (!input) return; const url = (input.includes('http') || input.includes('maps.')) ? input : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(input)}`; window.open(url, '_blank'); }
Â  Â  Â  Â  Â  Â  function formatCurrency(value) { if (typeof value !== 'number') value = parseFloat(value); if (isNaN(value) || value === 0) return '0'; return value.toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1'); }
Â  Â  Â  Â  Â  Â  async function fetchExchangeRate(baseCurrency) { const fallback = { 'USD': 32.5, 'JPY': 0.215, 'KRW': 0.023, 'GBP': 41.2, 'CNY': 4.5, 'TWD': 1 }; if (!baseCurrency || baseCurrency === 'TWD') return 1; try { const r = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency}`); const d = await r.json(); if (d && d.rates && d.rates.TWD) return d.rates.TWD; } catch (e) {} return fallback[baseCurrency] || 1; }

Â  Â  Â  Â  Â  Â  // --- æ–°å¢ï¼šçµ±ä¸€æ›´æ–° Header æ—¥æœŸèˆ‡ D-Day ---
Â  Â  Â  Â  Â  Â  function updateHeaderDateWithDDay(d) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!d) return;
Â  Â  Â  Â  Â  Â  Â  Â  const dateStr = formatDateForHeader(d);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // å–å¾—ã€Œä»Šå¤©ã€çš„æ—¥æœŸ (æ­¸é›¶æ™‚åˆ†ç§’)
Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  today.setHours(0, 0, 0, 0);

Â  Â  Â  Â  Â  Â  Â  Â  // --- 2. å‡ºç™¼å€’æ•¸ (Trip Countdown) ---
Â  Â  Â  Â  Â  Â  Â  Â  let tripCountdownHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  const trip = tripData[currentTripId];
Â  Â  Â  Â  Â  Â  Â  Â  if (trip && trip.startDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tripStart = new Date(trip.startDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tripStart.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffTimeTrip = today.getTime() - tripStart.getTime();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffDaysTrip = Math.floor(diffTimeTrip / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let dString = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (diffDaysTrip === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dString = 'D-0';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (diffDaysTrip > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dString = `D+${diffDaysTrip + 1}`; // Day 2 = D+2
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dString = `D${diffDaysTrip}`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tripCountdownHtml = `<span class="ml-2 text-[#7E92A1] text-xs font-bold tracking-wide">ğŸ›« ${dString}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // --- 3. æ„›å¿ƒå¤©æ•¸ (Love Days) ---
Â  Â  Â  Â  Â  Â  Â  Â  const anniversary = new Date('2025-08-01T00:00:00');
Â  Â  Â  Â  Â  Â  Â  Â  const diffTimeLove = today.getTime() - anniversary.getTime();
Â  Â  Â  Â  Â  Â  Â  Â  const diffDaysLove = Math.floor(diffTimeLove / (1000 * 60 * 60 * 24)) + 1;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let loveHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (!isNaN(diffDaysLove)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loveHtml = `<span class="ml-2 text-[#D4A5A5] text-xs font-extrabold tracking-wide">â¤ï¸ ${diffDaysLove}å¤©</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById('header-day-date-display');
Â  Â  Â  Â  Â  Â  Â  Â  if(el) el.innerHTML = `${dateStr}${tripCountdownHtml}${loveHtml}`;
Â  Â  Â  Â  Â  Â  }

// --- ä¿®æ”¹å¾Œï¼šæ”¯æ´è‡ªå‹•å®šä½ä¸¦é¡¯ç¤ºä¸­æ–‡åœ°åçš„å¤©æ°£å‡½å¼ ---
            async function updateHeaderInfo() {
                const trip = tripData[currentTripId]; if (!trip) return;
                const config = COUNTRY_CONFIG[trip.country || 'TW'] || COUNTRY_CONFIG['TW'];
                
                let lat = config.lat;
                let lon = config.lon;
                let displayName = config.localName;

                // 1. å˜—è©¦ç²å– GPS å®šä½
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 5000
                            });
                        });
                        lat = position.coords.latitude;
                        lon = position.coords.longitude;

                        // 2. ä½¿ç”¨ OpenStreetMap API å°‡ç¶“ç·¯åº¦è½‰æ›ç‚ºä¸­æ–‡åœ°å
                        try {
                            const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-TW`);
                            const geoData = await geoRes.json();
                            
                            if (geoData && geoData.address) {
                                // å„ªå…ˆé †åºï¼šåŸå¸‚(city) > é„‰é®(town) > å€åŸŸ(suburb) > ç¸£å¸‚(state)
                                displayName = geoData.address.city || 
                                              geoData.address.town || 
                                              geoData.address.village || 
                                              geoData.address.suburb || 
                                              geoData.address.municipality || 
                                              geoData.address.state || 
                                              config.localName;
                            }
                        } catch (geoErr) {
                            console.log("åœ°åè½‰æ›å¤±æ•—", geoErr);
                        }
                    } catch (e) {
                        console.log("ç„¡æ³•ç²å–å®šä½ï¼Œä½¿ç”¨é è¨­åœ°é»");
                    }
                }

                // æ›´æ–°ç•«é¢é¡¯ç¤ºçš„åœ°å
                document.getElementById('header-location-name').textContent = displayName;
                
                // æ›´æ–°åŒ¯ç‡ï¼ˆç¶­æŒåŸé‚è¼¯ï¼‰
                currentTripRate = await fetchExchangeRate(config.currency);
                const barSelect = document.getElementById('bar-calc-currency'); 
                if(barSelect) { barSelect.value = config.currency; calculateCurrency(); }
                
                // æ›´æ–°æˆå“¡ï¼ˆç¶­æŒåŸé‚è¼¯ï¼‰
                document.getElementById('header-members-list').innerHTML = (trip.members && trip.members.length) ? trip.members.map((m, i) => `<span class="${MEMBER_COLORS[i % MEMBER_COLORS.length]} mr-1">${m}</span>`).join('') : 'å°šæœªè¨­å®š';
                
                try { 
                    // æ ¹æ“šå®šä½æŠ“å–å¤©æ°£
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`); 
                    const data = await res.json(); 
                    const code = data.current.weather_code;
                    let icon = 'â˜€ï¸'; 
                    if (code > 3) icon = 'â˜ï¸'; 
                    if (code > 50) icon = 'ğŸŒ§ï¸'; 
                    
                    document.getElementById('header-weather-icon').textContent = icon; 
                    document.getElementById('header-weather-temp').textContent = `${data.current.temperature_2m}Â°C`; 
                    
                    const temp = data.current.temperature_2m;
                    let clothing = '';
                    if(temp >= 25) clothing = 'ğŸ½ çŸ­è¢–';
                    else if(temp >= 20) clothing = 'ğŸ‘• è–„å¤–å¥—';
                    else if(temp >= 15) clothing = 'ğŸ§¥ å¤–å¥—';
                    else if(temp >= 10) clothing = 'ğŸ§¥ å¤§è¡£';
                    else clothing = 'ğŸ§£ ç¾½çµ¨';

                    if ([51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99].includes(code)) {
                        clothing += ' â˜”å¸¶é›¨å…·';
                    }
                    else if ([71, 73, 75, 77, 85, 86].includes(code)) {
                        clothing += ' â„ï¸æ³¨æ„é˜²æ»‘';
                    }
                    
                    const adviceEl = document.getElementById('header-clothing-advice');
                    if(adviceEl) adviceEl.textContent = clothing;

                } catch (e) { }
            }

Â  Â  Â  Â  Â  Â  function changeTrip(tripId) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentTripId = tripId;Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentDayId = 'Day 1';Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentListTabId = null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  updateHeaderInfo();Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderDayTabs();Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadSchedules(currentTripId, currentDayId);Â 
Â  Â  Â  Â  Â  Â  Â  Â  checkAndCreateDefaultLists(tripId);Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function createTripCard(schedule) {
Â  Â  Â  Â  Â  Â  Â  Â  const style = getCardStyle(schedule.Type);
Â  Â  Â  Â  Â  Â  Â  Â  const config = CATEGORY_COLORS[schedule.Type] || CATEGORY_COLORS['default'];
Â  Â  Â  Â  Â  Â  Â  Â  const rate = schedule.Rate || 1;
Â  Â  Â  Â  Â  Â  Â  Â  const amountTWD = (schedule.Amount || 0) * rate;
Â  Â  Â  Â  Â  Â  Â  Â  let perPersonTWD = 0, specifiedTWD = 0, unspecifiedCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  const members = schedule.members || [];
Â  Â  Â  Â  Â  Â  Â  Â  if (amountTWD > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  members.forEach(m => { const amt = typeof m === 'string' ? null : m.amount; if(amt !== null && !isNaN(amt)) specifiedTWD += (schedule.isTwdSplit ? amt : amt * rate); else unspecifiedCount++; });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  perPersonTWD = (unspecifiedCount > 0) ? (amountTWD - specifiedTWD) / unspecifiedCount : (members.length > 0 ? amountTWD / members.length : amountTWD);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let memberHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (members.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  memberHtml = `<div class="flex flex-nowrap overflow-hidden justify-end gap-x-1.5 ml-2 max-w-[120px]">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  members.forEach((m, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â memberHtml += `<span class="${MEMBER_COLORS[i % MEMBER_COLORS.length]} text-[10px] font-bold whitespace-nowrap">${typeof m === 'string' ? m : m.name}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  memberHtml += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const mustGoHtml = schedule.MustGo ? `<div class="mt-auto w-full flex justify-start mb-3"><span class="text-[9px] text-[#CB8572] border border-[#CB8572] px-1 py-0.5 rounded-[2px] leading-none font-normal bg-white">å¿…å»</span></div>` : '';

Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  card.className = 'trip-card flex w-full mb-3 relative';Â 
Â  Â  Â  Â  Â  Â  Â  Â  card.style.height = '100px';Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const visualWrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  visualWrapper.className = 'trip-card-visual-wrapper';

Â  Â  Â  Â  Â  Â  Â  Â  const swipeActions = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  swipeActions.className = 'swipe-item-delete-bg';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const modBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  modBtn.className = "px-2 py-1 h-full text-xs font-bold bg-[#7E92A1] text-white modify-btn";
Â  Â  Â  Â  Â  Â  Â  Â  modBtn.textContent = "ä¿®æ”¹";
Â  Â  Â  Â  Â  Â  Â  Â  modBtn.onclick = (e) => { e.stopPropagation(); openEditScheduleModal(schedule); };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const delBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  delBtn.className = "px-2 py-1 h-full text-xs font-bold bg-[#CB8572] text-white delete-btn";
Â  Â  Â  Â  Â  Â  Â  Â  delBtn.textContent = "åˆªé™¤";
Â  Â  Â  Â  Â  Â  Â  Â  delBtn.onclick = (e) => { e.stopPropagation(); deleteSchedule(schedule.id); };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  swipeActions.appendChild(modBtn);
Â  Â  Â  Â  Â  Â  Â  Â  swipeActions.appendChild(delBtn);
Â  Â  Â  Â  Â  Â  Â  Â  visualWrapper.appendChild(swipeActions);

Â  Â  Â  Â  Â  Â  Â  Â  const content = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  content.className = 'swipe-item-content flex w-full bg-white relative items-stretch h-full z-10';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  content.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="${config.bg} w-14 flex-none flex flex-col items-center justify-start gap-2 text-white relative z-10 h-full py-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[10px] font-bold tracking-tight leading-none">${schedule.Time}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-2xl leading-none mb-1">${style.icon}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[9px] font-medium opacity-90 leading-none">${CATEGORY_NAMES[schedule.Type] || schedule.Type}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow py-2 pl-2 pr-1 flex flex-col justify-start min-w-0 relative overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xs font-bold text-[#4A4B4D] leading-tight mb-0.5 flex-grow mr-1 truncate">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" class="location-link map-link hover:underline">${schedule.Location}</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${memberHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[#888888] text-[10px] line-clamp-4 whitespace-pre-wrap leading-normal mt-0.5">${schedule.èªªæ˜ || ''}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-right-col h-full flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-static-actions"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col gap-1 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-start w-full"><span class="text-[#8F9E8B] font-bold text-[10px]">ğŸ’° TWD$${amountTWD.toFixed(0)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-start w-full"><span class="text-[#888888] font-bold text-[10px]">ğŸ‘« TWD$${formatCurrency(perPersonTWD)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${mustGoHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const staticActions = content.querySelector('.card-static-actions');
Â  Â  Â  Â  Â  Â  Â  Â  const staticMod = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  staticMod.className = "bg-[#7E92A1] text-white rounded px-1.5 py-0.5 text-[9px] font-bold";
Â  Â  Â  Â  Â  Â  Â  Â  staticMod.textContent = "ä¿®æ”¹";
Â  Â  Â  Â  Â  Â  Â  Â  staticMod.onclick = (e) => { e.stopPropagation(); openEditScheduleModal(schedule); };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const staticDel = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  staticDel.className = "bg-[#CB8572] text-white rounded px-1.5 py-0.5 text-[9px] font-bold";
Â  Â  Â  Â  Â  Â  Â  Â  staticDel.textContent = "åˆªé™¤";
Â  Â  Â  Â  Â  Â  Â  Â  staticDel.onclick = (e) => { e.stopPropagation(); deleteSchedule(schedule.id); };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  staticActions.appendChild(staticMod);
Â  Â  Â  Â  Â  Â  Â  Â  staticActions.appendChild(staticDel);

Â  Â  Â  Â  Â  Â  Â  Â  visualWrapper.appendChild(content);
Â  Â  Â  Â  Â  Â  Â  Â  card.appendChild(visualWrapper);

Â  Â  Â  Â  Â  Â  Â  Â  card.querySelector('.map-link').onclick = (e) => { e.preventDefault(); navigateToMap(schedule.Address || schedule.Location); };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  content.onclick = (e) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (window.innerWidth > 500 && !e.target.closest('button') && !e.target.classList.contains('map-link')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openEditScheduleModal(schedule);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  enableSwipeToDelete(content, swipeActions, 'schedule');
Â  Â  Â  Â  Â  Â  Â  Â  return card;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const loadSchedules = function(tripId, dayId) {
Â  Â  Â  Â  Â  Â  Â  Â  if (unsubscribeSchedule) unsubscribeSchedule();
Â  Â  Â  Â  Â  Â  Â  Â  const container = document.getElementById('schedule-list-container'); container.innerHTML = '<div class="p-4 text-center text-[#A9A9A9] text-xs">è¼‰å…¥ä¸­...</div>';
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Schedules`), where('dayId', '==', dayId), orderBy('Time'));
Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeSchedule = onSnapshot(q, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const trip = tripData[currentTripId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (trip && trip.startDate) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const d = getDateFromDayId(trip, dayId);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateHeaderDateWithDDay(d);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) container.innerHTML = `<div class="p-4 text-center text-[#A9A9A9] text-xs">æ­¤æ—¥æš«ç„¡è¡Œç¨‹ã€‚</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else snapshot.forEach(doc => container.appendChild(createTripCard({ id: doc.id, ...doc.data() })));
Â  Â  Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Load schedules error", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<div class="p-4 text-center text-red-400 text-xs">è¼‰å…¥å¤±æ•—</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const loadTripList = async function() {
Â  Â  Â  Â  Â  Â  Â  Â  if (unsubscribeTrips) unsubscribeTrips();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeTrips = onSnapshot(collection(db, `artifacts/${appId}/public/data/Trips`), (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const select = document.getElementById('trip-select');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tripData = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let firstId = null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tripData[doc.id] = { id: doc.id, ...data };Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const op = document.createElement('option');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  op.value = doc.id;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  op.textContent = data.name || 'æœªå‘½å';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.appendChild(op);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!firstId) firstId = doc.id;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-btn').style.display = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('new-trip-btn').style.display = 'inline-flex';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.style.display = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTripId = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.style.display = 'block';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-btn').style.display = 'inline-flex';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('new-trip-btn').style.display = 'none';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pendingTripSwitchId && tripData[pendingTripSwitchId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTripId = pendingTripSwitchId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pendingTripSwitchId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (!currentTripId || !tripData[currentTripId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTripId = firstId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.value = currentTripId;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  changeTrip(currentTripId);
Â  Â  Â  Â  Â  Â  Â  Â  }, (error) => { console.error(error); });
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  function renderDayTabs() {
Â  Â  Â  Â  Â  Â  Â  Â  const container = document.getElementById('day-tabs-container'); container.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  const trip = tripData[currentTripId]; if (!trip) return;
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < (trip.numDays || 1); i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dId = `Day ${i + 1}`; const btn = document.createElement('button'); const isActive = dId === currentDayId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.className = `px-3 py-1.5 text-xs font-bold rounded-lg transition duration-150 flex-shrink-0 ${isActive ? 'bg-[#5F6368] text-white shadow-md' : 'bg-[#E4E6E8] text-[#5F6368]'}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = dId; btn.onclick = () => { currentDayId = dId; renderDayTabs(); loadSchedules(currentTripId, currentDayId); };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(btn);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const addBtn = document.createElement('button'); addBtn.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-[#7E92A1] text-white ml-2 flex-shrink-0'; addBtn.textContent = '+';
Â  Â  Â  Â  Â  Â  Â  Â  addBtn.onclick = async () => { try { await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`), { numDays: (trip.numDays || 1) + 1 }, { merge: true }); } catch(e) { } };
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(addBtn);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const d = getDateFromDayId(trip, currentDayId);Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (d) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateHeaderDateWithDDay(d);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function calculateCurrency() {
Â  Â  Â  Â  Â  Â  Â  Â  const code = document.getElementById('bar-calc-currency').value; const amt = parseFloat(document.getElementById('bar-calc-amount').value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const rate = await fetchExchangeRate(code); const displayRate = rate > 0 ? (1/rate).toFixed(2) : '0.00';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('rate-display-label').textContent = `åŒ¯ç‡ â‰ˆ ${code} ${displayRate}`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('bar-calc-result').value = (amt === 0) ? '0' : (amt * rate).toFixed(0);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function safeBind(id, event, handler) {
Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  if (el) el[event] = handler;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function enableSwipeToDelete(contentEl, actionEl, type) {
Â  Â  Â  Â  Â  Â  Â  Â  if (window.innerWidth > 500) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let startX = 0, startY = 0, currentTranslate = 0, isSwiping = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  contentEl.addEventListener('touchstart', e => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startX = e.touches[0].clientX;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startY = e.touches[0].clientY;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSwiping = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }, {passive: true});
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  contentEl.addEventListener('touchmove', e => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffX = e.touches[0].clientX - startX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffY = e.touches[0].clientY - startY;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (Math.abs(diffY) > Math.abs(diffX) || Math.abs(diffX) < 10) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (diffX < 0) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSwiping = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTranslate = Math.max(diffX, -140);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentEl.style.transform = `translateX(${currentTranslate}px)`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if(currentTranslate < 0) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTranslate = Math.min(diffX - 140, 0);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentEl.style.transform = `translateX(${currentTranslate}px)`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  }, {passive: true});
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  contentEl.addEventListener('touchend', () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentEl.style.transform = (isSwiping && currentTranslate < -70) ? `translateX(-140px)` : `translateX(0)`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  actionEl.querySelectorAll('button').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalClick = btn.onclick;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(originalClick) originalClick(e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentEl.style.transform = `translateX(0)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function openEditScheduleModal(s) {
Â  Â  Â  Â  Â  Â  Â  Â  editingScheduleId = s.id;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-schedule-modal-title').textContent = s.Location || 'ç·¨è¼¯è¡Œç¨‹';Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modal-delete-btn').style.display = 'block';Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  safeBind('modal-delete-btn', 'onclick', () => deleteSchedule(s.id));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ['Date','Time','Location','Type','èªªæ˜','Address','Amount'].forEach(k => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById(`form-${k.toLowerCase().replace('èªªæ˜','details')}`);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(el) el.value = s[k] || (k==='Amount'?0:'');Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-currency-label').textContent = tripData[currentTripId].currency || 'TWD';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-amount-twd').value = ((s.Amount||0) * currentTripRate).toFixed(0);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-must-go').checked = s.MustGo || false;
Â  Â  Â  Â  Â  Â  Â  Â  const alarmCheckbox = document.getElementById('form-set-alarm');
Â  Â  Â  Â  Â  Â  Â  Â  if(alarmCheckbox) alarmCheckbox.checked = s.SetAlarm || false;

Â  Â  Â  Â  Â  Â  Â  Â  const c = document.getElementById('form-members-container'); c.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  const mems = s.members || [];Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(mems.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mems.forEach(m => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const name = typeof m === 'string' ? m : m.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const amt = (typeof m === 'string' || m.amount === null) ? '' : m.amount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isPayer = m.isPayer || false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const method = m.method || 'cash';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addMemberInput(name, amt, isPayer, method);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addMemberInput(); addMemberInput();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-schedule-modal').style.display = 'flex';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function addMemberInput(name='', amt='', isPayer=false, method='cash') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const d = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  d.className = 'flex items-center w-full gap-2 border-b border-gray-100 pb-2 mb-2 last:border-0 last:mb-0';Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const nameInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  nameInput.type = 'text';
Â  Â  Â  Â  Â  Â  Â  Â  nameInput.name = 'schedule-member-name';
Â  Â  Â  Â  Â  Â  Â  Â  nameInput.value = name;
Â  Â  Â  Â  Â  Â  Â  Â  nameInput.placeholder = 'åå­—';
Â  Â  Â  Â  Â  Â  Â  Â  nameInput.className = 'compact-input w-16 rounded-md font-bold text-[10px] flex-shrink-0';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const amtInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  amtInput.type = 'number';
Â  Â  Â  Â  Â  Â  Â  Â  amtInput.name = 'schedule-member-amount';
Â  Â  Â  Â  Â  Â  Â  Â  amtInput.value = amt;
Â  Â  Â  Â  Â  Â  Â  Â  amtInput.placeholder = 'é‡‘é¡';
Â  Â  Â  Â  Â  Â  Â  Â  amtInput.className = 'compact-input w-16 rounded-md text-[10px] flex-shrink-0';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- [æ–°å¢åŠŸèƒ½] ç›£è½è¼¸å…¥äº‹ä»¶ï¼šè‡ªå‹•åŠ ç¸½æˆå“¡é‡‘é¡ ---
Â  Â  Â  Â  Â  Â  Â  Â  amtInput.oninput = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. æŠ“å–æ‰€æœ‰æˆå“¡çš„é‡‘é¡æ¬„ä½ä¸¦åŠ ç¸½
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('input[name="schedule-member-amount"]').forEach(inp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = parseFloat(inp.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isNaN(val)) total += val;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. æ›´æ–°ä¸‹æ–¹ã€Œç•¶åœ°è²¨å¹£ã€ç¸½é‡‘é¡ (#form-amount)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalInput = document.getElementById('form-amount');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (totalInput) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalInput.value = total; // å¡«å…¥åŠ ç¸½å¾Œçš„æ•¸å­—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. è‡ªå‹•é€£å‹•è¨ˆç®—å°å¹£é‡‘é¡ (#form-amount-twd)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const twdInput = document.getElementById('form-amount-twd');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (twdInput && typeof currentTripRate !== 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  twdInput.value = (total * currentTripRate).toFixed(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  // ---------------------------------------------

Â  Â  Â  Â  Â  Â  Â  Â  const optsDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  optsDiv.className = 'flex flex-row items-center gap-1';Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  Â  Â  Â  Â  Â  label.className = 'flex items-center text-xs text-[#7E92A1] cursor-pointer leading-none select-none whitespace-nowrap';
Â  Â  Â  Â  Â  Â  Â  Â  const checkbox = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.type = 'checkbox';
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.className = 'payer-check mr-1 h-4 w-4';
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = isPayer;
Â  Â  Â  Â  Â  Â  Â  Â  label.appendChild(checkbox);
Â  Â  Â  Â  Â  Â  Â  Â  label.appendChild(document.createTextNode('å…ˆä»˜'));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const select = document.createElement('select');
Â  Â  Â  Â  Â  Â  Â  Â  select.className = 'payment-method text-xs border border-gray-200 rounded px-1 py-0 text-[#5F6368] bg-white h-6 leading-none text-center';
Â  Â  Â  Â  Â  Â  Â  Â  const op1 = document.createElement('option'); op1.value='cash'; op1.text='ç¾é‡‘';
Â  Â  Â  Â  Â  Â  Â  Â  const op2 = document.createElement('option'); op2.value='card'; op2.text='åˆ·å¡';
Â  Â  Â  Â  Â  Â  Â  Â  select.add(op1); select.add(op2);
Â  Â  Â  Â  Â  Â  Â  Â  select.value = method;

Â  Â  Â  Â  Â  Â  Â  Â  optsDiv.appendChild(label);
Â  Â  Â  Â  Â  Â  Â  Â  optsDiv.appendChild(select);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const delBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  delBtn.type = 'button';
Â  Â  Â  Â  Â  Â  Â  Â  delBtn.className = 'text-[#CB8572] font-bold p-1 rm-btn ml-auto text-lg leading-none w-6 flex justify-center items-center';
Â  Â  Â  Â  Â  Â  Â  Â  delBtn.textContent = 'Ã—';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ä¿®æ”¹åˆªé™¤æŒ‰éˆ•é‚è¼¯ï¼šåˆªé™¤æˆå“¡å¾Œä¹Ÿè¦é‡æ–°è¨ˆç®—ç¸½é‡‘é¡
Â  Â  Â  Â  Â  Â  Â  Â  delBtn.onclick = () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.remove();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // è§¸ç™¼é‡æ–°è¨ˆç®—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('input[name="schedule-member-amount"]').forEach(inp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = parseFloat(inp.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isNaN(val)) total += val;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalInput = document.getElementById('form-amount');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (totalInput) totalInput.value = total;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const twdInput = document.getElementById('form-amount-twd');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (twdInput && typeof currentTripRate !== 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  twdInput.value = (total * currentTripRate).toFixed(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  d.appendChild(nameInput);
Â  Â  Â  Â  Â  Â  Â  Â  d.appendChild(amtInput);
Â  Â  Â  Â  Â  Â  Â  Â  d.appendChild(optsDiv);
Â  Â  Â  Â  Â  Â  Â  Â  d.appendChild(delBtn);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-members-container').appendChild(d);Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function submitSchedule() {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateVal = document.getElementById('form-date').value; if (!dateVal) return alert("è«‹é¸æ—¥æœŸ");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const trip = tripData[currentTripId]; const dayId = `Day ${dateDiffInDays(new Date(dateVal), new Date(trip.startDate)) + 1}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const members = [];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const memberRows = document.getElementById('form-members-container').children;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let row of memberRows) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const name = row.querySelector('input[name="schedule-member-name"]').value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const amountStr = row.querySelector('input[name="schedule-member-amount"]').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isPayer = row.querySelector('.payer-check').checked;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const method = row.querySelector('.payment-method').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (name) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  members.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: name,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amount: amountStr ? parseFloat(amountStr) : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isPayer: isPayer,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: method
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uid = auth.currentUser ? auth.currentUser.uid : null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let rawAmount = parseFloat(document.getElementById('form-amount').value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(rawAmount)) rawAmount = 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const setAlarm = document.getElementById('form-set-alarm').checked || false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayId,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Date: dateVal,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Time: document.getElementById('form-time').value,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Location: document.getElementById('form-location').value,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Type: document.getElementById('form-type').value,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  èªªæ˜: document.getElementById('form-details').value,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Address: document.getElementById('form-address').value,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Amount: rawAmount,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Rate: currentTripRate || 1,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  members,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  MustGo: document.getElementById('form-must-go').checked || false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  SetAlarm: setAlarmÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const col = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (editingScheduleId) await updateDoc(doc(col, editingScheduleId), data); else await addDoc(col, data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-schedule-modal').style.display = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentDayId = dayId;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDayTabs();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadSchedules(currentTripId, currentDayId);
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { console.error(e); }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function checkAndCreateDefaultLists(tripId) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const col = collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Lists`);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snap = await getDocs(col);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snap.empty) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uid = auth.currentUser ? auth.currentUser.uid : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(col, {name: 'ç‰©å“', type: 'check', order: 1, items:[], uid: uid});Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(col, {name: 'è³¼ç‰©', type: 'shopping', order: 2, items:[], uid: uid});Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) {}
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- [æ–°å¢] å½ˆå‡ºæ¸…å–®è¨­å®šè¦–çª— (ä¿®æ”¹åç¨± + åˆªé™¤) ---
Â  Â  Â  Â  Â  Â  function openListSettings(listData) {
Â  Â  Â  Â  Â  Â  Â  Â  // ç§»é™¤èˆŠçš„è¨­å®šè¦–çª— (å¦‚æœæœ‰çš„è©±)
Â  Â  Â  Â  Â  Â  Â  Â  const oldModal = document.getElementById('list-settings-modal');
Â  Â  Â  Â  Â  Â  Â  Â  if(oldModal) oldModal.remove();

Â  Â  Â  Â  Â  Â  Â  Â  const overlay = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  overlay.id = 'list-settings-modal';
Â  Â  Â  Â  Â  Â  Â  Â  overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[110]'; // z-index æ¯”ä¸€èˆ¬ modal é«˜
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  overlay.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl p-4 w-10/12 max-w-[280px] relative animate-[fadeIn_0.2s_ease-out]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-sm font-bold text-[#7E92A1] mb-3 text-center">ç·¨è¼¯æ¸…å–®</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-[10px] text-gray-400 mb-1">æ¸…å–®åç¨±</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="setting-list-name" value="${listData.name}" class="w-full border-b border-[#7E92A1] text-center font-bold text-[#4A4B4D] py-1 focus:outline-none text-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between mt-4 pt-2 border-t border-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="setting-del-btn" class="p-2 rounded-full text-[#CB8572] hover:bg-red-50 transition-colors" title="åˆªé™¤æ­¤æ¸…å–®">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="setting-save-btn" class="px-4 py-1.5 bg-[#7E92A1] text-white text-xs font-bold rounded-lg hover:bg-[#64748B]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Save
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="setting-close-btn" class="absolute top-2 right-3 text-gray-300 hover:text-gray-500 text-xl">Ã—</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(overlay);

Â  Â  Â  Â  Â  Â  Â  Â  // äº‹ä»¶ç¶å®š
Â  Â  Â  Â  Â  Â  Â  Â  const close = () => overlay.remove();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setting-close-btn').onclick = close;
Â  Â  Â  Â  Â  Â  Â  Â  overlay.onclick = (e) => { if(e.target === overlay) close(); };

Â  Â  Â  Â  Â  Â  Â  Â  // å„²å­˜åç¨±
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setting-save-btn').onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newName = document.getElementById('setting-list-name').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newName && newName.trim() && newName !== listData.name) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`), { name: newName.trim() });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  close();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { alert("æ›´æ–°å¤±æ•—"); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  close();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  // åˆªé™¤æ¸…å–®
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setting-del-btn').onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${listData.name}ã€åŠå…¶æ‰€æœ‰å…§å®¹å—ï¼Ÿ`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentListTabId = null; // é‡ç½®é¸å–ç‹€æ…‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  close();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â // --- [ä¿®æ”¹] è¼‰å…¥æ¸…å–® (é»æ“Šç•¶å‰åˆ†é è§¸ç™¼è¨­å®šè¦–çª—) ---
Â  Â  Â  Â  Â  Â  function loadLists() {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!currentTripId) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const listModal = document.getElementById('lists-modal');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(listModal) listModal.style.display = 'flex';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(unsubscribeLists) unsubscribeLists();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), orderBy('order'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeLists = onSnapshot(q, (snap) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tabs = document.getElementById('list-tabs');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cont = document.getElementById('list-content');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!tabs || !cont) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabs.innerHTML = ''; cont.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lists = [];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(d => lists.push({id: d.id, ...d.data()}));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(typeof tripData !== 'undefined' && tripData[currentTripId]) tripData[currentTripId].lists = lists;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!lists.length) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkAndCreateDefaultLists(currentTripId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let activeListExists = currentListTabId && lists.some(l => l.id === currentListTabId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!activeListExists && lists.length > 0) currentListTabId = lists[0].id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. æ¸²æŸ“ Tabs
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lists.forEach(l => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isActive = l.id === currentListTabId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ¨£å¼èª¿æ•´ï¼šActive ç‹€æ…‹ä¸‹æ–‡å­—æ›´æ·±è‰²ï¼Œæ–¹ä¾¿è¾¨è­˜
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.className = `cursor-pointer px-3 py-2 text-sm flex-shrink-0 transition-colors whitespace-nowrap select-none ${isActive ? 'border-b-2 border-[#7E92A1] text-[#7E92A1] font-bold' : 'text-[#A9A9A9] hover:text-[#5F6368]'}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.textContent = l.name;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [é—œéµä¿®æ”¹] é»æ“Šé‚è¼¯
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.onclick = () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¦‚æœå·²ç¶“é¸ä¸­ï¼Œå†æ¬¡é»æ“Š -> é–‹å•Ÿè¨­å®šè¦–çª— (æ”¹å/åˆªé™¤)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openListSettings(l);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¦‚æœæœªé¸ä¸­ -> åˆ‡æ›åˆ†é 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentListTabId = l.id;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadLists();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabs.appendChild(t);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. æ¸²æŸ“ "+" æŒ‰éˆ•
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const addTab = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addTab.className = 'cursor-pointer px-3 py-2 text-sm flex-shrink-0 text-[#7E92A1] font-bold hover:bg-gray-50 flex items-center justify-center';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addTab.innerHTML = 'ï¼‹';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addTab.title = "æ–°å¢æ¸…å–®";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addTab.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newName = prompt("è«‹è¼¸å…¥æ–°æ¸…å–®åç¨±:");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newName && newName.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const typeMap = confirm("é€™æ˜¯ã€Œè³¼ç‰©/ä»£è³¼ã€æ¸…å–®å—ï¼Ÿ\n(ç¢ºå®š=è³¼ç‰©ï¼Œå–æ¶ˆ=ç‰©å“)") ? 'shopping' : 'check';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uid = auth.currentUser ? auth.currentUser.uid : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newDoc = await addDoc(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: newName.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: typeMap,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order: Date.now(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: uid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentListTabId = newDoc.id;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabs.appendChild(addTab);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. æ¸²æŸ“å…§å®¹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetList = lists.find(l => l.id === currentListTabId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (targetList) renderListItems(targetList, cont);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (innerErr) { console.error(innerErr); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cont = document.getElementById('list-content');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cont) cont.innerHTML = '<div class="text-center text-xs p-4 text-red-400">ç„¡æ³•è®€å–æ¸…å–®</div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) { console.error(err); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- [ä¿®æ”¹] æ¸²æŸ“æ¸…å–®é …ç›® (å…©æ¬„é¡¯ç¤º + æ¨™é¡Œç®¡ç†åˆ—) ---
Â  Â  Â  Â  Â  Â  // --- [ä¿®æ”¹] æ¸²æŸ“æ¸…å–®é …ç›® (ç§»é™¤æ¨™é¡Œåˆ—ï¼Œç´”æ·¨å…§å®¹) ---
Â  Â  Â  Â  Â  Â  function renderListItems(listData, container) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!listData) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const modalBody = container.parentElement;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (modalBody) modalBody.style.position = 'relative';

Â  Â  Â  Â  Â  Â  Â  Â  // FAB (å³ä¸‹è§’æ–°å¢æŒ‰éˆ•)
Â  Â  Â  Â  Â  Â  Â  Â  const oldFab = modalBody.querySelector('.list-fab-dynamic');
Â  Â  Â  Â  Â  Â  Â  Â  if(oldFab) oldFab.remove();

Â  Â  Â  Â  Â  Â  Â  Â  const fab = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  fab.className = 'list-fab-dynamic';Â 
Â  Â  Â  Â  Â  Â  Â  Â  fab.textContent = 'ï¼‹';
Â  Â  Â  Â  Â  Â  Â  Â  fab.style.cssText = `position: absolute; bottom: 20px; right: 20px; width: 44px; height: 44px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.25); cursor: pointer; z-index: 50; user-select: none; transition: transform 0.1s;`;
Â  Â  Â  Â  Â  Â  Â  Â  fab.onmousedown = () => fab.style.transform = "scale(0.95)";
Â  Â  Â  Â  Â  Â  Â  Â  fab.onmouseup = () => fab.style.transform = "scale(1)";
Â  Â  Â  Â  Â  Â  Â  Â  fab.onclick = async () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newItem = listData.type === 'check' ?Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: Date.now(), text: '', checkedLeft: false, checkedRight: false, isImportant: false } :Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: Date.now(), text: '', desc: '', location: '', imageUrl: '', isImportant: false };Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentItems = Array.isArray(listData.items) ? listData.items : [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`), { items: [...currentItems, newItem] });Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) { }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  if (modalBody) modalBody.appendChild(fab);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- ç§»é™¤èˆŠçš„ Header Row ç¨‹å¼ç¢¼ï¼Œç›´æ¥é–‹å§‹æ¸²æŸ“å…§å®¹ ---
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const inner = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  // å…©æ¬„ Grid è¨­å®š
Â  Â  Â  Â  Â  Â  Â  Â  if(listData.type === 'check') inner.className = 'grid grid-cols-2 gap-2 pb-16 px-1 mt-2'; // mt-2 å¢åŠ ä¸€é»é ‚éƒ¨é–“è·
Â  Â  Â  Â  Â  Â  Â  Â  else inner.className = 'space-y-2 pb-16 px-1 mt-2';Â 

Â  Â  Â  Â  Â  Â  Â  Â  const rawItems = Array.isArray(listData.items) ? listData.items : [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // æ’åºï¼šé‡è¦åœ¨å‰
Â  Â  Â  Â  Â  Â  Â  Â  const itemsWithIdx = rawItems.map((item, index) => ({ ...item, _origIdx: index }));
Â  Â  Â  Â  Â  Â  Â  Â  itemsWithIdx.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!!b.isImportant === !!a.isImportant) return 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return b.isImportant ? 1 : -1;Â 
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (rawItems.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inner.className = 'block pb-16 px-1 mt-4';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inner.innerHTML = '<div class="text-center text-gray-300 text-sm">å°šç„¡ç‰©å“</div>';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  itemsWithIdx.forEach((item) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!item) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const realIdx = item._origIdx;Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const wrap = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wrap.className = 'swipe-item-container';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bg = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bg.className = 'swipe-item-delete-bg';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bg.innerHTML = `<button class="px-2 py-1 h-full text-xs font-bold bg-[#CB8572] text-white" data-action="delete">åˆªé™¤</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const c = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c.className = 'swipe-item-content bg-white relative';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ˜Ÿæ˜ŸæŒ‰éˆ•
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const starHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="star-btn flex-shrink-0 w-5 h-full flex items-center justify-center text-[15px] leading-none transition-transform active:scale-90 ${item.isImportant ? 'text-yellow-400' : 'text-gray-200'}" title="æ¨™è¨˜é‡è¦">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.isImportant ? 'â˜…' : 'â˜†'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(listData.type==='check') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // --- æª¢æ ¸è¡¨ (å…©æ¬„ Compact) ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.style.cssText = "display:flex; align-items:center; gap:2px; padding:6px 2px; border:1px solid #f0f0f0; border-radius:8px; background:white; box-shadow: 0 1px 2px rgba(0,0,0,0.03);";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${starHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:4px; flex-shrink:0; margin-left:1px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" class="check-left" style="width:14px; height:14px; cursor:pointer; accent-color:#7E92A1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" class="check-right" style="width:14px; height:14px; cursor:pointer; accent-color:#9C8B74;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="check-text compact-input" style="flex-grow:1; min-width:0; border:none; border-bottom:1px dashed transparent; padding:0 3px; text-align:left; font-size:13px; font-weight:500; color:#5F6368; background:transparent;" placeholder="ç‰©å“">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="del-btn text-gray-300 hover:text-[#CB8572] font-bold px-1.5" style="font-size:16px;">Ã—</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const starBtn = c.querySelector('.star-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const boxL = c.querySelector('.check-left');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const txt = c.querySelector('.check-text');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const boxR = c.querySelector('.check-right');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const delBtn = c.querySelector('.del-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(starBtn) starBtn.onclick = () => updateListItem(listData, realIdx, {isImportant: !item.isImportant});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(boxL) { boxL.checked = !!item.checkedLeft; boxL.onchange = (e) => updateListItem(listData, realIdx, {checkedLeft: e.target.checked}); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(txt) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â txt.value = item.text || '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â txt.onchange = (e) => updateListItem(listData, realIdx, {text: e.target.value});Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â txt.onfocus = () => txt.style.borderBottom = "1px dashed #ccc";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â txt.onblur = () => txt.style.borderBottom = "1px dashed transparent";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(boxR) { boxR.checked = !!item.checkedRight; boxR.onchange = (e) => updateListItem(listData, realIdx, {checkedRight: e.target.checked}); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(delBtn) { delBtn.onclick = () => deleteListItem(listData, realIdx); }Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // --- è³¼ç‰©æ¸…å–® (ç¶­æŒ Grid) ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.className += ' p-1.5 border border-gray-100 rounded-lg shadow-sm';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.style.display = 'grid';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.style.gridTemplateColumns = '24px 50px 1fr 80px 20px';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.style.gap = '4px';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.style.alignItems = 'center';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.style.paddingRight = '0px'; Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const starContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â starContainer.innerHTML = starHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const starBtn = starContainer.querySelector('.star-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â starBtn.onclick = () => updateListItem(listData, realIdx, {isImportant: !item.isImportant});

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const imgContainer = document.createElement('div'); imgContainer.className = 'shopping-img-box';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â imgContainer.style.cssText = 'width:50px; height:50px; overflow:hidden; border-radius:6px; background:#f9f9f9; display:flex; justify-content:center; align-items:center; cursor:pointer; border:1px solid #eee;';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (item.imageUrl) { const img = document.createElement('img'); img.src = item.imageUrl; img.style.cssText = 'width:100%; height:100%; object-fit:cover;'; imgContainer.appendChild(img); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â else { const span = document.createElement('span'); span.textContent = 'ğŸ“·'; span.style.cssText = 'font-size:14px; color:#ddd;'; imgContainer.appendChild(span); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = 'image/*'; fileInput.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â imgContainer.onclick = () => { if (item.imageUrl) { document.getElementById('zoom-img').src = item.imageUrl; document.getElementById('image-zoom-modal').style.display = 'flex'; } else { fileInput.click(); } };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â fileInput.onchange = (e) => { if(!e.target.files[0]) return; const fr = new FileReader(); fr.onload = (ev) => { const img = new Image(); img.onload = () => { const cvs = document.createElement('canvas'); const scale = 400 / img.width; cvs.width = 400; cvs.height = img.height * scale; cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height); updateListItem(listData, realIdx, {imageUrl: cvs.toDataURL("image/jpeg", 0.7)}); }; img.src = ev.target.result; }; fr.readAsDataURL(e.target.files[0]); };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const midCol = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â midCol.style.cssText = 'display:flex; flex-direction:column; justify-content:center; height:50px; gap:2px;';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.className = 'compact-input'; nameInput.placeholder = 'å“å'; nameInput.value = item.text || '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â nameInput.style.cssText = 'width:100%; font-weight:bold; border:none; padding:0; height:20px; font-size:13px; background:transparent;';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â nameInput.onchange = (e) => updateListItem(listData, realIdx, {text: e.target.value});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const descInput = document.createElement('textarea'); descInput.className = 'compact-input'; descInput.placeholder = 'è¦æ ¼/å‚™è¨»'; descInput.value = item.desc || '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â descInput.style.cssText = 'width:100%; border:none; padding:0; resize:none; font-size:11px; height:24px; line-height:1.2; overflow:hidden; color:#888; background:transparent;';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â descInput.onchange = (e) => updateListItem(listData, realIdx, {desc: e.target.value});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â midCol.appendChild(nameInput); midCol.appendChild(descInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const locInput = document.createElement('textarea');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â locInput.className = 'compact-input';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â locInput.placeholder = 'åœ°é»/åƒ¹æ ¼';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â locInput.value = item.location || '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â locInput.style.cssText = 'width:100%; height:50px; border:1px solid #f0f0f0; background:#fcfcfc; padding:4px; resize:none; border-radius:4px; font-size:10px; line-height:1.3; color:#555;';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â locInput.onchange = (e) => updateListItem(listData, realIdx, {location: e.target.value});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const delBtnDesktop = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delBtnDesktop.className = 'desktop-del-btn';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delBtnDesktop.innerHTML = 'Ã—';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delBtnDesktop.style.cssText = "width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#e5e7eb; font-weight:bold; cursor:pointer; font-size:20px; hover:color:#CB8572;";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delBtnDesktop.onclick = (e) => { e.stopPropagation(); deleteListItem(listData, realIdx); };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.appendChild(starBtn);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.appendChild(imgContainer);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.appendChild(midCol);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.appendChild(locInput);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.appendChild(delBtnDesktop);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â c.appendChild(fileInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wrap.appendChild(bg); wrap.appendChild(c); inner.appendChild(wrap);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { if (typeof enableSwipeToDelete === 'function') enableSwipeToDelete(c, bg, 'list'); } catch(e){}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) { console.error(err); }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(inner);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  async function updateListItem(l, i, chg) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentItems = Array.isArray(l.items) ? l.items : []; const ni = [...currentItems];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!ni[i]) ni[i] = {}; ni[i] = {...ni[i], ...chg};Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${l.id}`), {items:ni});Â 
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function deleteListItem(l, i) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const ni=l.items.filter((_,x)=>x!==i);Â 
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${l.id}`), {items:ni});
Â  Â  Â  Â  Â  Â  }

async function loadExpenseSummary() {
                if(!currentTripId) return; 
                const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
                let total = 0, types = {}, mems = {}, balances = {};
                
                snap.forEach(d => {
                    const da = d.data(); 
                    const tTWD = (da.Amount || 0) * (da.Rate || 1);
                    
                    if(tTWD > 0) { 
                        total += tTWD; 
                        types[da.Type] = (types[da.Type] || 0) + tTWD; 
                        
                        const scheduleMembers = da.members || [];

                        // 1. è¨ˆç®—ã€Œèª°ä»˜éŒ¢ã€(Credit)
                        const payers = scheduleMembers.filter(m => typeof m !== 'string' && m.isPayer);
                        if(payers.length > 0) {
                            // è‹¥å¤šå€‹æˆå“¡å‹¾é¸å…ˆä»˜ï¼Œå¹³åˆ†é€™ç­†ä»£å¢Šç¸½é¡
                            const payShare = tTWD / payers.length;
                            payers.forEach(p => { 
                                balances[p.name] = (balances[p.name] || 0) + payShare; 
                            });
                        }

                        // 2. è¨ˆç®—ã€Œèª°æ¶ˆè²»ã€(Debt)
                        let specifiedTWD = 0, unspecifiedUsers = [];
                        
                        // å…ˆæ‰¾å‡ºæœ‰å¡«å¯«ç‰¹å®šé‡‘é¡çš„äºº
                        scheduleMembers.forEach(m => {
                            const name = typeof m === 'string' ? m : m.name;
                            const amt = typeof m === 'string' ? null : m.amount;
                            if(amt !== null && !isNaN(amt)) {
                                const individualCostTWD = amt * (da.Rate || 1);
                                specifiedTWD += individualCostTWD;
                                // æ‰£é™¤å‚µå‹™
                                balances[name] = (balances[name] || 0) - individualCostTWD;
                                addMemExp(mems, name, da.Type, individualCostTWD);
                            } else {
                                unspecifiedUsers.push(name);
                            }
                        });

                        // å‰©ä¸‹çš„é‡‘é¡ç”±æœªæŒ‡å®šé‡‘é¡çš„äººå¹³åˆ†
                        if(unspecifiedUsers.length > 0) {
                            const remainingTWD = tTWD - (specifiedTWD / (da.Rate || 1) * (da.Rate || 1)); // é¿å…æµ®é»èª¤å·®ï¼Œä»¥TWDè¨ˆç®—
                            const averageTWD = Math.max(0, tTWD - specifiedTWD) / unspecifiedUsers.length;
                            unspecifiedUsers.forEach(u => {
                                balances[u] = (balances[u] || 0) - averageTWD;
                                addMemExp(mems, u, da.Type, averageTWD);
                            });
                        }
                    }
                });

                function addMemExp(s, n, t, a) { if(!s[n]) s[n]={total:0, cats:{}}; s[n].total+=a; s[n].cats[t]=(s[n].cats[t]||0)+a; }
                
                document.getElementById('expense-total-amount').textContent = total.toFixed(0);
                
                // --- ç¹ªè£½åœ“é¤…åœ– (ä¿æŒåŸæ¨£) ---
                const ctx = document.getElementById('expense-chart').getContext('2d'); 
                if(expenseChart) expenseChart.destroy();
                const sortedKeys = Object.keys(types).sort((a,b) => types[b] - types[a]);
                expenseChart = new Chart(ctx, { 
                    type: 'doughnut', 
                    data: {
                        labels: sortedKeys.map(k => CATEGORY_NAMES[k]||k), 
                        datasets: [{
                            data: sortedKeys.map(k => types[k]), 
                            backgroundColor: sortedKeys.map(k => (CATEGORY_COLORS[k]||CATEGORY_COLORS.default).hex), 
                            borderWidth: 0
                        }]
                    }, 
                    options: { responsive: true, maintainAspectRatio: false, cutout: '45%', plugins: { legend: { display: false } } } 
                });

                // æ›´æ–°åœ–ä¾‹ (ä¿æŒåŸæ¨£)
                const leftContainer = document.getElementById('expense-legend-left');
                const rightContainer = document.getElementById('expense-legend-right');
                leftContainer.innerHTML = ''; rightContainer.innerHTML = '';
                sortedKeys.forEach((key, index) => {
                    const color = (CATEGORY_COLORS[key] || CATEGORY_COLORS.default).hex;
                    const name = CATEGORY_NAMES[key] || key;
                    const amount = types[key].toFixed(0);
                    const percent = Math.round((types[key] / total) * 100);
                    const itemHtml = `<div class="flex flex-col ${index >= 3 ? 'items-end' : 'items-start'} min-w-0 w-full"><div class="flex items-center gap-1 ${index >= 3 ? 'flex-row-reverse' : 'flex-row'}"><div class="w-2 h-2 rounded-full" style="background-color: ${color};"></div><span class="text-[9px] font-bold text-[#5F6368]">${name}</span></div><span class="text-[9px] text-[#A9A9A9]">$${amount} (${percent}%)</span></div>`;
                    if (index >= 3) rightContainer.innerHTML += itemHtml; else leftContainer.innerHTML += itemHtml;
                });

                // --- æˆå“¡åˆ—è¡¨èˆ‡åˆ†å¸³å»ºè­° ---
                const l = document.getElementById('expense-member-list'); 
                l.innerHTML = `<div class="grid grid-cols-[40%_20%_40%] border-b border-[#E0E0E0] pb-1 mb-2 font-bold text-[#5F6368] text-[10px]"><span>æˆå“¡</span><span class="text-center">é¡åˆ¥</span><span class="text-right">å€‹äººæ¶ˆè²»</span></div>`;
                
                Object.keys(mems).sort().forEach(n => { 
                    let first=true; 
                    Object.keys(mems[n].cats).forEach(c => { 
                        l.innerHTML += `<div class="grid grid-cols-[40%_20%_40%] py-0.5 text-[10px] border-b border-[#F0F0F0]">
                            ${first ? `<span class="font-bold">${n}</span>` : '<span></span>'}
                            <span class="text-center ${(CATEGORY_COLORS[c]||CATEGORY_COLORS.default).text}">${CATEGORY_NAMES[c]}</span>
                            <span class="text-right">$${mems[n].cats[c].toFixed(0)}</span>
                        </div>`; 
                        first=false; 
                    }); 
                    l.innerHTML += `<div class="grid grid-cols-[40%_20%_40%] py-1 mb-2 bg-[#F9F9F9] text-[10px] font-bold"><span></span><span class="text-center">å°è¨ˆ</span><span class="text-right">$${mems[n].total.toFixed(0)}</span></div>`; 
                });

                // --- æ ¸å¿ƒæ”¹å‹•ï¼šçµç®—å»ºè­° ---
                l.innerHTML += `<div class="text-[10px] font-bold text-[#7E92A1] mt-4 mb-2 border-b border-[#7E92A1] pb-1">çµç®—å»ºè­°</div>`;
                
                let debtors = [], creditors = [];
                for (let name in balances) {
                    if (balances[name] < -0.5) debtors.push({name, amount: Math.abs(balances[name])});
                    else if (balances[name] > 0.5) creditors.push({name, amount: balances[name]});
                }
                
                // å‚µå‹™å¤šçš„äººå…ˆé‚„çµ¦å‚µæ¬Šå¤šçš„äºº
                debtors.sort((a,b) => b.amount - a.amount);
                creditors.sort((a,b) => b.amount - a.amount);

                if (debtors.length === 0) {
                    l.innerHTML += `<div class="text-[10px] text-gray-400 py-1 text-center">æ‰€æœ‰æ¬¾é …å·²æ¸…ç®—ã€‚</div>`;
                } else {
                    let i = 0, j = 0;
                    while(i < debtors.length && j < creditors.length){
                        let payAmount = Math.min(debtors[i].amount, creditors[j].amount);
                        if (payAmount > 0.1) {
                            l.innerHTML += `
                                <div class="flex justify-between items-center py-2 px-1 text-[10px] border-b border-gray-50">
                                    <span class="font-bold text-[#CB8572]">${debtors[i].name}</span>
                                    <span class="text-gray-400">â¡ï¸ æ”¯ä»˜ $${payAmount.toFixed(0)} â¡ï¸</span>
                                    <span class="font-bold text-[#7E92A1]">${creditors[j].name}</span>
                                </div>`;
                        }
                        debtors[i].amount -= payAmount;
                        creditors[j].amount -= payAmount;
                        if(debtors[i].amount < 0.5) i++;
                        if(creditors[j].amount < 0.5) j++;
                    }
                }

                document.getElementById('split-expense-modal').style.display = 'flex';
            ï½
    
Â  Â  Â  Â  Â  Â  async function deleteSchedule(id) {
Â  Â  Â  Â  Â  Â  Â  Â  if(!confirm('ç¢ºå®šåˆªé™¤?')) return;
Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`, id));
Â  Â  Â  Â  Â  Â  Â  Â  loadSchedules(currentTripId, currentDayId);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function addSettingsMemberInput(val='') { const d=document.createElement('div'); d.className='flex gap-1 items-center'; d.innerHTML=`<input type="text" name="settings-member-name" value="${val}" class="compact-input w-full rounded text-center" placeholder="æˆå“¡"><button type="button" class="text-red-300 font-bold px-1 rm-btn">Ã—</button>`; d.querySelector('.rm-btn').onclick=()=>d.remove(); document.getElementById('settings-members-container').appendChild(d); }

Â  Â  Â  Â  Â  Â  function initApp() {
Â  Â  Â  Â  Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('rate-display-label').textContent = 'åŒ¯ç‡ â‰ˆ ...';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const app = initializeApp(firebaseConfig);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db = getFirestore(app);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  auth = getAuth(app);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userCred = await signInAnonymously(auth);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userCred.user;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.modal-overlay > div').forEach(el => el.style.position = 'relative');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof initNotifications === 'function') initNotifications();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const headerWrapper = document.getElementById('header-content-wrapper');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const weatherInfo = document.getElementById('weather-info-container');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (weatherInfo && weatherInfo.nextElementSibling) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btnContainer = weatherInfo.nextElementSibling;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!document.getElementById('notification-btn')) { }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const addScheduleModalContent = document.querySelector('#add-schedule-modal > div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(addScheduleModalContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addScheduleModalContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-base font-bold mb-2 text-[#4A4B4D] pr-8 truncate">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="add-schedule-modal-title">æ–°å¢è¡Œç¨‹</span>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-close-btn" class="absolute top-3 right-3 text-[#A9A9A9] hover:text-[#5F6368] text-2xl leading-none w-6 h-6 flex items-center justify-center">Ã—</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="add-schedule-form" class="space-y-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-3 gap-1.5 w-full">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block compact-label mb-0.5 text-center">æ—¥æœŸ</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="form-date" class="compact-input block w-[87%] mx-auto rounded border shadow-sm text-center p-0 py-0 text-[10px]" style="height: 28px !important; min-height: 36px !important;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block compact-label mb-0.5 text-center">æ™‚é–“</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="form-time" class="compact-input block w-[87%] mx-auto rounded border shadow-sm text-center p-0 py-0 text-[10px]" style="height: 28px !important; min-height: 36px !important;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block compact-label mb-0.5 text-center">é¡å‹</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="form-type" class="compact-input block w-[87%] mx-auto rounded border shadow-sm py-0 pl-1 pr-0 text-[10px]" style="height: 30px !important; min-height: 36px !important;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="location">ğŸ“ æ™¯é»</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="restaurant">ğŸ½ï¸ é¤å»³</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="coffee">â˜• å’–å•¡</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="accommodation">ğŸ›ï¸ ä½å®¿</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="äº¤é€š">ğŸš— äº¤é€š</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="shopping">ğŸ›ï¸ è³¼ç‰©</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2 items-center">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block compact-label mb-0.5">åœ°é»</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="form-location" class="compact-input block w-full rounded border shadow-sm px-2 text-xs" style="height: 32px !important;" placeholder="è¼¸å…¥åœ°é»åç¨±">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2 flex-shrink-0 pb-1 h-10 items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center justify-between h-full pt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="compact-label leading-none text-[10px] font-bold text-[#CB8572]">å¿…å»</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="form-must-go" class="w-3.5 h-3.5 accent-[#CB8572] cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center justify-between h-full pt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="compact-label leading-none text-[10px] font-bold text-[#7E92A1]">é¬§é˜</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="form-set-alarm" class="w-3.5 h-3.5 accent-[#7E92A1] cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block compact-label mb-0.5">åœ°å€</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="form-address" class="compact-input block w-full rounded border shadow-sm px-2 text-xs" style="height: 28px !important;" placeholder="Google Map é€£çµæˆ–åœ°å€">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="form-details" rows="4" class="compact-input block w-full rounded border shadow-sm !h-auto leading-normal p-2 text-xs" placeholder="å‚™è¨»èªªæ˜..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-50 p-2 rounded border border-gray-100 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center mb-1 gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block compact-label">æˆå“¡</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="add-member-btn" class="text-[#7E92A1] text-xs font-bold hover:text-[#5F6368] px-1 leading-none">ï¼‹</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="form-members-container" class="space-y-1 mb-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-[1fr_20px_1fr] gap-2 items-center mt-2 border-t border-gray-200 pt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-1 justify-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label id="form-currency-label" class="text-[10px] font-bold text-[#7E92A1] w-8 text-right">USD</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="form-amount" min="0" placeholder="0" class="w-full p-1 border border-[#E0E0E0] rounded text-right text-[11px] text-[#5F6368] bg-white text-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center text-gray-400 text-xs font-bold">=</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-1 justify-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[10px] font-bold text-[#A9A9A9] w-8 text-right">TWD</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="form-amount-twd" placeholder="0" class="w-full p-1 border border-[#E0E0E0] bg-[#E0E0E0] rounded text-right text-[11px] text-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center pt-2 mt-2 border-t border-[#E0E0E0]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="modal-delete-btn" class="px-3 py-1 h-7 text-white bg-[#CB8572] rounded text-xs font-bold flex-shrink-0 hover:bg-[#B56B5A] hidden">åˆªé™¤</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow flex justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="modal-save-btn" class="px-3 py-1 h-7 text-white bg-[#7E92A1] rounded text-xs font-bold flex-shrink-0 hover:bg-[#64748B] shadow-sm">å„²å­˜</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // åœ¨ initApp å‡½å¼å…§ï¼Œæ‰¾åˆ° split-expense-modal çš„è¨­å®š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const splitExpenseModalContent = document.querySelector('#split-expense-modal > div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (splitExpenseModalContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  splitExpenseModalContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-sm font-bold mb-2 flex justify-between items-center flex-shrink-0 text-[#4A4B4D]">èŠ±è²»<button id="split-expense-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button></h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-shrink-0 mb-2 bg-[#F9F9F9] p-2 rounded border border-[#E0E0E0]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-end mb-2 border-b border-[#E0E0E0] pb-0.5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[#5F6368] font-medium text-xs">ç¸½èŠ±è²»</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-extrabold text-[#4A4B4D]">TWD$ <span id="expense-total-amount">0</span></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-[28%_44%_28%] h-32 w-full items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="expense-legend-left" class="flex flex-col justify-center gap-1.5 pl-1 h-full overflow-hidden"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="expense-chart-container" class="relative h-full w-full flex justify-center items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="expense-chart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="expense-legend-right" class="flex flex-col justify-center gap-1.5 pr-1 items-end h-full overflow-hidden"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="overflow-y-auto flex-grow mb-1 pr-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="expense-member-list" class="space-y-0.5"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const settingsModalContent = document.querySelector('#settings-modal > div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (settingsModalContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settingsModalContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-base font-bold mb-3 flex justify-between items-center text-[#4A4B4D]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  è¨ˆç•«è¨­å®š <button id="settings-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="settings-form" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-[#7E92A1]">è¨ˆç•«åç¨±</label><input type="text" id="settings-trip-name" class="compact-input mt-0.5 block w-full rounded border"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-[0.8fr_1.5fr_0.7fr] gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-[#7E92A1]">åœ‹å®¶</label><select id="settings-trip-country" class="compact-input mt-0.5 block w-full rounded border h-[28px]" style="width: 88% !important; min-width: 0;"><option value="USA">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option><option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option><option value="KR">ğŸ‡°ğŸ‡· éŸ“åœ‹</option><option value="UK">ğŸ‡¬ğŸ‡§ è‹±åœ‹</option><option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-[#7E92A1]">é–‹å§‹æ—¥æœŸ</label><input type="date" id="settings-start-date" class="compact-input mt-0.5 block w-full rounded border text-center h-[28px] text-[10px]" style="width: 88% !important; min-width: 0;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-[#7E92A1]">å¤©æ•¸</label><input type="number" id="settings-num-days" min="1" class="compact-input mt-0.5 block w-full rounded border text-center h-[28px]" style="width: 88% !important; min-width: 0;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-[#7E92A1] mb-1">æˆå“¡</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="settings-members-container" class="grid grid-cols-3 gap-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="settings-add-member-btn" class="mt-2 text-[10px] text-[#7E92A1] font-medium">+ æ–°å¢æˆå“¡</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pt-3 flex justify-between items-center border-t border-gray-100 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="new-trip-from-settings-btn" class="px-3 py-1.5 text-xs text-[#7E92A1] bg-[#EBF2FA] rounded hover:bg-[#DCE6F2]">æ–°è¨ˆç•«</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2 justify-end flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="delete-trip-btn" class="px-3 py-1.5 text-white bg-[#CB8572] rounded text-xs hover:bg-[#B56B5A]">åˆªé™¤</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="settings-modal-save-btn" class="px-3 py-1.5 text-white bg-[#7E92A1] rounded text-xs hover:bg-[#64748B]">å„²å­˜</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newTripModalContent = document.querySelector('#new-trip-modal > div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newTripModalContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newTripModalContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-base font-bold mb-3 flex justify-between items-center text-[#4A4B4D]">æ–°å¢æ—…è¡Œè¨ˆç•«<button id="new-trip-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl">Ã—</button></h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="new-trip-form" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-[#7E92A1]">è¨ˆç•«åç¨±</label><input type="text" id="new-trip-name" class="compact-input mt-0.5 block w-full rounded border"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-[0.8fr_1.5fr_0.7fr] gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-[#7E92A1]">åœ‹å®¶</label><select id="new-trip-country" class="compact-input mt-0.5 block w-full rounded border h-[28px]" style="width: 88% !important; min-width: 0;"><option value="USA">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option><option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option><option value="KR">ğŸ‡°ğŸ‡· éŸ“åœ‹</option><option value="UK">ğŸ‡¬ğŸ‡§ è‹±åœ‹</option><option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-[#7E92A1]">é–‹å§‹æ—¥æœŸ</label><input type="date" id="new-trip-start-date" class="compact-input mt-0.5 block w-full rounded border text-center h-[28px] text-[10px]" style="width: 88% !important; min-width: 0;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-[#7E92A1]">å¤©æ•¸</label><input type="number" id="new-trip-days" min="1" class="compact-input mt-0.5 block w-full rounded border text-center h-[32px]" style="width: 88% !important; min-width: 0;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pt-3 flex justify-end"><button type="button" id="new-trip-modal-save-btn" class="px-3 py-1.5 text-white bg-[#7E92A1] rounded text-xs hover:bg-[#64748B]">æ–°å¢</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadTripList();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('trip-select', 'onchange', (e) => changeTrip(e.target.value));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('bar-calc-currency', 'onchange', calculateCurrency);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('bar-calc-amount', 'oninput', calculateCurrency);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('center-add-btn', 'onclick', () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!currentTripId) return alert('è«‹å…ˆå»ºè¨ˆç•«');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-schedule-form').reset();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-must-go').checked = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-set-alarm').checked = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editingScheduleId=null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modal-delete-btn').style.display='none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-schedule-modal-title').textContent = 'æ–°å¢è¡Œç¨‹';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t=tripData[currentTripId];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const d = getDateFromDayId(t, currentDayId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(d) document.getElementById('form-date').value=d.toISOString().split('T')[0];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-members-container').innerHTML='';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (t.members||[]).forEach(n=>addMemberInput(n));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!(t.members||[]).length){addMemberInput();addMemberInput();}Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-schedule-modal').style.display='flex';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('modal-close-btn', 'onclick', () => document.getElementById('add-schedule-modal').style.display='none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('modal-save-btn', 'onclick', submitSchedule);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('form-amount', 'oninput', (e) => document.getElementById('form-amount-twd').value = (e.target.value * currentTripRate).toFixed(0));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('form-amount-twd', 'oninput', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const twd = parseFloat(e.target.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isNaN(twd) && currentTripRate > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-amount').value = (twd / currentTripRate).toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (e.target.value === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-amount').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('btn-lists', 'onclick', loadLists);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('lists-modal-close-btn', 'onclick', () => document.getElementById('lists-modal').style.display='none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('split-expense-btn', 'onclick', loadExpenseSummary);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('split-expense-close-btn', 'onclick', () => document.getElementById('split-expense-modal').style.display='none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('settings-btn', 'onclick', () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const trip = tripData[currentTripId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!trip) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-trip-name').value = trip.name;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-trip-country').value = trip.country || 'TW';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-start-date').value = trip.startDate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-num-days').value = trip.numDays;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-modal').style.display = 'flex';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-members-container').innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (trip.members||[]).forEach(m => addSettingsMemberInput(m));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('new-trip-btn', 'onclick', () => document.getElementById('new-trip-modal').style.display='flex');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('new-trip-from-settings-btn', 'onclick', () => { document.getElementById('settings-modal').style.display='none'; document.getElementById('new-trip-from-settings-btn').style.display='none'; document.getElementById('new-trip-modal').style.display='flex'; });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('new-trip-modal-close-btn', 'onclick', () => document.getElementById('new-trip-modal').style.display='none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('new-trip-modal-save-btn', 'onclick', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const name = document.getElementById('new-trip-name').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const country = document.getElementById('new-trip-country').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const start = document.getElementById('new-trip-start-date').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const numDays = parseInt(document.getElementById('new-trip-days').value) || 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!name || !start) return alert("è«‹å¡«å¯«å®Œæ•´");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uid = auth.currentUser ? auth.currentUser.uid : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/Trips`), {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name, country, startDate: start, numDays: numDays, members: [], uid: uidÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pendingTripSwitchId = docRef.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('new-trip-modal').style.display='none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('settings-modal-close-btn', 'onclick', () => document.getElementById('settings-modal').style.display='none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('image-zoom-modal', 'onclick', () => document.getElementById('image-zoom-modal').style.display='none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('delete-trip-btn', 'onclick', async () => { if(confirm("åˆªé™¤æ­¤è¨ˆç•«ï¼Ÿ")) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`)); document.getElementById('settings-modal').style.display='none'; } });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('settings-add-member-btn', 'onclick', () => addSettingsMemberInput());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('add-member-btn', 'onclick', () => addMemberInput());

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safeBind('settings-modal-save-btn', 'onclick', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newName = document.getElementById('settings-trip-name').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newCountry = document.getElementById('settings-trip-country').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newStart = document.getElementById('settings-start-date').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newDays = parseInt(document.getElementById('settings-num-days').value) || 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const memInputs = document.querySelectorAll('input[name="settings-member-name"]');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newMembersList = [];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  memInputs.forEach(i => { if(i.value.trim()) newMembersList.push(i.value.trim()); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const trip = tripData[currentTripId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oldMembers = trip.members || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const addedMembers = newMembersList.filter(m => !oldMembers.includes(m));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const removedMembers = oldMembers.filter(m => !newMembersList.includes(m));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`), {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: newName, country: newCountry, startDate: newStart, numDays: newDays, members: newMembersListÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (addedMembers.length > 0 || removedMembers.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalBtnText = document.getElementById('settings-modal-save-btn').textContent;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-modal-save-btn').textContent = "æ›´æ–°è¡Œç¨‹ä¸­...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const schedulesRef = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await getDocs(schedulesRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updatePromises = snapshot.docs.map(scheduleDoc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sData = scheduleDoc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentSchedMembers = sData.members || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (removedMembers.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSchedMembers = currentSchedMembers.filter(m => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const name = typeof m === 'string' ? m : m.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return !removedMembers.includes(name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const membersToAdd = addedMembers.map(name => ({ name: name, amount: null }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const finalMembers = [...currentSchedMembers, ...membersToAdd];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`, scheduleDoc.id), { members: finalMembers });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all(updatePromises);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) { console.error("æ‰¹æ¬¡æ›´æ–°å¤±æ•—", err); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-modal-save-btn').textContent = originalBtnText;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('settings-modal').style.display='none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  changeTrip(currentTripId);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return { initApp };
Â  Â  Â  Â  })();
Â  Â  Â  Â  window.App.initApp();
Â  Â  </script>
</body>
</html>
