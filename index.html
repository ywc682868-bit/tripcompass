<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Trip Compass</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    html {
        scroll-snap-type: y mandatory;
        scroll-padding-top: 180px;
        scroll-behavior: smooth;
    }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* --- å®¹å™¨èˆ‡ä½ˆå±€ --- */
    #app-container {
        max-width: 500px;
        margin: 0 auto;
        min-height: 100vh;
        background-color: white;
        padding-top: 0px; 
        padding-bottom: 140px;
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    #schedule-list-container {
        padding-top: 180px; 
        padding-bottom: 85vh; 
        margin-top: 0; 
        position: relative; 
        z-index: 1; 
    }
    #schedule-list-container::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 600px; 
        background-color: white;
        z-index: -2; 
    }    
    
    /* --- è¡Œç¨‹å¡ç‰‡ (Trip Card) --- */
    .trip-card { 
        width: 100%; 
        margin-bottom: 2rem; 
        position: relative; 
        height: 100px; 
        display: flex; 
        z-index: 0;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        scroll-margin-top: 180px;
    }

    #schedule-list-container .trip-card:first-child {
        margin-top: 10px; 
    }

    .trip-card::before {
        content: '';
        position: absolute;
        left: 28px; 
        top: -6px;        
        bottom: -6px;        
        width: 2px;
        background-color: #9C8B74; 
        z-index: -1; 
        transform: translateX(-50%);
    }
    
    .trip-card:first-child::before { 
        top: -60px; 
        bottom: -6px; 
        height: auto; 
    }
    .trip-card:last-child::before { bottom: auto; height: 100%; }

    /* å¡ç‰‡è¦–è¦ºå®¹å™¨ */
    .trip-card-visual-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 0.75rem; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); 
        background-color: white; 
        z-index: 10; 
    }

    /* --- Header å›ºå®šå€ --- */
    header { 
        position: fixed;
        top: 0; 
        left: 0;
        right: 0;
        width: 100%; 
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        background-color: #ffffff;
        z-index: 50; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    #header-content-wrapper {
        padding-top: calc(15px + env(safe-area-inset-top)); 
        padding-bottom: 4px; 
        padding-left: 12px; 
        padding-right: 12px;
    }
    #trip-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%237E92A1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right center; background-repeat: no-repeat; background-size: 1.25em 1.25em; -webkit-appearance: none; appearance: none; background-color: transparent; font-weight: 800; color: #4A4B4D; border: none; padding-right: 1.5rem; cursor: pointer; }
    #trip-select:focus { outline: none; }
    #header-day-date-container { padding-bottom: 0px; margin-top: 2px; margin-bottom: 1px; line-height: 1.2; }

    /* --- Footer (åº•éƒ¨å·¥å…·åˆ—) --- */
    #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem 0.2rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
    .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 18px; font-weight: 300; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: transform 0.1s; }
    .prominent-integrated-btn:active { transform: scale(0.95); }
    #rate-display-label { font-size: 0.85rem; font-weight: bold; color: #7E92A1; line-height: 20px; }
    #bar-calc-result { font-size: 0.7rem; font-weight: bold; color: #7E92A1; }

    .swipe-item-container { position: relative; overflow: hidden; border-radius: 0.375rem; margin-bottom: 0.5rem; touch-action: pan-y; }
    
    /* æ»‘å‹•æŒ‰éˆ•å±¤ï¼šåŠ ä¸Š overflow hidden ç¢ºä¿åœ“è§’ */
    .swipe-item-delete-bg { 
        position: absolute; top: 0; bottom: 0; right: 0; width: 140px; 
        display: flex; align-items: center; justify-content: flex-end; 
        z-index: 0; 
        border-radius: 0.75rem;
        overflow: hidden;
    }
    
    /* å…§å®¹å±¤ï¼šåŠ ä¸Š overflow hidden ç¢ºä¿åœ“è§’ */
    .swipe-item-content { 
        position: relative; z-index: 10; background-color: white; 
        transition: transform 0.2s ease-out; transform: translateX(0); 
        width: 100%; display: flex; align-items: stretch; 
        border-radius: 0.75rem;
        overflow: hidden;
    }
    
    .card-right-col { 
        display: flex; 
        flex-direction: column; 
        justify-content: flex-start; 
        align-items: flex-start; 
        gap: 8px; 
        width: 95px; min-width: 95px; max-width: 95px; flex: 0 0 95px;
        border-left: none; padding-left: 6px; padding-bottom: 0.25rem; padding-top: 12px; position: relative; 
    }
    .card-right-col::before {
        content: ''; position: absolute; left: 0; top: 8%; bottom: 8%; width: 1px; background-color: #C0C0C0;
    }

    .info-block-content { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-end; gap: 4px; width: 100%; }
    
    .card-static-actions { 
        display: none !important; 
        width: 100%; 
        justify-content: flex-start !important; 
        gap: 2px; 
        padding: 0; 
        margin: 0; 
    }
    
    /* --- RWD Adjustments --- */
    @media (min-width: 501px) {
        .swipe-item-delete-bg { display: none !important; }
        .trip-card .swipe-item-content { cursor: pointer; } 
        .card-static-actions { display: flex !important; } 
        .trip-card .content-text-block { margin-top: 5px; }
        .desktop-del-btn { display: block !important; }
    }
    @media (max-width: 500px) {
        html { scroll-padding-top: 180px; }
        #schedule-list-container { padding-top: 180px; }
        .trip-card:first-child::before { top: -35px; }
        .trip-card .content-text-block { margin-top: 8px; }
        .desktop-del-btn { display: none !important; } 
        
        #currency-display-row { flex-wrap: nowrap !important; gap: 5px !important; }
        #rate-display-container { width: auto !important; flex: 0 0 auto !important; border-right: none !important; }
        #rate-display-label { font-size: 14px !important; white-space: nowrap !important; }
        #currency-display-row > div:last-child { width: auto !important; flex: 1 1 auto !important; justify-content: flex-end !important; }
        #bar-calc-amount { width: 50px !important; }
        #bar-calc-currency { width: 45px !important; }
        #btn-lists span:nth-child(2), #split-expense-btn span:nth-child(2) { font-size: 14px !important; }
    }

    /* --- Modals & Lists --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(95, 99, 104, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; line-height: 28px; color: #5F6368; border-color: #E0E0E0; border-width: 1px; box-sizing: border-box; }
    .compact-input:focus { border-color: #7E92A1; outline: none; ring: 1px solid #7E92A1; }
    .compact-label { font-size: 0.7rem; color: #7E92A1; font-weight: 700; margin-bottom: 0; }
    input[type="time"], input[type="date"] { text-align: center; }
    .list-tab-active { border-bottom: 2px solid #7E92A1; color: #7E92A1; font-weight: bold; }
    .list-tab-inactive { color: #A9A9A9; }
    .shopping-img-box { width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; position: relative; }
    .shopping-img-box img { width: 100%; height: 100%; object-fit: cover; }
</style>
</head>

<body>
    <div id="app-container">
        <header>
            <div id="header-content-wrapper" class="px-3 pb-1" style="padding-top: calc(15px + env(safe-area-inset-top));">
                <div class="flex justify-between items-start">
                    
                    <div class="flex flex-col flex-grow min-w-0 mr-2">
                        <div class="flex items-center w-full mb-0.5">
                              <button id="settings-btn" class="p-1 mr-0.5 text-[#888888] hover:text-[#5F6368]" title="è¨ˆç•«è¨­å®š">ğŸ“…</button>
                              <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
                              <div class="flex items-center flex-shrink-0 ml-2">
                                <button id="new-trip-btn" class="px-2 py-1 bg-[#7E92A1] text-white text-xs font-semibold rounded hover:bg-[#64748B] transition-colors hidden">+ æ–°å¢</button>
                              </div>
                        </div>
                        
                        <div class="flex items-center space-x-1 text-[#888888] ml-1 mb-1.5">
                              <span class="font-bold text-xs">ğŸ‘«</span>
                              <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
                        </div>

                        <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
                        
                        <div id="header-day-date-container">
                            <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
                        </div>
                    </div>

                    <div id="weather-info-container" class="flex flex-col items-end justify-start text-[#888888] cursor-pointer flex-shrink-0 gap-2 pt-1">
                          <div id="header-weather-icon" class="text-4xl leading-none mb-0"></div>
                          <span id="header-weather-temp" class="text-sm font-bold"></span>
                          <span id="header-location-name" class="text-xs font-bold mt-0.5"></span>
                          <span id="header-clothing-advice" class="text-xs font-bold text-[#CB8572] mt-0.5 whitespace-nowrap"></span>
                    </div>

                </div>
            </div>
        </header>
        <div id="schedule-list-container" class="px-3 pt-0 pb-4">
            <div class="p-4 text-center text-[#A9A9A9] text-xs">è¡Œç¨‹åŠ è¼‰ä¸­...</div>
        </div>
    </div>

    <div id="combined-bottom-bar">
        <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5" style="flex-wrap: nowrap !important;">
            <div id="rate-display-container" class="flex items-center justify-center border-r border-gray-100" style="width: 50% !important; flex: 0 0 50% !important; border-right: 1px solid #f3f4f6 !important;">
                <span id="rate-display-label">åŒ¯ç‡ â‰ˆ ...</span> 
            </div>
            <div class="flex items-center justify-start gap-0.5 pl-3" style="width: 50% !important; flex: 0 0 50% !important;">
                <select id="bar-calc-currency" class="bg-gray-50 border border-[#E0E0E0] rounded p-0.5 text-[10px] font-bold text-[#5F6368] h-6 w-10 text-center appearance-none cursor-pointer">
                    <option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="CNY">CNY</option><option value="GBP">GBP</option>
                </select>
                <input type="number" id="bar-calc-amount" class="w-20 h-6 text-[10px] p-0.5 border border-[#E0E0E0] rounded text-center font-medium text-[#5F6368]">
                <span class="text-[1.1rem] font-bold text-[#A9A9A9]">=</span>
                <span class="text-[0.7rem] font-bold text-[#7E92A1] leading-[26px]">TWD</span>
                <input type="text" id="bar-calc-result" readonly value="0" class="w-12 h-6 p-0 border-none bg-transparent text-[#7E92A1] font-extrabold text-left focus:outline-none truncate pl-1">
            </div>
        </div>

        <div class="flex justify-between items-center w-full px-2 py-1.5">
             <button id="btn-lists" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888] hover:text-[#7E92A1]">
                 <span class="text-xl leading-none">ğŸ“</span>
                 <span class="text-[12px] font-bold leading-none">æ¸…å–®</span>
             </button>
             
             <div class="flex-none px-4">
                 <button id="center-add-btn" class="prominent-integrated-btn shadow-md">ï¼‹</button>
             </div>
             
             <button id="split-expense-btn" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888] hover:text-[#8F9E8B]">
                 <span class="text-xl leading-none">ğŸ’°</span>
                 <span class="text-[12px] font-bold leading-none">èŠ±è²»</span>
             </button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto relative"></div>
    </div>
    <div id="lists-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm max-h-[80vh] flex flex-col relative"><h3 class="text-base font-bold mb-2 flex justify-between items-center flex-shrink-0 text-[#4A4B4D]">æ¸…å–®<button id="lists-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button></h3><div id="list-tabs" class="flex gap-1 border-b border-gray-100 mb-2 overflow-x-auto no-scrollbar flex-shrink-0"></div><div id="list-content" class="flex-grow overflow-y-auto flex flex-col relative"></div></div></div>
    <div id="image-zoom-modal" class="modal-overlay hidden z-[150] bg-black/80"><img id="zoom-img" class="max-w-[95%] max-h-[90%] rounded shadow-lg object-contain"></div>
    <div id="settings-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>
    <div id="new-trip-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"><h3 class="text-base font-bold mb-3 flex justify-between items-center text-[#4A4B4D]">æ–°å¢æ—…è¡Œè¨ˆç•«<button id="new-trip-modal-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl">Ã—</button></h3><div id="new-trip-modal-content"></div></div></div>
    <div id="split-expense-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]"><h3 class="text-sm font-bold mb-2 flex justify-between items-center flex-shrink-0 text-[#4A4B4D]">èŠ±è²»<button id="split-expense-close-btn" class="text-[#A9A9A9] hover:text-[#5F6368] text-xl leading-none">Ã—</button></h3><div class="flex-shrink-0 mb-2 bg-[#F9F9F9] p-2 rounded border border-[#E0E0E0]"><div class="flex justify-between items-end mb-1 border-b border-[#E0E0E0] pb-0.5"><span class="text-[#5F6368] font-medium text-xs">ç¸½èŠ±è²»</span><span class="text-sm font-extrabold text-[#4A4B4D]">TWD$ <span id="expense-total-amount">0</span></span></div><div id="expense-chart-container" class="h-32 w-full relative flex justify-center items-center"><canvas id="expense-chart"></canvas></div></div><div class="overflow-y-auto flex-grow mb-1 pr-1"><div id="expense-member-list" class="space-y-0.5"></div></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    window.App = (function() {
        const appId = 'my-trip-app';
        const firebaseConfig = {
            apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28",
            authDomain: "mytravelplanner-36283.firebaseapp.com",
            projectId: "mytravelplanner-36283",
            storageBucket: "mytravelplanner-36283.firebasestorage.app",
            messagingSenderId: "86504733738",
            appId: "1:86504733738:web:5167a6a795eb206dfed753"
        };            
        const COUNTRY_CONFIG = { 
            'USA': { name: 'ç¾åœ‹', currency: 'USD', localName: 'New York', lat: 40.71, lon: -74.00, img: 'usa' }, 
            'JP': { name: 'æ—¥æœ¬', currency: 'JPY', localName: 'æ±äº¬', lat: 35.68, lon: 139.76, img: 'japan' }, 
            'KR': { name: 'éŸ“åœ‹', currency: 'KRW', localName: 'ì„œìš¸', lat: 37.56, lon: 126.97, img: 'korea' }, 
            'UK': { name: 'è‹±åœ‹', currency: 'GBP', localName: 'London', lat: 51.50, lon: -0.12, img: 'london' }, 
            'TW': { name: 'å°ç£', currency: 'TWD', localName: 'å°åŒ—', lat: 25.03, lon: 121.56, img: 'taiwan' } 
        };
        
        const CATEGORY_COLORS = { 'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, 'äº¤é€š': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' }, 'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
        const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];
        const CATEGORY_NAMES = { 'location': 'æ™¯é»', 'restaurant': 'é¤å»³', 'coffee': 'å’–å•¡å»³', 'äº¤é€š': 'äº¤é€š', 'shopping': 'è³¼ç‰©', 'accommodation': 'ä½å®¿', 'default': 'æœªåˆ†é¡' };

        let db, auth, currentUser;
        let currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {};
        let unsubscribeSchedule = null, unsubscribeTrips = null, unsubscribeLists = null, expenseChart = null, currentTripRate = 1;
        let currentListTabId = null; 
        let pendingTripSwitchId = null; 

        // --- åŸºç¤å·¥å…· ---
        function formatDateForHeader(date) { const year = String(date.getFullYear()).slice(-2); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); const dayOfWeekMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; return `${year}.${month}.${day} ${dayOfWeekMap[date.getDay()]}`; }
        function dateDiffInDays(date2, date1) { return Math.ceil(Math.abs(date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24)); }
        function getDateFromDayId(trip, dayId) { if (!trip || !trip.startDate) return null; const d = new Date(trip.startDate); d.setDate(d.getDate() + (parseInt(dayId.replace('Day ', '')) - 1)); return d; }
        function getCardStyle(type) { const c = CATEGORY_COLORS[type] || CATEGORY_COLORS['default']; const icons = {'coffee':'â˜•','restaurant':'ğŸ½ï¸','location':'ğŸ“','äº¤é€š':'ğŸš—','shopping':'ğŸ›ï¸','accommodation':'ğŸ›ï¸'}; return { color: c.bg, icon: icons[type] || 'â“', hex: c.hex, text: c.text }; }
        function navigateToMap(input) { if (!input) return; const url = (input.includes('http') || input.includes('maps.')) ? input : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(input)}`; window.open(url, '_blank'); }
        function formatCurrency(value) { if (typeof value !== 'number') value = parseFloat(value); if (isNaN(value) || value === 0) return '0'; return value.toFixed(0); }
        async function fetchExchangeRate(baseCurrency) { const fallback = { 'USD': 32.5, 'JPY': 0.215, 'KRW': 0.023, 'GBP': 41.2, 'CNY': 4.5, 'TWD': 1 }; if (!baseCurrency || baseCurrency === 'TWD') return 1; try { const r = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency}`); const d = await r.json(); if (d && d.rates && d.rates.TWD) return d.rates.TWD; } catch (e) {} return fallback[baseCurrency] || 1; }

        function updateHeaderDateWithDDay(d) {
            if (!d) return;
            const dateStr = formatDateForHeader(d);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let tripCountdownHtml = '';
            const trip = tripData[currentTripId];
            if (trip && trip.startDate) {
                const tripStart = new Date(trip.startDate);
                tripStart.setHours(0, 0, 0, 0);
                const diffTimeTrip = today.getTime() - tripStart.getTime();
                const diffDaysTrip = Math.floor(diffTimeTrip / (1000 * 60 * 60 * 24));
                let dString = diffDaysTrip === 0 ? 'D-0' : (diffDaysTrip > 0 ? `D+${diffDaysTrip + 1}` : `D${diffDaysTrip}`);
                tripCountdownHtml = `<span class="ml-2 text-[#7E92A1] text-xs font-bold tracking-wide">ğŸ›« ${dString}</span>`;
            }

            const anniversary = new Date('2025-08-01T00:00:00');
            const diffTimeLove = today.getTime() - anniversary.getTime();
            const diffDaysLove = Math.floor(diffTimeLove / (1000 * 60 * 60 * 24)) + 1;
            const loveHtml = !isNaN(diffDaysLove) ? `<span class="ml-2 text-[#D4A5A5] text-xs font-extrabold tracking-wide">â¤ï¸ ${diffDaysLove}å¤©</span>` : '';
            
            const el = document.getElementById('header-day-date-display');
            if(el) el.innerHTML = `${dateStr}${tripCountdownHtml}${loveHtml}`;
        }

        // --- å¤©æ°£èˆ‡å®šä½ ---
        async function updateHeaderInfo() {
            const trip = tripData[currentTripId]; if (!trip) return;
            const config = COUNTRY_CONFIG[trip.country || 'TW'] || COUNTRY_CONFIG['TW'];
            let lat = config.lat, lon = config.lon, displayName = config.localName;

            if (navigator.geolocation) {
                try {
                    const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, {timeout: 5000}));
                    lat = pos.coords.latitude; lon = pos.coords.longitude;
                    const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-TW`);
                    const geoData = await geoRes.json();
                    if (geoData && geoData.address) {
                        displayName = geoData.address.city || geoData.address.town || geoData.address.suburb || geoData.address.state || displayName;
                    }
                } catch (e) { console.log("å®šä½å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼"); }
            }

            document.getElementById('header-location-name').textContent = displayName;
            currentTripRate = await fetchExchangeRate(config.currency);
            document.getElementById('header-members-list').innerHTML = (trip.members || []).map((m, i) => `<span class="${MEMBER_COLORS[i % MEMBER_COLORS.length]} mr-1">${m}</span>`).join('') || 'å°šæœªè¨­å®š';

            try { 
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`); 
                const data = await res.json(); 
                const code = data.current.weather_code;
                let icon = code > 50 ? 'ğŸŒ§ï¸' : (code > 3 ? 'â˜ï¸' : 'â˜€ï¸');
                document.getElementById('header-weather-icon').textContent = icon; 
                document.getElementById('header-weather-temp').textContent = `${data.current.temperature_2m.toFixed(1)}Â°C`; 
                
                let temp = data.current.temperature_2m, clothing = temp >= 25 ? 'ğŸ½ çŸ­è¢–' : (temp >= 20 ? 'ğŸ‘• è–„å¤–å¥—' : (temp >= 15 ? 'ğŸ§¥ å¤–å¥—' : 'ğŸ§£ ç¾½çµ¨'));
                if ([51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99].includes(code)) clothing += ' â˜”é›¨å…·';
                document.getElementById('header-clothing-advice').textContent = clothing;
            } catch (e) {}
        }

        // --- è¡Œç¨‹è¼‰å…¥èˆ‡åˆ‡æ› ---
        function changeTrip(tripId) { 
            currentTripId = tripId; 
            currentDayId = 'Day 1'; 
            currentListTabId = null; 
            updateHeaderInfo(); 
            renderDayTabs(); 
            loadSchedules(currentTripId, currentDayId); 
            checkAndCreateDefaultLists(tripId); 
        }

        const loadSchedules = function(tripId, dayId) {
            if (unsubscribeSchedule) unsubscribeSchedule();
            const container = document.getElementById('schedule-list-container');
            unsubscribeSchedule = onSnapshot(query(collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Schedules`), where('dayId', '==', dayId), orderBy('Time')), (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) container.innerHTML = `<div class="p-4 text-center text-[#A9A9A9] text-xs">æ­¤æ—¥æš«ç„¡è¡Œç¨‹ã€‚</div>`;
                else snapshot.forEach(doc => container.appendChild(createTripCard({ id: doc.id, ...doc.data() })));
                const trip = tripData[currentTripId];
                if (trip) updateHeaderDateWithDDay(getDateFromDayId(trip, dayId));
            });
        };

        const loadTripList = async function() {
            unsubscribeTrips = onSnapshot(collection(db, `artifacts/${appId}/public/data/Trips`), (snapshot) => {
                const select = document.getElementById('trip-select');
                const container = document.getElementById('schedule-list-container');
                select.innerHTML = ''; tripData = {};
                if (snapshot.empty) {
                    container.innerHTML = `<div class="p-8 text-center text-[#A9A9A9] text-xs">å°šç„¡æ—…è¡Œè¨ˆç•«ï¼Œè«‹é»æ“Šå³ä¸Šæ–¹æ–°å¢ã€‚</div>`;
                    document.getElementById('new-trip-btn').classList.remove('hidden');
                    return;
                }
                snapshot.forEach(doc => {
                    tripData[doc.id] = { id: doc.id, ...doc.data() };
                    const op = document.createElement('option'); op.value = doc.id; op.textContent = doc.data().name; select.appendChild(op);
                });
                currentTripId = pendingTripSwitchId || select.value;
                pendingTripSwitchId = null;
                select.value = currentTripId;
                changeTrip(currentTripId);
            });
        };

        // --- è¡Œç¨‹å¡ç‰‡å»ºç«‹ ---
        function createTripCard(schedule) {
            const style = getCardStyle(schedule.Type);
            const rate = schedule.Rate || 1;
            const amountTWD = (schedule.Amount || 0) * rate;
            const members = schedule.members || [];
            
            // åˆ†å¸³è¨ˆç®—
            let totalFixed = 0, participantsCount = 0;
            members.forEach(m => {
                if (m.amount !== null && !m.isPayer) totalFixed += (m.amount * rate);
                if (m.amount === null || m.isPayer) participantsCount++;
            });
            const perPersonTWD = participantsCount > 0 ? (amountTWD - totalFixed) / participantsCount : 0;

            const card = document.createElement('div');
            card.className = 'trip-card';
            card.innerHTML = `
                <div class="trip-card-visual-wrapper">
                    <div class="swipe-item-delete-bg">
                        <button class="bg-[#7E92A1] text-white px-4 h-full text-xs font-bold" onclick="App.openEditScheduleModal('${schedule.id}')">ä¿®æ”¹</button>
                        <button class="bg-[#CB8572] text-white px-4 h-full text-xs font-bold" onclick="App.deleteSchedule('${schedule.id}')">åˆªé™¤</button>
                    </div>
                    <div class="swipe-item-content">
                        <div class="${CATEGORY_COLORS[schedule.Type]?.bg || 'bg-gray-400'} w-14 flex-none flex flex-col items-center justify-center text-white py-2">
                            <span class="text-[10px] font-bold">${schedule.Time}</span>
                            <span class="text-xl">${style.icon}</span>
                        </div>
                        <div class="flex-grow p-2 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="text-xs font-bold truncate text-[#4A4B4D]">${schedule.Location}</h3>
                                <div class="flex gap-1 overflow-hidden ml-1">
                                    ${members.map((m,i)=>`<span class="${MEMBER_COLORS[i%5]} text-[9px] font-bold">${typeof m==='string'?m:m.name}</span>`).join('')}
                                </div>
                            </div>
                            <p class="text-[9px] text-gray-400 line-clamp-2 mt-1">${schedule.èªªæ˜ || ''}</p>
                        </div>
                        <div class="card-right-col">
                            <span class="text-[#8F9E8B] font-bold text-[10px]">TWD$${amountTWD.toFixed(0)}</span>
                            <span class="text-gray-400 text-[9px]">ğŸ‘¤$${perPersonTWD.toFixed(0)}</span>
                            ${schedule.MustGo ? '<span class="text-[8px] text-[#CB8572] border border-[#CB8572] px-1 rounded">å¿…å»</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
            const content = card.querySelector('.swipe-item-content');
            const action = card.querySelector('.swipe-item-delete-bg');
            enableSwipeToDelete(content, action);
            content.onclick = () => { if(window.innerWidth > 500) openEditScheduleModal(schedule); };
            return card;
        }

        // --- åˆ†å¸³å½™æ•´ ---
        async function loadExpenseSummary() {
            if(!currentTripId) return; 
            const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
            let total = 0, types = {}, mems = {}, balances = {};
            
            snap.forEach(d => {
                const da = d.data(); const rate = da.Rate || 1; const tTWD = (da.Amount || 0) * rate;
                if(tTWD <= 0) return;
                total += tTWD; types[da.Type] = (types[da.Type] || 0) + tTWD;
                
                let scheduleMembers = da.members || [];
                let totalFixedSettled = 0;
                let payers = [];
                
                scheduleMembers.forEach(m => {
                    const name = typeof m === 'string' ? m : m.name;
                    const amtTWD = (m.amount || 0) * rate;
                    if(!mems[name]) mems[name] = {total: 0, cats: {}};
                    if (m.isPayer) { balances[name] = (balances[name] || 0) + amtTWD; payers.push(name); }
                    else if (m.amount !== null) {
                        totalFixedSettled += amtTWD;
                        mems[name].total += amtTWD; mems[name].cats[da.Type] = (mems[name].cats[da.Type] || 0) + amtTWD;
                    }
                });

                const amountToSplit = tTWD - totalFixedSettled;
                if (amountToSplit > 0) {
                    let participants = scheduleMembers.filter(m => m.amount === null || m.isPayer);
                    if (participants.length > 0) {
                        const share = amountToSplit / participants.length;
                        participants.forEach(m => {
                            const name = typeof m === 'string' ? m : m.name;
                            balances[name] = (balances[name] || 0) - share;
                            if(!mems[name]) mems[name] = {total: 0, cats: {}};
                            mems[name].total += share; mems[name].cats[da.Type] = (mems[name].cats[da.Type] || 0) + share;
                        });
                    }
                }
            });

            // æ›´æ–° UI
            document.getElementById('expense-total-amount').textContent = total.toFixed(0);
            const ctx = document.getElementById('expense-chart').getContext('2d');
            if(expenseChart) expenseChart.destroy();
            const sortedKeys = Object.keys(types).sort((a,b) => types[b] - types[a]);
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{ data: sortedKeys.map(k => types[k]), backgroundColor: sortedKeys.map(k => (CATEGORY_COLORS[k]||CATEGORY_COLORS.default).hex), borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false } } }
            });

            // çµç®—å»ºè­°èˆ‡æ¸…å–®
            const listEl = document.getElementById('expense-member-list');
            listEl.innerHTML = '';
            Object.keys(mems).forEach(name => {
                listEl.innerHTML += `<div class="flex justify-between text-[10px] py-1 border-b border-gray-50"><b>${name}</b> <span>TWD$ ${mems[name].total.toFixed(0)}</span></div>`;
            });

            document.getElementById('split-expense-modal').style.display = 'flex';
        }

        // --- å…¶é¤˜è¼”åŠ©åŠŸèƒ½ (ç°¡åŒ–) ---
        function renderDayTabs() {
            const container = document.getElementById('day-tabs-container'); container.innerHTML = '';
            const trip = tripData[currentTripId]; if (!trip) return;
            for (let i = 0; i < (trip.numDays || 1); i++) {
                const dId = `Day ${i + 1}`; const btn = document.createElement('button');
                btn.className = `px-3 py-1 text-xs font-bold rounded-full ${dId === currentDayId ? 'bg-gray-600 text-white' : 'bg-gray-200 text-gray-600'}`;
                btn.textContent = dId; btn.onclick = () => { currentDayId = dId; renderDayTabs(); loadSchedules(currentTripId, currentDayId); };
                container.appendChild(btn);
            }
        }

        function enableSwipeToDelete(contentEl, actionEl) {
            let startX = 0, currentTranslate = 0;
            contentEl.ontouchstart = (e) => { startX = e.touches[0].clientX; contentEl.style.transition = 'none'; };
            contentEl.ontouchmove = (e) => { 
                let diff = e.touches[0].clientX - startX;
                if (diff < 0) { currentTranslate = Math.max(diff, -140); contentEl.style.transform = `translateX(${currentTranslate}px)`; }
            };
            contentEl.ontouchend = () => {
                contentEl.style.transition = 'transform 0.3s ease';
                if (currentTranslate < -70) { contentEl.style.transform = 'translateX(-140px)'; }
                else { contentEl.style.transform = 'translateX(0)'; }
            };
        }

        async function checkAndCreateDefaultLists(tripId) {
            const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Lists`));
            if (snap.empty) {
                const col = collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Lists`);
                await addDoc(col, {name: 'ç‰©å“', type: 'check', order: 1, items: []});
                await addDoc(col, {name: 'è³¼ç‰©', type: 'shopping', order: 2, items: []});
            }
        }

        function initApp() {
            document.addEventListener('DOMContentLoaded', async () => {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); auth = getAuth(app);
                await signInAnonymously(auth);
                loadTripList();

                // ç¶å®šåŸºç¤äº‹ä»¶
                document.getElementById('center-add-btn').onclick = () => {
                    if(!currentTripId) return alert("è«‹å…ˆå»ºç«‹è¨ˆç•«");
                    editingScheduleId = null;
                    document.getElementById('add-schedule-form').reset();
                    document.getElementById('add-schedule-modal').style.display = 'flex';
                };
                document.getElementById('modal-close-btn').onclick = () => document.getElementById('add-schedule-modal').style.display = 'none';
                document.getElementById('split-expense-btn').onclick = loadExpenseSummary;
                document.getElementById('split-expense-close-btn').onclick = () => document.getElementById('split-expense-modal').style.display = 'none';
            });
        }

        return { initApp };
    })();
    window.App.initApp();
</script>
</body>
</html>
