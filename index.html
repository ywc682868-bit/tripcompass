<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Trip Compass</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ÂÖ®ÂüüË®≠ÂÆö --- */
        html { scroll-snap-type: y mandatory; scroll-padding-top: 180px; scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background-color: white; padding-bottom: 140px; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        #schedule-list-container { padding-top: 180px; padding-bottom: 85vh; position: relative; z-index: 1; }
        
        /* Ë°åÁ®ãÂç°ÁâáË¶ñË¶∫ */
        .trip-card { width: 100%; margin-bottom: 2rem; position: relative; height: 100px; display: flex; scroll-snap-align: start; scroll-margin-top: 180px; }
        .trip-card::before { content: ''; position: absolute; left: 28px; top: -6px; bottom: -6px; width: 2px; background-color: #9C8B74; z-index: -1; transform: translateX(-50%); }
        .trip-card:first-child::before { top: -60px; }
        .trip-card-visual-wrapper { position: relative; width: 100%; height: 100%; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); background-color: white; z-index: 10; overflow: hidden; }

        header { position: fixed; top: 0; left: 0; right: 0; width: 100%; max-width: 500px; margin: 0 auto; background-color: #ffffff; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
        
        .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; border: none; }
        .swipe-item-delete-bg { position: absolute; top: 0; bottom: 0; right: 0; width: 140px; display: flex; z-index: 0; }
        .swipe-item-content { position: relative; z-index: 10; background-color: white; transition: transform 0.2s ease-out; width: 100%; display: flex; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; border: 1px solid #E0E0E0; border-radius: 4px; }
        .compact-label { font-size: 0.7rem; color: #7E92A1; font-weight: 700; }
        
        .shopping-img-box { width: 50px; height: 50px; background: #f0f0f0; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; }
        .shopping-img-box img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>

<body>
    <div id="app-container">
        <header>
            <div id="header-content-wrapper" class="px-3 pb-1" style="padding-top: calc(15px + env(safe-area-inset-top));">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col flex-grow min-w-0 mr-2">
                        <div class="flex items-center w-full mb-0.5">
                            <button id="settings-btn" class="p-1 mr-0.5 text-[#888888]">üìÖ</button>
                            <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
                        </div>
                        <div id="header-members-list" class="truncate text-xs font-bold text-gray-400 ml-1 mb-1.5"></div>
                        <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
                        <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
                    </div>
                    <div id="weather-info-container" class="flex flex-col items-end justify-start text-[#888888] cursor-pointer pt-1">
                        <div id="header-weather-icon" class="text-4xl leading-none"></div>
                        <span id="header-weather-temp" class="text-sm font-bold"></span>
                        <span id="header-location-name" class="text-xs font-bold">ÂÆö‰Ωç‰∏≠...</span>
                        <span id="header-clothing-advice" class="text-[10px] font-bold text-[#CB8572] mt-0.5"></span>
                    </div>
                </div>
            </div>
        </header>

        <div id="schedule-list-container" class="px-3 pt-0 pb-4"></div>
    </div>

    <div id="combined-bottom-bar">
        <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5 items-center">
            <div id="rate-display-container" class="flex-1 text-center border-r border-gray-100">
                <span id="rate-display-label" class="text-xs font-bold text-[#7E92A1]">ÂåØÁéá ‚âà ...</span>
            </div>
            <div class="flex-1 flex items-center justify-center gap-1">
                <select id="bar-calc-currency" class="text-[10px] border rounded h-6 w-10"><option value="JPY">JPY</option></select>
                <input type="number" id="bar-calc-amount" class="w-16 h-6 border rounded text-center text-[10px]">
                <span class="text-xs text-gray-400">=</span>
                <span id="bar-calc-result" class="text-xs font-extrabold text-[#7E92A1]">0</span>
                <span class="text-[10px] text-gray-400">TWD</span>
            </div>
        </div>
        <div class="flex justify-between items-center w-full px-2 py-1.5">
             <button id="btn-lists" class="flex-1 text-center"><span class="text-xl">üìù</span><span class="block text-[10px] font-bold">Ê∏ÖÂñÆ</span></button>
             <button id="center-add-btn" class="prominent-integrated-btn mx-4">Ôºã</button>
             <button id="split-expense-btn" class="flex-1 text-center"><span class="text-xl">üí∞</span><span class="block text-[10px] font-bold">Ëä±Ë≤ª</span></button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay"></div>
    <div id="lists-modal" class="modal-overlay"></div>
    <div id="split-expense-modal" class="modal-overlay"></div>
    <div id="settings-modal" class="modal-overlay"></div>
    <div id="new-trip-modal" class="modal-overlay"></div>
    <div id="image-zoom-modal" class="modal-overlay z-[150] bg-black/80"><img id="zoom-img" class="max-w-[95%]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.App = (function() {
            const appId = 'my-trip-app';
            const firebaseConfig = {
                apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28",
                authDomain: "mytravelplanner-36283.firebaseapp.com",
                projectId: "mytravelplanner-36283",
                storageBucket: "mytravelplanner-36283.firebasestorage.app",
                messagingSenderId: "86504733738",
                appId: "1:86504733738:web:5167a6a795eb206dfed753"
            };
            
            const COUNTRY_CONFIG = { 
                'USA': { currency: 'USD', localName: 'New York', lat: 40.71, lon: -74.00 }, 
                'JP': { currency: 'JPY', localName: 'Êù±‰∫¨', lat: 35.68, lon: 139.76 }, 
                'KR': { currency: 'KRW', localName: 'ÏÑúÏö∏', lat: 37.56, lon: 126.97 }, 
                'UK': { currency: 'GBP', localName: 'London', lat: 51.50, lon: -0.12 }, 
                'TW': { currency: 'TWD', localName: 'Âè∞Âåó', lat: 25.03, lon: 121.56 } 
            };
            const CATEGORY_COLORS = { 'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, '‰∫§ÈÄö': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' }, 'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
            const CATEGORY_NAMES = { 'location': 'ÊôØÈªû', 'restaurant': 'È§êÂª≥', 'coffee': 'ÂíñÂï°Âª≥', '‰∫§ÈÄö': '‰∫§ÈÄö', 'shopping': 'Ë≥ºÁâ©', 'accommodation': '‰ΩèÂÆø' };
            const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];

            let db, auth, currentUser, currentTripId = '', currentDayId = 'Day 1', tripData = {}, currentTripRate = 1, expenseChart = null, currentListTabId = null, editingScheduleId = null;
            let unsubscribeSchedule = null, unsubscribeTrips = null, unsubscribeLists = null;

            // --- Ê†∏ÂøÉÂ∑•ÂÖ∑ ---
            function safeBind(id, event, handler) { const el = document.getElementById(id); if (el) el[event] = handler; }
            function dateDiffInDays(d2, d1) { return Math.ceil(Math.abs(new Date(d2) - new Date(d1)) / 86400000); }
            async function fetchExchangeRate(curr) { try { const r = await fetch(`https://open.er-api.com/v6/latest/${curr}`); const d = await r.json(); return d.rates.TWD || 1; } catch(e) { return 1; } }

            // --- Â§©Ê∞£ËàáÂÆö‰Ωç ---
            async function updateWeatherByCoords(lat, lon, customName = null) {
                try {
                    const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`);
                    const wData = await wRes.json();
                    let name = customName;
                    if (!name) {
                        const gRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh-TW`);
                        const gData = await gRes.json();
                        name = gData.city || gData.locality || "ÁõÆÂâç‰ΩçÁΩÆ";
                    }
                    const code = wData.current.weather_code;
                    document.getElementById('header-weather-icon').textContent = code > 50 ? 'üåßÔ∏è' : code > 3 ? '‚òÅÔ∏è' : '‚òÄÔ∏è';
                    document.getElementById('header-weather-temp').textContent = `${wData.current.temperature_2m}¬∞C`;
                    document.getElementById('header-location-name').textContent = name;
                } catch(e) {}
            }

            function updateWeatherByCurrentLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (p) => updateWeatherByCoords(p.coords.latitude, p.coords.longitude),
                        () => updateWeatherByDestination(),
                        { timeout: 5000 }
                    );
                } else { updateWeatherByDestination(); }
            }

            async function updateWeatherByDestination() {
                const t = tripData[currentTripId]; if(!t) return;
                const c = COUNTRY_CONFIG[t.country || 'TW'] || COUNTRY_CONFIG['TW'];
                updateWeatherByCoords(c.lat, c.lon, c.localName);
            }

            // --- Ë°åÁ®ãËàáÊ∏ÖÂñÆÈÇèËºØ ---
            function createTripCard(s) {
                const style = CATEGORY_COLORS[s.Type] || CATEGORY_COLORS.default;
                const amtTWD = (s.Amount || 0) * (s.Rate || 1);
                const card = document.createElement('div');
                card.className = 'trip-card px-3';
                card.innerHTML = `
                    <div class="trip-card-visual-wrapper flex">
                        <div class="${style.bg} w-14 flex flex-col items-center justify-center text-white text-[10px] font-bold">
                            <span>${s.Time}</span>
                            <span class="text-xl my-1">${s.Type==='coffee'?'‚òï':s.Type==='restaurant'?'üçΩÔ∏è':'üìç'}</span>
                        </div>
                        <div class="flex-grow p-2 min-w-0">
                            <div class="flex justify-between"><h3 class="text-xs font-bold truncate">${s.Location}</h3></div>
                            <p class="text-[10px] text-gray-400 line-clamp-2">${s.Ë™™Êòé || ''}</p>
                            <div class="mt-1 text-[10px] font-bold text-[#8F9E8B]">TWD$${amtTWD.toFixed(0)}</div>
                        </div>
                    </div>
                `;
                card.onclick = () => openEditScheduleModal(s);
                return card;
            }

            function loadSchedules(tid, did) {
                if (unsubscribeSchedule) unsubscribeSchedule();
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${tid}/Schedules`), where('dayId', '==', did), orderBy('Time'));
                unsubscribeSchedule = onSnapshot(q, (snap) => {
                    const cont = document.getElementById('schedule-list-container'); cont.innerHTML = '';
                    snap.forEach(doc => cont.appendChild(createTripCard({id: doc.id, ...doc.data()})));
                });
            }

            // --- ÂΩàÁ™óËôïÁêÜ ---
            function openEditScheduleModal(s) {
                editingScheduleId = s.id;
                document.getElementById('add-schedule-modal').style.display = 'flex';
                document.getElementById('form-location').value = s.Location || '';
                document.getElementById('form-time').value = s.Time || '';
                document.getElementById('form-date').value = s.Date || '';
                document.getElementById('form-details').value = s.Ë™™Êòé || '';
                document.getElementById('form-amount').value = s.Amount || 0;
                document.getElementById('form-type').value = s.Type || 'location';
                document.getElementById('modal-delete-btn').style.display = 'block';
            }

            async function loadExpenseSummary() {
                const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
                let total = 0, cats = {};
                snap.forEach(d => {
                    const data = d.data();
                    const twd = (data.Amount || 0) * (data.Rate || 1);
                    total += twd;
                    cats[data.Type] = (cats[data.Type] || 0) + twd;
                });
                document.getElementById('expense-total-amount').textContent = total.toFixed(0);
                document.getElementById('split-expense-modal').style.display = 'flex';
                // ÂúñË°®ÈÇèËºØ...
            }

            async function loadLists() {
                document.getElementById('lists-modal').style.display = 'flex';
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`));
                unsubscribeLists = onSnapshot(q, (snap) => {
                    const cont = document.getElementById('list-content'); cont.innerHTML = '';
                    snap.forEach(d => {
                        const l = d.data();
                        const div = document.createElement('div');
                        div.className = 'p-2 border-b text-sm';
                        div.textContent = l.name;
                        cont.appendChild(div);
                    });
                });
            }

            // --- ÂàùÂßãÂåñ ---
            function initApp() {
                document.addEventListener('DOMContentLoaded', async () => {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    const cred = await signInAnonymously(auth);
                    
                    // Ë£úÂõûÂΩàÁ™óÁöÑ HTML ÁµêÊßã
                    document.getElementById('add-schedule-modal').innerHTML = `
                        <div class="bg-white p-4 rounded-xl w-11/12 max-w-sm">
                            <h3 class="font-bold mb-3">Á∑®ËºØË°åÁ®ã</h3>
                            <input type="text" id="form-location" class="w-full border p-2 mb-2 text-sm" placeholder="Âú∞Èªû">
                            <div class="flex gap-2 mb-2">
                                <input type="date" id="form-date" class="flex-1 border p-1 text-xs">
                                <input type="time" id="form-time" class="flex-1 border p-1 text-xs">
                            </div>
                            <select id="form-type" class="w-full border p-2 mb-2 text-sm">
                                <option value="location">ÊôØÈªû</option><option value="restaurant">È§êÂª≥</option><option value="coffee">ÂíñÂï°Âª≥</option>
                            </select>
                            <textarea id="form-details" class="w-full border p-2 mb-2 text-sm" placeholder="Ë™™Êòé"></textarea>
                            <input type="number" id="form-amount" class="w-full border p-2 mb-4 text-sm" placeholder="ÈáëÈ°ç">
                            <div class="flex justify-between">
                                <button id="modal-delete-btn" class="bg-red-400 text-white px-4 py-2 rounded text-sm hidden">Âà™Èô§</button>
                                <button id="modal-save-btn" class="bg-[#7E92A1] text-white px-4 py-2 rounded text-sm">ÂÑ≤Â≠ò</button>
                                <button onclick="document.getElementById('add-schedule-modal').style.display='none'" class="text-gray-400 px-4 py-2">ÂèñÊ∂à</button>
                            </div>
                        </div>
                    `;

                    document.getElementById('split-expense-modal').innerHTML = `
                        <div class="bg-white p-4 rounded-xl w-11/12 max-w-sm">
                            <h3 class="font-bold mb-2">Ëä±Ë≤ªÁµ±Ë®à</h3>
                            <div class="text-center py-4 bg-gray-50 rounded mb-4">
                                <span class="text-xs text-gray-400">Á∏ΩËä±Ë≤ª TWD$</span>
                                <div id="expense-total-amount" class="text-2xl font-black">0</div>
                            </div>
                            <button onclick="document.getElementById('split-expense-modal').style.display='none'" class="w-full py-2 bg-gray-100 rounded">ÈóúÈñâ</button>
                        </div>
                    `;

                    document.getElementById('lists-modal').innerHTML = `
                        <div class="bg-white p-4 rounded-xl w-11/12 max-w-sm h-[70vh] flex flex-col">
                            <h3 class="font-bold mb-2">Ê∏ÖÂñÆÁÆ°ÁêÜ</h3>
                            <div id="list-content" class="flex-grow overflow-y-auto"></div>
                            <button onclick="document.getElementById('lists-modal').style.display='none'" class="mt-4 py-2 bg-gray-100 rounded">ÈóúÈñâ</button>
                        </div>
                    `;

                    // Á∂ÅÂÆö‰∫ã‰ª∂
                    safeBind('center-add-btn', 'onclick', () => {
                        editingScheduleId = null;
                        document.getElementById('add-schedule-modal').style.display = 'flex';
                        document.getElementById('modal-delete-btn').style.display = 'none';
                    });
                    
                    safeBind('modal-save-btn', 'onclick', async () => {
                        const data = {
                            Location: document.getElementById('form-location').value,
                            Time: document.getElementById('form-time').value,
                            Date: document.getElementById('form-date').value,
                            Ë™™Êòé: document.getElementById('form-details').value,
                            Amount: parseFloat(document.getElementById('form-amount').value) || 0,
                            Type: document.getElementById('form-type').value,
                            Rate: currentTripRate,
                            dayId: currentDayId
                        };
                        const col = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`);
                        if(editingScheduleId) await updateDoc(doc(col, editingScheduleId), data);
                        else await addDoc(col, data);
                        document.getElementById('add-schedule-modal').style.display = 'none';
                    });

                    safeBind('modal-delete-btn', 'onclick', async () => {
                        if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules/${editingScheduleId}`));
                            document.getElementById('add-schedule-modal').style.display = 'none';
                        }
                    });

                    safeBind('split-expense-btn', 'onclick', loadExpenseSummary);
                    safeBind('btn-lists', 'onclick', loadLists);
                    safeBind('weather-info-container', 'onclick', updateWeatherByCurrentLocation);

                    // ËºâÂÖ•Ë°åÁ®ãÂàóË°®
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/Trips`), (snap) => {
                        const sel = document.getElementById('trip-select'); sel.innerHTML = '';
                        snap.forEach(doc => {
                            const data = doc.data();
                            tripData[doc.id] = data;
                            const opt = document.createElement('option'); opt.value = doc.id; opt.textContent = data.name;
                            sel.appendChild(opt);
                        });
                        if(sel.value) {
                            currentTripId = sel.value;
                            loadSchedules(currentTripId, currentDayId);
                            updateHeaderInfo();
                        }
                    });

                    async function updateHeaderInfo() {
                        const t = tripData[currentTripId]; if(!t) return;
                        currentTripRate = await fetchExchangeRate(COUNTRY_CONFIG[t.country]?.currency || 'JPY');
                        document.getElementById('rate-display-label').textContent = `ÂåØÁéá ‚âà ${1/currentTripRate}`;
                        updateWeatherByCurrentLocation();
                    }
                });
            }
            return { initApp };
        })();
        window.App.initApp();
    </script>
</body>
</html>
