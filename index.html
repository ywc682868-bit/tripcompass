<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-touch-icon" href="icon.png">
    <title>Trip Compass</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- ÂÖ®ÂüüË®≠ÂÆö --- */
    html { scroll-snap-type: y mandatory; scroll-padding-top: 180px; scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* --- ÂÆπÂô®Ëàá‰ΩàÂ±Ä --- */
    #app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background-color: white; padding-bottom: 140px; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    #schedule-list-container { padding-top: 180px; padding-bottom: 85vh; position: relative; z-index: 1; }
    #schedule-list-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 600px; background-color: white; z-index: -2; }    
    
    /* --- Ë°åÁ®ãÂç°Áâá --- */
    .trip-card { width: 100%; margin-bottom: 2rem; position: relative; height: 100px; display: flex; z-index: 0; scroll-snap-align: start; scroll-snap-stop: always; scroll-margin-top: 180px; }
    .trip-card::before { content: ''; position: absolute; left: 28px; top: -6px; bottom: -6px; width: 2px; background-color: #9C8B74; z-index: -1; transform: translateX(-50%); }
    .trip-card:first-child::before { top: -60px; }
    .trip-card:last-child::before { bottom: auto; height: 100%; }
    .trip-card-visual-wrapper { position: relative; width: 100%; height: 100%; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); background-color: white; z-index: 10; }

    /* --- Header --- */
    header { position: fixed; top: 0; left: 0; right: 0; width: 100%; max-width: 500px; margin: 0 auto; background-color: #ffffff; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    #header-content-wrapper { padding-top: calc(15px + env(safe-area-inset-top)); padding-bottom: 4px; padding-left: 12px; padding-right: 12px; }
    #trip-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%237E92A1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right center; background-repeat: no-repeat; background-size: 1.25em 1.25em; -webkit-appearance: none; appearance: none; font-weight: 800; color: #4A4B4D; border: none; padding-right: 1.5rem; cursor: pointer; }

    /* --- Footer --- */
    #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem 0.2rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
    .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 18px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }

    /* --- ÊªëÂãïËàá‰∫íÂãï --- */
    .swipe-item-delete-bg { position: absolute; top: 0; bottom: 0; right: 0; width: 140px; display: flex; align-items: center; justify-content: flex-end; z-index: 0; border-radius: 0.75rem; overflow: hidden; }
    .swipe-item-content { position: relative; z-index: 10; background-color: white; transition: transform 0.2s ease-out; width: 100%; display: flex; align-items: stretch; border-radius: 0.75rem; overflow: hidden; }
    .card-right-col { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 8px; width: 95px; flex: 0 0 95px; padding-left: 6px; padding-top: 12px; position: relative; }
    .card-right-col::before { content: ''; position: absolute; left: 0; top: 8%; bottom: 8%; width: 1px; background-color: #C0C0C0; }

    /* --- Modals --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(95, 99, 104, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; color: #5F6368; border-color: #E0E0E0; border-width: 1px; border-radius: 6px; }
    .compact-label { font-size: 0.7rem; color: #7E92A1; font-weight: 700; }
    .shopping-img-box { width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 6px; border: 1px dashed #ccc; display: flex; justify-content: center; align-items: center; cursor: pointer; }

    @media (min-width: 501px) { .swipe-item-delete-bg { display: none !important; } .card-static-actions { display: flex !important; } }
    </style>
</head>

<body>
    <div id="app-container">
        <header>
            <div id="header-content-wrapper">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col flex-grow min-w-0 mr-2">
                        <div class="flex items-center w-full mb-0.5">
                            <button id="settings-btn" class="p-1 mr-0.5 text-[#888888]">üìÖ</button>
                            <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
                        </div>
                        <div class="flex items-center space-x-1 text-[#888888] ml-1 mb-1.5">
                            <span class="font-bold text-xs">üë´</span>
                            <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
                        </div>
                        <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
                        <div id="header-day-date-container">
                            <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
                        </div>
                    </div>
                    <div id="weather-info-container" class="flex flex-col items-end text-[#888888] gap-2 pt-1">
                        <div id="header-weather-icon" class="text-4xl leading-none"></div>
                        <span id="header-weather-temp" class="text-sm font-bold"></span>
                        <span id="header-location-name" class="text-xs font-bold"></span>
                        <span id="header-clothing-advice" class="text-xs font-bold text-[#CB8572] whitespace-nowrap"></span>
                    </div>
                </div>
            </div>
        </header>
        <div id="schedule-list-container" class="px-3">
            <div class="p-4 text-center text-[#A9A9A9] text-xs">Ë°åÁ®ãÂä†Ëºâ‰∏≠...</div>
        </div>
    </div>

    <div id="combined-bottom-bar">
        <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5">
            <div id="rate-display-container" class="flex items-center justify-center border-r border-gray-100 w-1/2">
                <span id="rate-display-label">ÂåØÁéá ‚âà ...</span> 
            </div>
            <div class="flex items-center justify-start gap-0.5 pl-3 w-1/2">
                <select id="bar-calc-currency" class="bg-gray-50 border border-[#E0E0E0] rounded p-0.5 text-[10px] font-bold h-6 w-10 text-center">
                    <option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option>
                </select>
                <input type="number" id="bar-calc-amount" class="w-20 h-6 text-[10px] border border-[#E0E0E0] rounded text-center">
                <span class="text-[1.1rem] font-bold text-[#A9A9A9]">=</span>
                <span class="text-[0.7rem] font-bold text-[#7E92A1]">TWD</span>
                <input type="text" id="bar-calc-result" readonly class="w-12 h-6 border-none bg-transparent text-[#7E92A1] font-extrabold text-left pl-1">
            </div>
        </div>
        <div class="flex justify-between items-center w-full px-2 py-1.5">
             <button id="btn-lists" class="flex-1 flex items-center justify-center gap-2 text-[#888888]">
                 <span class="text-xl">üìù</span><span class="text-[12px] font-bold">Ê∏ÖÂñÆ</span>
             </button>
             <div class="flex-none px-4"><button id="center-add-btn" class="prominent-integrated-btn shadow-md">Ôºã</button></div>
             <button id="split-expense-btn" class="flex-1 flex items-center justify-center gap-2 text-[#888888]">
                 <span class="text-xl">üí∞</span><span class="text-[12px] font-bold">Ëä±Ë≤ª</span>
             </button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto relative"></div></div>
    <div id="lists-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm max-h-[80vh] flex flex-col relative"><h3 class="text-base font-bold mb-2 flex justify-between items-center text-[#4A4B4D]">Ê∏ÖÂñÆ<button id="lists-modal-close-btn" class="text-xl">√ó</button></h3><div id="list-tabs" class="flex gap-1 border-b mb-2 overflow-x-auto no-scrollbar"></div><div id="list-content" class="flex-grow overflow-y-auto"></div></div></div>
    <div id="settings-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>
    <div id="split-expense-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]"></div></div>
    <div id="image-zoom-modal" class="modal-overlay hidden z-[150] bg-black/80"><img id="zoom-img" class="max-w-[95%] max-h-[90%] rounded object-contain"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, addDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.App = (function() {
            const appId = 'my-trip-app';
            const firebaseConfig = { apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28", authDomain: "mytravelplanner-36283.firebaseapp.com", projectId: "mytravelplanner-36283", storageBucket: "mytravelplanner-36283.firebasestorage.app", messagingSenderId: "86504733738", appId: "1:86504733738:web:5167a6a795eb206dfed753" };            
            const COUNTRY_CONFIG = { 'USA': { name: 'ÁæéÂúã', currency: 'USD', lat: 40.71, lon: -74.00, localName: 'NY' }, 'JP': { name: 'Êó•Êú¨', currency: 'JPY', lat: 35.68, lon: 139.76, localName: 'Êù±‰∫¨' }, 'KR': { name: 'ÈüìÂúã', currency: 'KRW', lat: 37.56, lon: 126.97, localName: 'ÏÑúÏö∏' }, 'UK': { name: 'Ëã±Âúã', currency: 'GBP', lat: 51.50, lon: -0.12, localName: 'London' }, 'TW': { name: 'Âè∞ÁÅ£', currency: 'TWD', lat: 25.03, lon: 121.56, localName: 'Âè∞Âåó' } };
            const CATEGORY_COLORS = { 'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, '‰∫§ÈÄö': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' }, 'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' }, 'fee': { bg: 'bg-[#D4A5A5]', hex: '#D4A5A5', text: 'text-[#D4A5A5]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
            const CATEGORY_NAMES = { 'location': 'ÊôØÈªû', 'restaurant': 'È§êÂª≥', 'coffee': 'ÂíñÂï°Âª≥', '‰∫§ÈÄö': '‰∫§ÈÄö', 'shopping': 'Ë≥ºÁâ©', 'accommodation': '‰ΩèÂÆø', 'fee': 'ÊâãÁ∫åË≤ª', 'default': 'Êú™ÂàÜÈ°û' };
            const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];

            let db, auth, currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {};
            let unsubscribeSchedule, unsubscribeTrips, unsubscribeLists, expenseChart, currentTripRate = 1, currentListTabId = null;

            // --- Âü∫Á§éÂ∑•ÂÖ∑ ---
            function formatDateForHeader(date) { return `${String(date.getFullYear()).slice(-2)}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')} ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][date.getDay()]}`; }
            function getDateFromDayId(trip, dayId) { if (!trip?.startDate) return null; const d = new Date(trip.startDate); d.setDate(d.getDate() + (parseInt(dayId.replace('Day ','')) - 1)); return d; }
            function getCardStyle(type) { const c = CATEGORY_COLORS[type] || CATEGORY_COLORS.default; return { color: c.bg, icon: (type==='coffee'?'‚òï':type==='restaurant'?'üçΩÔ∏è':type==='‰∫§ÈÄö'?'üöó':type==='shopping'?'üõçÔ∏è':type==='accommodation'?'üõèÔ∏è':'üìç') }; }
            function formatCurrency(v) { return (v && v !== 0) ? v.toFixed(0) : ''; }
            async function fetchExchangeRate(base) { try { const r = await fetch(`https://open.er-api.com/v6/latest/${base}`); const d = await r.json(); return d.rates.TWD || 1; } catch { return 1; } }

            // --- Header & ÂÄíÊï∏ ---
            function updateHeaderDateWithDDay(d) {
                if (!d) return;
                const today = new Date(); today.setHours(0,0,0,0);
                const trip = tripData[currentTripId];
                let countdown = '';
                if (trip?.startDate) {
                    const diff = Math.floor((today - new Date(trip.startDate)) / 86400000);
                    countdown = `<span class="ml-2 text-[#7E92A1] text-xs font-bold">üõ´ ${diff === 0 ? 'D-0' : (diff > 0 ? `D+${diff+1}` : `D${diff}`)}</span>`;
                }
                const loveDiff = Math.floor((today - new Date('2025-08-01')) / 86400000) + 1;
                const loveHtml = `<span class="ml-2 text-[#D4A5A5] text-xs font-extrabold">‚ù§Ô∏è ${loveDiff}Â§©</span>`;
                document.getElementById('header-day-date-display').innerHTML = `${formatDateForHeader(d)}${countdown}${loveHtml}`;
            }

            async function updateHeaderInfo() {
                const trip = tripData[currentTripId]; if (!trip) return;
                const config = COUNTRY_CONFIG[trip.country] || COUNTRY_CONFIG.TW;
                let lat = config.lat, lon = config.lon, displayName = config.localName;

                if (navigator.geolocation) {
                    try {
                        const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, {timeout:5000}));
                        lat = pos.coords.latitude; lon = pos.coords.longitude;
                        const geo = await (await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-TW`)).json();
                        displayName = geo.address.city || geo.address.town || displayName;
                    } catch {}
                }
                document.getElementById('header-location-name').textContent = displayName;
                currentTripRate = await fetchExchangeRate(config.currency);
                document.getElementById('header-members-list').innerHTML = (trip.members||[]).map((m,i)=>`<span class="${MEMBER_COLORS[i%5]} mr-1">${m}</span>`).join('') || 'Â∞öÊú™Ë®≠ÂÆö';

                try {
                    const weather = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`)).json();
                    const code = weather.current.weather_code;
                    document.getElementById('header-weather-icon').textContent = code > 50 ? 'üåßÔ∏è' : (code > 3 ? '‚òÅÔ∏è' : '‚òÄÔ∏è');
                    document.getElementById('header-weather-temp').textContent = `${weather.current.temperature_2m}¬∞C`;
                } catch {}
            }

            // --- Ë°åÁ®ãÂäüËÉΩ ---
            function createTripCard(s) {
                const style = getCardStyle(s.Type);
                const rate = s.Rate || 1;
                const members = s.members || [];
                const fee = parseFloat(s.Fee) || 0;

                let totalTWD = 0;
                members.forEach(m => {
                    if (m.isPayer && m.amount > 0) totalTWD += (m.amount * (m.method==='card' ? 1 : rate));
                });
                if (totalTWD === 0) totalTWD = (s.Amount || 0) * rate;
                totalTWD += fee;

                const card = document.createElement('div');
                card.className = 'trip-card';
                card.innerHTML = `
                    <div class="trip-card-visual-wrapper">
                        <div class="swipe-item-delete-bg"><button class="bg-[#CB8572] text-white px-4 h-full font-bold">Âà™Èô§</button></div>
                        <div class="swipe-item-content">
                            <div class="${CATEGORY_COLORS[s.Type]?.bg || 'bg-gray-400'} w-14 flex-none flex flex-col items-center justify-start py-3 text-white">
                                <span class="text-[10px] font-bold">${s.Time}</span>
                                <span class="text-2xl my-1">${style.icon}</span>
                                <span class="text-[9px] font-medium">${CATEGORY_NAMES[s.Type] || s.Type}</span>
                            </div>
                            <div class="flex-grow p-2 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-xs font-bold truncate text-[#4A4B4D]">${s.Location}</h3>
                                    <div class="flex gap-1 ml-2">${members.map((m,i)=>`<span class="${MEMBER_COLORS[i%5]} text-[10px] font-bold">${typeof m==='string'?m:m.name}</span>`).join('')}</div>
                                </div>
                                <p class="text-[10px] text-[#888888] line-clamp-3 mt-1">${s.Ë™™Êòé || ''}</p>
                            </div>
                            <div class="card-right-col">
                                <div class="text-[#8F9E8B] font-bold text-[10px]">üí∞ $${totalTWD.toFixed(0)}</div>
                                ${s.MustGo ? '<span class="text-[9px] text-[#CB8572] border border-[#CB8572] px-1 rounded bg-white">ÂøÖÂéª</span>' : ''}
                            </div>
                        </div>
                    </div>`;
                card.onclick = () => openEditScheduleModal(s);
                const content = card.querySelector('.swipe-item-content');
                const delBg = card.querySelector('.swipe-item-delete-bg button');
                delBg.onclick = (e) => { e.stopPropagation(); deleteSchedule(s.id); };
                enableSwipe(content);
                return card;
            }

            function enableSwipe(el) {
                let startX = 0;
                el.addEventListener('touchstart', e => startX = e.touches[0].clientX, {passive:true});
                el.addEventListener('touchmove', e => {
                    const diff = e.touches[0].clientX - startX;
                    if (diff < 0) el.style.transform = `translateX(${Math.max(diff, -140)}px)`;
                    if (diff > 0) el.style.transform = `translateX(0px)`;
                }, {passive:true});
                el.addEventListener('touchend', () => {
                    const current = parseInt(el.style.transform.replace(/[^\d-]/g, '')) || 0;
                    el.style.transform = current < -70 ? 'translateX(-140px)' : 'translateX(0px)';
                });
            }

            function openEditScheduleModal(s) {
                editingScheduleId = s?.id || null;
                const trip = tripData[currentTripId];
                const modal = document.getElementById('add-schedule-modal');
                modal.querySelector('div').innerHTML = `
                    <h3 class="text-base font-bold mb-2 text-[#4A4B4D]">${s?.Location || 'Êñ∞Â¢ûË°åÁ®ã'}</h3>
                    <button id="modal-close-btn" class="absolute top-3 right-3 text-2xl text-gray-400">√ó</button>
                    <form id="add-schedule-form" class="space-y-2">
                        <div class="grid grid-cols-3 gap-1.5">
                            <div><label class="compact-label block text-center">Êó•Êúü</label><input type="date" id="form-date" class="compact-input w-full"></div>
                            <div><label class="compact-label block text-center">ÊôÇÈñì</label><input type="time" id="form-time" class="compact-input w-full"></div>
                            <div><label class="compact-label block text-center">È°ûÂûã</label>
                                <select id="form-type" class="compact-input w-full">
                                    <option value="location">ÊôØÈªû</option><option value="restaurant">È§êÂª≥</option><option value="coffee">ÂíñÂï°</option>
                                    <option value="accommodation">‰ΩèÂÆø</option><option value="‰∫§ÈÄö">‰∫§ÈÄö</option><option value="shopping">Ë≥ºÁâ©</option>
                                </select>
                            </div>
                        </div>
                        <div><label class="compact-label">Âú∞Èªû</label><input type="text" id="form-location" class="compact-input w-full" placeholder="Âú∞ÈªûÂêçÁ®±"></div>
                        <div><label class="compact-label">Âú∞ÂùÄ</label><input type="text" id="form-address" class="compact-input w-full" placeholder="Âú∞ÂùÄÊàñÂú∞ÂúñÈÄ£Áµê"></div>
                        <div><textarea id="form-details" rows="3" class="compact-input w-full h-auto p-1" placeholder="ÂÇôË®ª..."></textarea></div>
                        
                        <div class="bg-gray-50 p-2 rounded border border-gray-100">
                            <div class="flex items-center justify-between mb-1">
                                <label class="compact-label">ÊàêÂì°ËàáËä±Ë≤ª</label>
                                <div class="flex gap-2">
                                    <div class="flex items-center gap-1"><span class="text-[9px] text-[#CB8572]">ÂøÖÂéª</span><input type="checkbox" id="form-must-go"></div>
                                    <button type="button" id="add-member-btn" class="text-[#7E92A1] font-bold">Ôºã</button>
                                </div>
                            </div>
                            <div id="form-members-container" class="space-y-1 mb-2"></div>
                            
                            <div class="grid grid-cols-3 gap-1.5 border-t border-gray-200 pt-2">
                                <div class="flex flex-col items-center">
                                    <label class="text-[9px] font-bold text-[#7E92A1] mb-0.5">${trip.currency || 'Â§ñÂπ£'}</label>
                                    <input type="number" id="form-amount" class="compact-input w-full text-right h-7">
                                </div>
                                <div class="flex flex-col items-center">
                                    <label class="text-[9px] font-bold text-[#A9A9A9] mb-0.5">TWD</label>
                                    <input type="number" id="form-amount-twd" class="compact-input w-full text-right h-7">
                                </div>
                                <div class="flex flex-col items-center">
                                    <label class="text-[9px] font-bold text-[#D4A5A5] mb-0.5">ÊâãÁ∫åË≤ª</label>
                                    <input type="number" id="form-fee" class="compact-input w-full text-right h-7">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between pt-2">
                            ${s ? '<button type="button" id="modal-delete-btn" class="bg-[#CB8572] text-white px-4 py-1 rounded text-xs">Âà™Èô§</button>' : '<div></div>'}
                            <button type="button" id="modal-save-btn" class="bg-[#7E92A1] text-white px-6 py-1 rounded text-xs font-bold">ÂÑ≤Â≠ò</button>
                        </div>
                    </form>`;

                if (s) {
                    document.getElementById('form-date').value = s.Date;
                    document.getElementById('form-time').value = s.Time;
                    document.getElementById('form-type').value = s.Type;
                    document.getElementById('form-location').value = s.Location;
                    document.getElementById('form-address').value = s.Address || '';
                    document.getElementById('form-details').value = s.Ë™™Êòé || '';
                    document.getElementById('form-must-go').checked = !!s.MustGo;
                    document.getElementById('form-amount').value = s.Amount || '';
                    document.getElementById('form-fee').value = s.Fee || '';
                    document.getElementById('form-amount-twd').value = s.Amount ? (s.Amount * currentTripRate).toFixed(0) : '';
                    (s.members||[]).forEach(m => addMemberInput(m.name, m.amount, m.isPayer, m.method));
                } else {
                    const d = getDateFromDayId(trip, currentDayId);
                    if(d) document.getElementById('form-date').value = d.toISOString().split('T')[0];
                    (trip.members||[]).forEach(m => addMemberInput(m));
                }

                document.getElementById('form-amount').oninput = (e) => {
                    const val = parseFloat(e.target.value);
                    document.getElementById('form-amount-twd').value = isNaN(val) ? '' : (val * currentTripRate).toFixed(0);
                };
                document.getElementById('form-amount-twd').oninput = (e) => {
                    const val = parseFloat(e.target.value);
                    document.getElementById('form-amount').value = isNaN(val) ? '' : (val / currentTripRate).toFixed(2);
                };

                document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');
                document.getElementById('modal-save-btn').onclick = submitSchedule;
                document.getElementById('add-member-btn').onclick = () => addMemberInput();
                if(s) document.getElementById('modal-delete-btn').onclick = () => deleteSchedule(s.id);
                modal.classList.remove('hidden');
            }

            function addMemberInput(name='', amt='', isPayer=false, method='cash') {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-1 border-b border-gray-100 pb-1 mb-1 last:border-0';
                div.innerHTML = `
                    <input type="text" name="m-name" value="${name}" placeholder="Âêç" class="compact-input w-14 font-bold text-[10px]">
                    <input type="number" name="m-amt" value="${amt}" placeholder="ÈáëÈ°ç" class="compact-input flex-grow text-[10px]">
                    <select name="m-method" class="compact-input text-[10px] w-12">
                        <option value="cash" ${method==='cash'?'selected':''}>ÁèæÈáë</option>
                        <option value="card" ${method==='card'?'selected':''}>Âà∑Âç°</option>
                    </select>
                    <label class="flex items-center text-[10px] text-[#7E92A1] ml-1"><input type="checkbox" name="m-payer" ${isPayer?'checked':''} class="mr-0.5">‰ªò</label>
                    <button type="button" class="text-red-300 font-bold px-1 text-lg">√ó</button>`;
                div.querySelector('button').onclick = () => div.remove();
                document.getElementById('form-members-container').appendChild(div);
            }

            // --- Ë≥áÊñôÂêåÊ≠• ---
            async function submitSchedule() {
                const members = [];
                document.querySelectorAll('#form-members-container > div').forEach(row => {
                    const name = row.querySelector('[name="m-name"]').value.trim();
                    if(name) members.push({ name, amount: parseFloat(row.querySelector('[name="m-amt"]').value) || 0, isPayer: row.querySelector('[name="m-payer"]').checked, method: row.querySelector('[name="m-method"]').value });
                });

                const data = {
                    dayId: `Day ${Math.floor((new Date(document.getElementById('form-date').value) - new Date(tripData[currentTripId].startDate))/86400000)+1}`,
                    Date: document.getElementById('form-date').value,
                    Time: document.getElementById('form-time').value,
                    Type: document.getElementById('form-type').value,
                    Location: document.getElementById('form-location').value,
                    Address: document.getElementById('form-address').value,
                    Ë™™Êòé: document.getElementById('form-details').value,
                    MustGo: document.getElementById('form-must-go').checked,
                    Amount: parseFloat(document.getElementById('form-amount').value) || 0,
                    Fee: parseFloat(document.getElementById('form-fee').value) || 0,
                    Rate: currentTripRate, members
                };

                const col = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`);
                if(editingScheduleId) await updateDoc(doc(col, editingScheduleId), data); else await addDoc(col, data);
                document.getElementById('add-schedule-modal').classList.add('hidden');
            }

            async function deleteSchedule(id) { if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`, id)); document.getElementById('add-schedule-modal').classList.add('hidden'); } }

            // --- Á∏ΩÁµêÁÆóÊ†∏ÂøÉ ---
            async function loadExpenseSummary() {
                const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
                let total = 0, types = {}, balances = {}, mems = {};
                
                snap.forEach(d => {
                    const s = d.data();
                    const rate = s.Rate || 1;
                    const fee = parseFloat(s.Fee) || 0;
                    let currentCreditors = [];
                    let schedTotal = 0;

                    const specific = s.members.filter(m => m.isPayer && m.amount > 0);
                    if (specific.length > 0) {
                        specific.forEach(p => {
                            const pAmt = p.amount * (p.method === 'card' ? 1 : rate);
                            schedTotal += pAmt;
                            currentCreditors.push({ name: p.name, lent: pAmt });
                        });
                    } else {
                        schedTotal = (s.Amount || 0) * rate;
                        const checkPayers = s.members.filter(m => m.isPayer);
                        if (checkPayers.length > 0) checkPayers.forEach(p => currentCreditors.push({ name: p.name, lent: schedTotal / checkPayers.length }));
                    }

                    if (fee > 0 && currentCreditors.length > 0) {
                        currentCreditors.forEach(c => c.lent += (fee / currentCreditors.length));
                        schedTotal += fee;
                        types['fee'] = (types['fee'] || 0) + fee;
                    }

                    if (schedTotal <= 0) return;
                    total += schedTotal;
                    types[s.Type] = (types[s.Type] || 0) + (schedTotal - fee);

                    const participants = s.members.filter(m => !(m.amount > 0 && !m.isPayer));
                    if (participants.length > 0) {
                        const per = schedTotal / participants.length;
                        currentCreditors.forEach(c => balances[c.name] = (balances[c.name] || 0) + c.lent);
                        participants.forEach(p => {
                            const n = typeof p === 'string' ? p : p.name;
                            balances[n] = (balances[n] || 0) - per;
                            if(!mems[n]) mems[n] = { total: 0, cats: {} };
                            mems[n].total += per;
                            mems[n].cats[s.Type] = (mems[n].cats[s.Type] || 0) + ((schedTotal-fee)/participants.length);
                            if(fee > 0) mems[n].cats['fee'] = (mems[n].cats['fee'] || 0) + (fee/participants.length);
                        });
                    }
                });

                const modal = document.getElementById('split-expense-modal');
                modal.innerHTML = `
                    <h3 class="text-sm font-bold mb-2 flex justify-between">Ëä±Ë≤ªÁµ±Ë®à<button id="exp-close" class="text-xl">√ó</button></h3>
                    <div class="bg-[#F9F9F9] p-3 rounded border mb-2">
                        <div class="flex justify-between border-b pb-1 mb-2"><span class="text-xs">Á∏ΩËä±Ë≤ª</span><span class="font-extrabold text-sm">TWD $${total.toFixed(0)}</span></div>
                        <div class="h-32 w-full"><canvas id="expense-chart"></canvas></div>
                    </div>
                    <div class="overflow-y-auto flex-grow text-[10px]" id="exp-list"></div>`;
                
                document.getElementById('exp-close').onclick = () => modal.classList.add('hidden');
                modal.classList.remove('hidden');

                const ctx = document.getElementById('expense-chart').getContext('2d');
                if(expenseChart) expenseChart.destroy();
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(types).map(k => CATEGORY_NAMES[k] || k),
                        datasets: [{ data: Object.values(types), backgroundColor: Object.keys(types).map(k => (CATEGORY_COLORS[k]||CATEGORY_COLORS.default).hex), borderWidth: 0 }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                const list = document.getElementById('exp-list');
                Object.keys(mems).forEach(n => {
                    list.innerHTML += `<div class="font-bold border-b py-1 mt-2 text-[#7E92A1]">${n} (ÂÄã‰∫∫Á∏ΩË®à: $${mems[n].total.toFixed(0)})</div>`;
                    Object.keys(mems[n].cats).forEach(c => {
                        list.innerHTML += `<div class="flex justify-between py-0.5 px-2"><span>${CATEGORY_NAMES[c]||c}</span><span>$${mems[n].cats[c].toFixed(0)}</span></div>`;
                    });
                });
            }

            // --- ÂàùÂßãÂåñ ---
            function initApp() {
                document.addEventListener('DOMContentLoaded', async () => {
                    const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                    await signInAnonymously(auth);
                    
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/Trips`), (snap) => {
                        const select = document.getElementById('trip-select'); select.innerHTML = '';
                        snap.forEach(d => {
                            const data = d.data(); tripData[d.id] = {id: d.id, ...data};
                            const opt = document.createElement('option'); opt.value = d.id; opt.textContent = data.name; select.appendChild(opt);
                        });
                        if(!currentTripId && snap.docs[0]) { currentTripId = snap.docs[0].id; switchTrip(currentTripId); }
                    });

                    document.getElementById('settings-btn').onclick = () => alert('Ë®≠ÂÆöÂäüËÉΩ...');
                    document.getElementById('center-add-btn').onclick = () => openEditScheduleModal();
                    document.getElementById('split-expense-btn').onclick = loadExpenseSummary;
                    document.getElementById('trip-select').onchange = (e) => switchTrip(e.target.value);
                });
            }

            async function switchTrip(id) {
                currentTripId = id;
                const trip = tripData[id];
                currentTripRate = await fetchExchangeRate(trip.currency || 'KRW');
                updateHeaderInfo();
                renderDayTabs();
                loadSchedules();
            }

            function renderDayTabs() {
                const cont = document.getElementById('day-tabs-container'); cont.innerHTML = '';
                const trip = tripData[currentTripId];
                for(let i=1; i<=(trip.numDays||1); i++) {
                    const btn = document.createElement('button');
                    const dId = `Day ${i}`;
                    btn.className = `px-3 py-1 text-xs font-bold rounded-lg mr-2 flex-none ${currentDayId===dId ? 'bg-[#5F6368] text-white' : 'bg-gray-100 text-gray-500'}`;
                    btn.textContent = dId;
                    btn.onclick = () => { currentDayId = dId; renderDayTabs(); loadSchedules(); };
                    cont.appendChild(btn);
                }
                const d = getDateFromDayId(trip, currentDayId); if(d) updateHeaderDateWithDDay(d);
            }

            function loadSchedules() {
                if(unsubscribeSchedule) unsubscribeSchedule();
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`), where('dayId', '==', currentDayId), orderBy('Time'));
                unsubscribeSchedule = onSnapshot(q, (snap) => {
                    const cont = document.getElementById('schedule-list-container'); cont.innerHTML = '';
                    snap.forEach(d => cont.appendChild(createTripCard({id: d.id, ...d.data()})));
                    if(snap.empty) cont.innerHTML = '<div class="p-8 text-center text-gray-300">Êú¨Êó•ÁÑ°Ë°åÁ®ã</div>';
                });
            }

            return { initApp };
        })();
        window.App.initApp();
    </script>
</body>
</html>
