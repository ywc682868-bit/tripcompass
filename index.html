<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-touch-icon" href="icon.png">
    <title>Trip Compass</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    html { scroll-snap-type: y mandatory; scroll-padding-top: 180px; scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* --- å®¹å™¨èˆ‡ä½ˆå±€ --- */
    #app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background-color: white; padding-bottom: 140px; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    #schedule-list-container { padding-top: 180px; padding-bottom: 85vh; position: relative; z-index: 1; }
    
    /* --- è¡Œç¨‹å¡ç‰‡ --- */
    .trip-card { width: 100%; margin-bottom: 2rem; position: relative; height: 100px; display: flex; z-index: 0; scroll-snap-align: start; scroll-snap-stop: always; scroll-margin-top: 180px; }
    .trip-card::before { content: ''; position: absolute; left: 28px; top: -6px; bottom: -6px; width: 2px; background-color: #9C8B74; z-index: -1; transform: translateX(-50%); }
    .trip-card:first-child::before { top: -60px; height: auto; }
    .trip-card-visual-wrapper { position: relative; width: 100%; height: 100%; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); background-color: white; z-index: 10; }

    /* --- å›ºå®š Header --- */
    header { position: fixed; top: 0; left: 0; right: 0; width: 100%; max-width: 500px; margin: 0 auto; background-color: #ffffff; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    #header-content-wrapper { padding-top: calc(15px + env(safe-area-inset-top)); padding-bottom: 4px; padding-left: 12px; padding-right: 12px; }
    #trip-select { -webkit-appearance: none; appearance: none; background-color: transparent; font-weight: 800; color: #4A4B4D; border: none; cursor: pointer; }

    /* --- Footer --- */
    #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
    .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }

    /* --- æ»‘å‹•åˆªé™¤ --- */
    .swipe-item-delete-bg { position: absolute; top: 0; bottom: 0; right: 0; width: 140px; display: flex; align-items: center; justify-content: flex-end; z-index: 0; border-radius: 0.75rem; overflow: hidden; }
    .swipe-item-content { position: relative; z-index: 10; background-color: white; transition: transform 0.2s ease-out; width: 100%; display: flex; align-items: stretch; border-radius: 0.75rem; overflow: hidden; }

    .card-right-col { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 8px; width: 95px; flex: 0 0 95px; padding-left: 6px; padding-top: 12px; position: relative; }
    .card-right-col::before { content: ''; position: absolute; left: 0; top: 8%; bottom: 8%; width: 1px; background-color: #C0C0C0; }

    /* --- Modals --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(95, 99, 104, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; color: #5F6368; border-color: #E0E0E0; border-width: 1px; border-radius: 0.375rem; }
    .compact-label { font-size: 0.7rem; color: #7E92A1; font-weight: 700; }
    </style>
</head>

<body>
    <div id="app-container">
        <header>
            <div id="header-content-wrapper">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col flex-grow min-w-0 mr-2">
                        <div class="flex items-center w-full mb-0.5">
                            <button id="settings-btn" class="p-1 mr-0.5 text-[#888888]">ğŸ“…</button>
                            <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
                        </div>
                        <div class="flex items-center space-x-1 text-[#888888] ml-1 mb-1.5">
                            <span class="font-bold text-xs">ğŸ‘«</span>
                            <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
                        </div>
                        <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
                        <div id="header-day-date-container">
                            <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
                        </div>
                    </div>
                    <div id="weather-info-container" class="flex flex-col items-end text-[#888888] gap-2 pt-1">
                        <div id="header-weather-icon" class="text-4xl leading-none"></div>
                        <span id="header-weather-temp" class="text-sm font-bold"></span>
                        <span id="header-location-name" class="text-xs font-bold"></span>
                    </div>
                </div>
            </div>
        </header>
        <div id="schedule-list-container" class="px-3">
            <div class="p-4 text-center text-[#A9A9A9] text-xs">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div id="combined-bottom-bar">
        <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5">
            <div id="rate-display-container" class="flex items-center justify-center w-1/2 border-r border-gray-100">
                <span id="rate-display-label">åŒ¯ç‡ â‰ˆ ...</span> 
            </div>
            <div class="flex items-center justify-start gap-0.5 pl-3 w-1/2">
                <select id="bar-calc-currency" class="bg-gray-50 border border-[#E0E0E0] rounded text-[10px] font-bold h-6 w-10 text-center">
                    <option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option>
                </select>
                <input type="number" id="bar-calc-amount" class="w-20 h-6 text-[10px] border border-[#E0E0E0] rounded text-center">
                <span class="font-bold text-[#A9A9A9]">=</span>
                <input type="text" id="bar-calc-result" readonly class="w-12 h-6 border-none bg-transparent text-[#7E92A1] font-extrabold text-left pl-1">
            </div>
        </div>
        <div class="flex justify-between items-center w-full px-2 py-1.5">
             <button id="btn-lists" class="flex-1 flex items-center justify-center gap-2 text-[#888888]">
                 <span class="text-xl">ğŸ“</span><span class="text-[12px] font-bold">æ¸…å–®</span>
             </button>
             <div class="flex-none px-4"><button id="center-add-btn" class="prominent-integrated-btn shadow-md">ï¼‹</button></div>
             <button id="split-expense-btn" class="flex-1 flex items-center justify-center gap-2 text-[#888888]">
                 <span class="text-xl">ğŸ’°</span><span class="text-[12px] font-bold">èŠ±è²»</span>
             </button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto relative"></div></div>
    <div id="lists-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm max-h-[80vh] flex flex-col relative"><h3 class="text-base font-bold mb-2 text-[#4A4B4D] flex justify-between">æ¸…å–®<button id="lists-modal-close-btn">Ã—</button></h3><div id="list-tabs" class="flex gap-1 border-b mb-2 overflow-x-auto no-scrollbar"></div><div id="list-content" class="flex-grow overflow-y-auto"></div></div></div>
    <div id="settings-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>
    <div id="split-expense-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, addDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.App = (function() {
            const appId = 'my-trip-app';
            const firebaseConfig = { apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28", authDomain: "mytravelplanner-36283.firebaseapp.com", projectId: "mytravelplanner-36283", storageBucket: "mytravelplanner-36283.firebasestorage.app", messagingSenderId: "86504733738", appId: "1:86504733738:web:5167a6a795eb206dfed753" };            
            const COUNTRY_CONFIG = { 'KR': { name: 'éŸ“åœ‹', currency: 'KRW', lat: 37.56, lon: 126.97, localName: 'ì„œìš¸' }, 'TW': { name: 'å°ç£', currency: 'TWD', lat: 25.03, lon: 121.56, localName: 'å°åŒ—' } };
            const CATEGORY_COLORS = { 'fee': { bg: 'bg-[#D4A5A5]', hex: '#D4A5A5', text: 'text-[#D4A5A5]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
            const CATEGORY_NAMES = { 'location': 'æ™¯é»', 'restaurant': 'é¤å»³', 'coffee': 'å’–å•¡å»³', 'äº¤é€š': 'äº¤é€š', 'shopping': 'è³¼ç‰©', 'accommodation': 'ä½å®¿', 'fee': 'æ‰‹çºŒè²»', 'default': 'æœªåˆ†é¡' };
            const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]'];

            let db, auth, currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {}, currentTripRate = 1;
            let unsubscribeSchedule, unsubscribeTrips, expenseChart;

            // --- å·¥å…·å‡½æ•¸ ---
            function formatDate(d) { return `${String(d.getFullYear()).slice(-2)}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]}`; }
            function getCardStyle(t) { const c = CATEGORY_COLORS[t] || CATEGORY_COLORS.default; return { color: c.bg, icon: 'ğŸ“', hex: c.hex }; }
            function formatCurrency(v) { return (v && v !== 0) ? v.toFixed(0) : ''; }
            async function fetchRate(base) { try { const r = await fetch(`https://open.er-api.com/v6/latest/${base}`); const d = await r.json(); return d.rates.TWD || 1; } catch { return 1; } }

            // --- æ ¸å¿ƒé‚è¼¯ ---
            function openEditScheduleModal(s) {
                editingScheduleId = s ? s.id : null;
                const modal = document.getElementById('add-schedule-modal');
                const content = modal.querySelector('div');
                const isNew = !s;
                const trip = tripData[currentTripId];

                content.innerHTML = `
                    <h3 class="text-base font-bold mb-2 text-[#4A4B4D]">${isNew ? 'æ–°å¢è¡Œç¨‹' : (s.Location || 'ç·¨è¼¯è¡Œç¨‹')}</h3>
                    <button id="modal-close-btn" class="absolute top-3 right-3 text-2xl">Ã—</button>
                    <form id="add-schedule-form" class="space-y-2">
                        <div class="grid grid-cols-3 gap-1.5">
                            <div><label class="compact-label block text-center">æ—¥æœŸ</label><input type="date" id="form-date" class="compact-input w-full"></div>
                            <div><label class="compact-label block text-center">æ™‚é–“</label><input type="time" id="form-time" class="compact-input w-full"></div>
                            <div><label class="compact-label block text-center">é¡å‹</label><select id="form-type" class="compact-input w-full"><option value="location">ğŸ“ æ™¯é»</option><option value="restaurant">ğŸ½ï¸ é¤å»³</option></select></div>
                        </div>
                        <div><label class="compact-label">åœ°é»</label><input type="text" id="form-location" class="compact-input w-full" placeholder="åœ°é»åç¨±"></div>
                        <div class="bg-gray-50 p-2 rounded border">
                            <div class="flex justify-between items-center mb-1"><label class="compact-label">æˆå“¡èˆ‡èŠ±è²»</label><button type="button" id="add-member-btn" class="text-[#7E92A1] font-bold">ï¼‹</button></div>
                            <div id="form-members-container" class="space-y-1 mb-2"></div>
                            <div class="grid grid-cols-3 gap-1.5 border-t pt-2">
                                <div class="flex flex-col items-center"><label class="text-[9px] font-bold text-[#7E92A1]">${trip.currency || 'å¤–å¹£'}</label><input type="number" id="form-amount" class="compact-input w-full text-right h-7"></div>
                                <div class="flex flex-col items-center"><label class="text-[9px] font-bold text-[#A9A9A9]">TWD</label><input type="number" id="form-amount-twd" class="compact-input w-full text-right h-7"></div>
                                <div class="flex flex-col items-center"><label class="text-[9px] font-bold text-[#D4A5A5]">æ‰‹çºŒè²»</label><input type="number" id="form-fee" class="compact-input w-full text-right h-7"></div>
                            </div>
                        </div>
                        <div class="flex justify-between pt-2">
                            ${!isNew ? `<button type="button" id="modal-delete-btn" class="bg-[#CB8572] text-white px-3 py-1 rounded text-xs">åˆªé™¤</button>` : '<div></div>'}
                            <button type="button" id="modal-save-btn" class="bg-[#7E92A1] text-white px-4 py-1 rounded text-xs font-bold">å„²å­˜</button>
                        </div>
                    </form>`;

                if(!isNew) {
                    document.getElementById('form-date').value = s.Date;
                    document.getElementById('form-time').value = s.Time;
                    document.getElementById('form-location').value = s.Location;
                    document.getElementById('form-amount').value = s.Amount || '';
                    document.getElementById('form-amount-twd').value = s.Amount ? (s.Amount * currentTripRate).toFixed(0) : '';
                    document.getElementById('form-fee').value = s.Fee || '';
                    (s.members || []).forEach(m => addMemberInput(m.name, m.amount, m.isPayer, m.method));
                } else {
                    const d = new Date(trip.startDate); d.setDate(d.getDate() + parseInt(currentDayId.replace('Day ','')) - 1);
                    document.getElementById('form-date').value = d.toISOString().split('T')[0];
                    (trip.members || []).forEach(m => addMemberInput(m));
                }

                document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');
                document.getElementById('modal-save-btn').onclick = submitSchedule;
                if(!isNew) document.getElementById('modal-delete-btn').onclick = () => deleteSchedule(s.id);
                document.getElementById('add-member-btn').onclick = () => addMemberInput();
                
                // é‡‘é¡é€£å‹•
                document.getElementById('form-amount').oninput = (e) => document.getElementById('form-amount-twd').value = e.target.value ? (e.target.value * currentTripRate).toFixed(0) : '';
                document.getElementById('form-amount-twd').oninput = (e) => document.getElementById('form-amount').value = e.target.value ? (e.target.value / currentTripRate).toFixed(2) : '';

                modal.classList.remove('hidden');
            }

            function addMemberInput(name='', amt='', isPayer=false, method='cash') {
                const container = document.getElementById('form-members-container');
                const div = document.createElement('div');
                div.className = 'flex items-center gap-1 border-b pb-1 mb-1 last:border-0';
                div.innerHTML = `
                    <input type="text" name="m-name" value="${name}" placeholder="å" class="compact-input w-14 font-bold text-[10px]">
                    <input type="number" name="m-amt" value="${amt}" placeholder="é¡" class="compact-input flex-grow text-[10px]">
                    <select name="m-method" class="compact-input text-[10px] w-12"><option value="cash">ç¾é‡‘</option><option value="card" ${method==='card'?'selected':''}>åˆ·å¡</option></select>
                    <label class="flex items-center text-[10px] text-[#7E92A1]"><input type="checkbox" name="m-payer" ${isPayer?'checked':''} class="mr-0.5">ä»˜</label>
                    <button type="button" class="text-red-300 px-1 font-bold">Ã—</button>`;
                div.querySelector('button').onclick = () => div.remove();
                container.appendChild(div);
            }

            async function submitSchedule() {
                const form = document.getElementById('add-schedule-form');
                const members = [];
                document.querySelectorAll('#form-members-container > div').forEach(row => {
                    const name = row.querySelector('[name="m-name"]').value;
                    if(name) members.push({ name, amount: parseFloat(row.querySelector('[name="m-amt"]').value) || 0, isPayer: row.querySelector('[name="m-payer"]').checked, method: row.querySelector('[name="m-method"]').value });
                });

                const data = {
                    Date: document.getElementById('form-date').value,
                    Time: document.getElementById('form-time').value,
                    Location: document.getElementById('form-location').value,
                    Amount: parseFloat(document.getElementById('form-amount').value) || 0,
                    Fee: parseFloat(document.getElementById('form-fee').value) || 0,
                    members, dayId: currentDayId, Rate: currentTripRate
                };

                const col = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`);
                editingScheduleId ? await updateDoc(doc(col, editingScheduleId), data) : await addDoc(col, data);
                document.getElementById('add-schedule-modal').classList.add('hidden');
            }

            async function deleteSchedule(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`, id)); document.getElementById('add-schedule-modal').classList.add('hidden'); } }

            // --- åˆå§‹åŒ– ---
            function initApp() {
                document.addEventListener('DOMContentLoaded', async () => {
                    const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                    await signInAnonymously(auth);
                    
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/Trips`), (snap) => {
                        const select = document.getElementById('trip-select'); select.innerHTML = '';
                        snap.forEach(d => {
                            const data = d.data(); tripData[d.id] = {id: d.id, ...data};
                            const opt = document.createElement('option'); opt.value = d.id; opt.textContent = data.name; select.appendChild(opt);
                        });
                        if(!currentTripId && snap.docs[0]) { currentTripId = snap.docs[0].id; switchTrip(currentTripId); }
                    });

                    document.getElementById('center-add-btn').onclick = () => openEditScheduleModal();
                    document.getElementById('trip-select').onchange = (e) => switchTrip(e.target.value);
                });
            }

            async function switchTrip(id) {
                currentTripId = id;
                currentTripRate = await fetchRate(tripData[id].currency || 'KRW');
                document.getElementById('rate-display-label').textContent = `åŒ¯ç‡ â‰ˆ ${tripData[id].currency} ${ (1/currentTripRate).toFixed(2) }`;
                loadSchedules();
            }

            function loadSchedules() {
                if(unsubscribeSchedule) unsubscribeSchedule();
                const q = query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`), where('dayId', '==', currentDayId), orderBy('Time'));
                unsubscribeSchedule = onSnapshot(q, (snap) => {
                    const cont = document.getElementById('schedule-list-container'); cont.innerHTML = '';
                    snap.forEach(d => cont.appendChild(createTripCard({id: d.id, ...d.data()})));
                });
            }

            function createTripCard(s) {
                const div = document.createElement('div');
                div.className = 'trip-card';
                div.innerHTML = `<div class="trip-card-visual-wrapper p-3 flex justify-between items-center w-full">
                    <div><div class="text-xs font-bold">${s.Time}</div><div class="text-sm font-extrabold">${s.Location}</div></div>
                    <div class="text-right"><div class="text-[10px] text-[#8F9E8B]">TWD $${( (s.Amount*currentTripRate) + (s.Fee||0) ).toFixed(0)}</div></div>
                </div>`;
                div.onclick = () => openEditScheduleModal(s);
                return div;
            }

            return { initApp };
        })();
        window.App.initApp();
    </script>
</body>
</html>
